<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>PrintMaster Server</title>
    <script>window.__pm_shared = window.__pm_shared || {};</script>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='16' y='8' width='32' height='12' fill='%234a5568' rx='2'/><rect x='12' y='20' width='40' height='24' fill='%23718096' rx='3'/><rect x='16' y='24' width='32' height='16' fill='%23cbd5e0' rx='2'/><rect x='20' y='28' width='8' height='2' fill='%234299e1'/><rect x='20' y='32' width='12' height='2' fill='%234299e1'/><rect x='20' y='36' width='10' height='2' fill='%234299e1'/><circle cx='46' cy='32' r='3' fill='%2348bb78'/><rect x='16' y='44' width='32' height='12' fill='%234a5568' rx='2'/><rect x='20' y='48' width='24' height='4' fill='%23e2e8f0'/></svg>">
    <!-- flatpickr is injected centrally from common/web/shared.js -->
    <link rel="stylesheet" href="/static/shared.css{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}">
    <link rel="stylesheet" href="/static/style.css{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}">
    <script src="/static/shared.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/cards.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/metrics.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
</head>

<body>
    <div class="header-flex"
        style="display: flex; align-items: center; margin-bottom: 12px; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <h1 style="margin: 0;">PrintMaster Server</h1>
            <div id="server_status" style="font-size:14px;color:var(--muted);">Loading...</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <button id="join_token_btn" title="Add an agent" class="modal-button modal-button-primary" style="display:none;">Add Agent</button>
            <label class="theme-toggle">
                <input type="checkbox" id="theme-toggle-checkbox">
                <div class="theme-toggle-slider">
                    <div class="theme-toggle-icon"></div>
                </div>
            </label>
            <button id="logout_btn" style="display:none;" title="Log out" class="modal-button">Log out</button>
        </div>
    </div>

    <!-- Main content container with floating appearance -->
    <div class="content-container">
        <div class="tabbar">
            <!-- Hamburger menu for mobile -->
            <div class="hamburger-menu">
                <div class="hamburger-header">
                    <span id="current_tab_label">Menu - Agents</span>
                    <div class="hamburger-icon">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            </div>
            <div class="mobile-nav" id="mobile_nav">
                <button class="tab active" data-target="agents">Agents</button>
                <button class="tab" data-target="devices">Devices</button>
                <button class="tab" data-target="metrics">Metrics</button>
                <button class="tab" data-target="logs">Logs</button>
            </div>
            <!-- Desktop tabs -->
            <div class="desktop-tabs" id="desktop_tabs">
                <button class="tab active" data-target="agents">Agents</button>
                <button class="tab" data-target="devices">Devices</button>
                <button class="tab" data-target="metrics">Metrics</button>
                <button class="tab" data-target="logs">Logs</button>
            </div>
        </div>

        <!-- Agents Tab -->
        <div style="margin-top:12px;" data-tab="agents">
            <div class="metrics-header agents-header">
                <div>
                    <h3 style="margin-bottom:4px;">Fleet Agents</h3>
                    <div class="muted-text">Track connectivity, versions, and last-seen activity across every deployment.</div>
                </div>
                <div class="view-toggle" id="agents_view_toggle" role="group" aria-label="Agents view">
                    <button class="ghost-btn active" data-view="cards">Card View</button>
                    <button class="ghost-btn" data-view="table">Table View</button>
                </div>
            </div>

            <div id="agents_overview_metrics" class="metrics-overview-grid compact" style="margin-bottom:16px;">
                <div class="metric-card loading">Loading agent metrics…</div>
            </div>

            <div class="agents-toolbar">
                <div class="agents-toolbar-left">
                    <label class="field">
                        <span>Search</span>
                        <input type="text" id="agents_search" placeholder="Search name, hostname, ID…" />
                    </label>
                    <label class="field">
                        <span>Version</span>
                        <select id="agents_version_filter">
                            <option value="">All Versions</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Platform</span>
                        <select id="agents_platform_filter">
                            <option value="">All Platforms</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Tenant</span>
                        <select id="agents_tenant_filter">
                            <option value="">All Tenants</option>
                        </select>
                    </label>
                    <label class="field sort-field">
                        <span>Sort</span>
                        <div class="sort-select">
                            <select id="agents_sort_select">
                                <option value="last_seen">Last Seen</option>
                                <option value="name">Agent Name</option>
                                <option value="status">Status</option>
                                <option value="connection">Connection</option>
                                <option value="version">Version</option>
                                <option value="tenant">Tenant</option>
                            </select>
                            <button id="agents_sort_dir_btn" class="ghost-btn" title="Toggle sort direction" aria-label="Toggle sort direction">
                                <span id="agents_sort_dir_icon">↓</span>
                            </button>
                        </div>
                    </label>
                </div>
                <div class="agents-toolbar-actions">
                    <label class="field inline-check" title="Automatically check for agent updates when loading this page">
                        <input type="checkbox" id="agents_check_updates_toggle" checked />
                        <span>Auto-check updates</span>
                    </label>
                    <button id="agents_check_updates_btn" class="ghost-btn">Check for Updates</button>
                    <button id="agents_reset_filters" class="ghost-btn">Reset Filters</button>
                </div>
            </div>

            <div class="agents-quick-filters">
                <div class="filter-block">
                    <div class="filter-label">Status</div>
                    <div id="agents_status_filter" class="pill-toggle-group" role="group" aria-label="Status filters">
                        <button class="pill active" data-status="active" data-label="Active">Active</button>
                        <button class="pill active" data-status="inactive" data-label="Inactive">Inactive</button>
                        <button class="pill active" data-status="offline" data-label="Offline">Offline</button>
                    </div>
                </div>
                <div class="filter-block">
                    <div class="filter-label">Connection</div>
                    <div id="agents_connection_filter" class="pill-toggle-group" role="group" aria-label="Connection filters">
                        <button class="pill active" data-connection="ws" data-label="Live WS">Live WS</button>
                        <button class="pill active" data-connection="http" data-label="HTTP Fallback">HTTP Fallback</button>
                        <button class="pill active" data-connection="none" data-label="Offline">Offline</button>
                    </div>
                </div>
            </div>

            <div id="agents_active_filters" class="filter-chip-row"></div>

            <div id="agents_stats" class="agents-inline-stats"></div>

            <div class="device-cards-container" id="agents_cards"></div>
            <div id="agents_table_wrapper" class="hidden">
                <div class="table-wrapper">
                    <table class="simple-table" id="agents_table">
                        <thead>
                            <tr>
                                <th data-sort-key="name">Agent</th>
                                <th data-sort-key="tenant">Tenant</th>
                                <th data-sort-key="status">Status</th>
                                <th data-sort-key="connection">Connection</th>
                                <th data-sort-key="platform">Platform</th>
                                <th data-sort-key="version">Version</th>
                                <th data-sort-key="last_seen">Last Seen</th>
                                <th class="actions-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="muted-text">Loading agents…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Devices Tab -->
        <div style="margin-top:12px;" data-tab="devices" class="hidden">
            <div class="metrics-header devices-header">
                <div>
                    <h3 style="margin-bottom:4px;">Fleet Devices</h3>
                    <div class="muted-text">Monitor connectivity, alerts, and consumables across every agent.</div>
                </div>
                <div class="view-toggle" id="devices_view_toggle" role="group" aria-label="Devices view">
                    <button class="ghost-btn active" data-view="cards">Card View</button>
                    <button class="ghost-btn" data-view="table">Table View</button>
                </div>
            </div>

            <div id="devices_overview_metrics" class="metrics-overview-grid compact" style="margin-bottom:16px;">
                <div class="metric-card loading">Loading fleet metrics…</div>
            </div>

            <div class="devices-toolbar">
                <div class="devices-toolbar-left">
                    <label class="field">
                        <span>Search</span>
                        <input type="text" id="devices_search" placeholder="Search serial, IP, model…" />
                    </label>
                    <label class="field">
                        <span>Agent</span>
                        <select id="devices_agent_filter">
                            <option value="">All Agents</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Tenant</span>
                        <select id="devices_tenant_filter">
                            <option value="">All Tenants</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Manufacturer</span>
                        <select id="devices_manufacturer_filter">
                            <option value="">All Manufacturers</option>
                        </select>
                    </label>
                    <label class="field sort-field">
                        <span>Sort</span>
                        <div class="sort-select">
                            <select id="devices_sort_select">
                                <option value="last_seen">Last Seen</option>
                                <option value="manufacturer">Manufacturer</option>
                                <option value="agent">Agent</option>
                                <option value="tenant">Tenant</option>
                                <option value="status">Status</option>
                                <option value="ip">Network</option>
                                <option value="location">Location</option>
                            </select>
                            <button id="devices_sort_dir_btn" class="ghost-btn" title="Toggle sort direction" aria-label="Toggle sort direction">
                                <span id="devices_sort_dir_icon">↓</span>
                            </button>
                        </div>
                    </label>
                </div>
                <div class="devices-toolbar-actions">
                    <button id="devices_reset_filters" class="ghost-btn">Reset Filters</button>
                </div>
            </div>

            <div class="devices-quick-filters">
                <div class="filter-block">
                    <div class="filter-label">Status</div>
                    <div id="devices_status_filter" class="pill-toggle-group" role="group" aria-label="Status filters">
                        <button class="pill active" data-status="healthy" data-label="Healthy">Healthy</button>
                        <button class="pill active" data-status="warning" data-label="Warning">Warning</button>
                        <button class="pill active" data-status="error" data-label="Error">Error</button>
                        <button class="pill active" data-status="jam" data-label="Jam">Jam</button>
                    </div>
                </div>
                <div class="filter-block">
                    <div class="filter-label">Consumables</div>
                    <div id="devices_consumable_filter" class="pill-toggle-group" role="group" aria-label="Consumable filters">
                        <button class="pill active" data-band="critical" data-label="Critical">Critical</button>
                        <button class="pill active" data-band="low" data-label="Low">Low</button>
                        <button class="pill active" data-band="medium" data-label="Medium">Medium</button>
                        <button class="pill active" data-band="high" data-label="High">High</button>
                        <button class="pill active" data-band="unknown" data-label="Unknown">Unknown</button>
                    </div>
                </div>
            </div>

            <div id="devices_active_filters" class="filter-chip-row"></div>

            <div id="devices_stats" class="devices-inline-stats"></div>

            <div class="device-cards-container" id="devices_cards"></div>
            <div id="devices_table_wrapper" class="hidden">
                <div class="table-wrapper">
                    <table class="simple-table" id="devices_table">
                        <thead>
                            <tr>
                                <th data-sort-key="manufacturer">Device</th>
                                <th data-sort-key="status">Status</th>
                                <th data-sort-key="agent">Agent</th>
                                <th data-sort-key="tenant">Tenant</th>
                                <th data-sort-key="ip">Network</th>
                                <th data-sort-key="location">Location</th>
                                <th data-sort-key="last_seen">Last Seen</th>
                                <th class="actions-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="muted-text">Loading devices…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Metrics Tab -->
        <div style="margin-top:12px;" data-tab="metrics" class="hidden">
            <div class="metrics-header">
                <div>
                    <h3 style="margin-bottom:4px;">Fleet Metrics</h3>
                    <div class="muted-text">Netdata-style view of fleet throughput, health, and server stats.</div>
                </div>
                <div class="metrics-range-controls" id="metrics_range_controls">
                    <button class="ghost-btn" data-range="24h">24h</button>
                    <button class="ghost-btn" data-range="7d">7d</button>
                    <button class="ghost-btn" data-range="30d">30d</button>
                    <button class="ghost-btn" data-range="90d">90d</button>
                    <button class="ghost-btn" data-range="365d">1y</button>
                </div>
            </div>

            <div id="metrics_stats" class="metrics-overview-grid">
                <div class="metric-card loading">Loading fleet overview…</div>
            </div>

            <div class="metrics-layout">
                <div class="metrics-charts" id="metrics_chart_grid">
                    <div class="metric-chart-card loading">Preparing charts…</div>
                </div>
                <div class="metrics-side-panel" id="metrics_server_panel">
                    <div class="metric-card loading">Loading server stats…</div>
                </div>
            </div>

            <div id="metrics_consumables" class="metric-card" style="margin-top:12px;">
                <div class="card-title">Consumables</div>
                <div class="muted-text">Loading consumable data…</div>
            </div>

            <div id="metrics_activity" class="metric-card" style="margin-top:12px;">
                <div class="card-title">Activity Log</div>
                <div class="muted-text">Waiting for data…</div>
            </div>
        </div>

        <!-- Admin Tab (rendered dynamically) - consolidates Users, Access, Tenants, Fleet, Server, Audit -->
        <template id="tab-template-admin">
            <div style="margin-top:12px;" data-tab="admin" class="hidden">
                <h3>Administration</h3>

                <div class="subtab-bar" id="admin_subtab_bar">
                    <button class="subtab admin-subtab active" data-adminview="users">Users</button>
                    <button class="subtab admin-subtab" data-adminview="access">Access</button>
                    <button class="subtab admin-subtab" data-adminview="tenants">Tenants</button>
                    <button class="subtab admin-subtab" data-adminview="fleet">Fleet</button>
                    <button class="subtab admin-subtab" data-adminview="server">Server</button>
                    <button class="subtab admin-subtab" data-adminview="audit">Audit</button>
                </div>

                <!-- Users Sub-tab -->
                <div class="admin-view-panel" data-adminview-panel="users">
                    <div class="users-header">
                        <div>
                            <p class="users-subtitle">Manage local users and permissions</p>
                        </div>
                        <div class="users-header-actions">
                            <button id="invite_user_btn" class="btn-outline" title="Invite user via email">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>
                                Invite
                            </button>
                            <button id="new_user_btn" class="btn-primary">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                New User
                            </button>
                        </div>
                    </div>
                    <div id="users_list">
                        <div class="users-loading">Loading users...</div>
                    </div>
                </div>

                <!-- Access Sub-tab (SSO, Roles, Sessions) -->
                <div class="admin-view-panel hidden" data-adminview-panel="access">
                    <div class="access-sections">
                        <!-- SSO Providers Section -->
                        <div class="panel">
                            <h4 style="margin-top:0;color:var(--highlight)">Single Sign-On (OIDC)</h4>
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="color:var(--muted);font-size:13px;max-width:520px;">
                                    Connect identity providers for the hosted login page. Providers can be tenant-specific or global.
                                </div>
                                <div>
                                    <button id="sso_add_provider_btn">Add Provider</button>
                                </div>
                            </div>
                            <div id="sso_providers_list" class="card" style="padding:12px;overflow:auto;">
                                <div class="muted-text">Loading identity providers…</div>
                            </div>
                        </div>

                        <!-- Roles Reference Section -->
                        <div class="panel" style="margin-top:16px;">
                            <h4 style="margin-top:0;color:var(--highlight)">Roles & Permissions</h4>
                            <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">
                                Reference for built-in role permissions. Custom roles coming soon.
                            </div>
                            <div id="roles_matrix" class="card" style="padding:12px;overflow:auto;">
                                <table class="roles-table">
                                    <thead>
                                        <tr>
                                            <th>Permission</th>
                                            <th>Admin</th>
                                            <th>Operator</th>
                                            <th>Viewer</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>View Agents & Devices</td><td>✓</td><td>✓</td><td>✓</td></tr>
                                        <tr><td>View Metrics & Logs</td><td>✓</td><td>✓</td><td>✓</td></tr>
                                        <tr><td>Manage Agents (edit, delete)</td><td>✓</td><td>✓</td><td></td></tr>
                                        <tr><td>Generate Installer Packages</td><td>✓</td><td>✓</td><td></td></tr>
                                        <tr><td>Access Agent/Device Proxy</td><td>✓</td><td>✓</td><td></td></tr>
                                        <tr><td>Manage Users & Sessions</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>Manage Tenants & Tokens</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>Configure SSO Providers</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>Modify Server Settings</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>View Audit Logs</td><td>✓</td><td></td><td></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Sessions Section -->
                        <div class="panel" style="margin-top:16px;">
                            <h4 style="margin-top:0;color:var(--highlight)">Active Sessions</h4>
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="color:var(--muted);font-size:13px;">
                                    View and revoke active user sessions.
                                </div>
                                <button id="sessions_refresh_btn" class="ghost-btn">Refresh</button>
                            </div>
                            <div id="sessions_list" class="card" style="padding:12px;overflow:auto;">
                                <div class="muted-text">Loading sessions…</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tenants Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="tenants">
                    <div class="tenants-inner-subtab-bar" id="tenants_inner_subtab_bar">
                        <button class="subtab tenants-inner-subtab active" data-tenantsview="directory">Directory</button>
                        <button class="subtab tenants-inner-subtab" data-tenantsview="bundles">Installer Bundles</button>
                    </div>

                    <div class="tenants-view-panel" data-tenantsview-panel="directory">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;">
                            <div style="color:var(--muted);">Manage tenants and onboarding tokens</div>
                            <div>
                                <button id="new_tenant_btn">New Tenant</button>
                            </div>
                        </div>
                        <div id="tenants_list">
                            <div style="color:var(--muted);">Loading tenants...</div>
                        </div>
                    </div>

                    <div class="tenants-view-panel hidden" data-tenantsview-panel="bundles">
                        <div class="panel">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="color:var(--muted);">Review generated installer bundles per tenant.</div>
                                <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
                                    <label style="display:flex;flex-direction:column;font-size:12px;gap:4px;">
                                        <span>Tenant</span>
                                        <select id="tenant_bundles_tenant_select" style="min-width:220px;"></select>
                                    </label>
                                    <button id="tenant_bundles_refresh_btn" class="ghost-btn">Refresh</button>
                                </div>
                            </div>
                            <div id="tenant_bundles_table" class="card" style="padding:12px;overflow:auto;">
                                <div class="muted-text">Select a tenant to view installer bundles.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fleet Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="fleet">
                    <div class="managed-settings-grid">
                        <div class="panel" id="managed_settings_panel">
                            <h4 style="margin-top:0;color:var(--highlight)">Fleet Settings</h4>
                            <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">
                                Configure discovery, SNMP, and agent behavior pushed to all connected agents.
                            </div>
                            <div class="settings-scope-bar">
                                <div class="settings-scope-buttons">
                                    <button class="settings-scope-btn active" data-scope="global">Global Defaults</button>
                                    <button class="settings-scope-btn" data-scope="tenant">Tenant Overrides</button>
                                </div>
                                <div class="settings-tenant-controls hidden" id="settings_tenant_controls">
                                    <label>
                                        <span>Tenant</span>
                                        <select id="settings_tenant_select"></select>
                                    </label>
                                    <button id="settings_reset_overrides_btn" class="ghost-btn">Clear Overrides</button>
                                </div>
                                <div class="settings-updated" id="settings_last_updated"></div>
                            </div>

                            <div id="settings_form_root" class="settings-form-root">
                                <div class="muted-text">Loading managed settings…</div>
                            </div>

                            <div class="settings-actions">
                                <div class="settings-status" id="settings_status"></div>
                                <div class="settings-action-buttons">
                                    <button id="settings_discard_btn" class="ghost-btn">Discard Changes</button>
                                    <button id="settings_save_btn" class="primary">Save Changes</button>
                                </div>
                            </div>
                        </div>

                        <div class="panel" id="settings_summary_panel">
                            <h4 id="settings_summary_title" style="margin-top:0;color:var(--highlight);">Management Summary</h4>
                            <div id="settings_override_list" class="muted-text">Select a tenant to view overrides.</div>
                        </div>
                    </div>

                    <!-- Agent Updates Section -->
                    <div class="panel" style="margin-top:16px;">
                        <h4 style="margin-top:0;color:var(--highlight)">Agent Updates</h4>
                        
                        <div id="agent_update_policy_root" class="settings-form-root" style="margin-bottom:16px;">
                            <div class="muted-text">Loading agent update policy…</div>
                        </div>

                        <div class="card" style="padding:16px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="font-weight:600;font-size:14px;color:var(--highlight)">Cached Release Artifacts</div>
                                <div style="display:flex;gap:8px;">
                                    <button id="releases_sync_btn" class="ghost-btn">Sync from GitHub</button>
                                </div>
                            </div>
                            <div id="releases_artifacts_container" style="overflow:auto;">
                                <div class="muted-text">Loading cached artifacts…</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Server Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="server">
                    <div class="panel">
                        <h4 style="margin-top:0;color:var(--highlight)">Server Settings</h4>
                        <div style="color:var(--muted);font-size:13px;margin-bottom:12px;max-width:600px;">
                            Core configuration affecting this PrintMaster server instance.
                        </div>
                        <div id="server_settings_container" class="card" style="padding:12px;display:flex;flex-direction:column;gap:12px;">
                            <div class="muted-text">Loading server settings…</div>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:16px;">
                        <h4 style="margin-top:0;color:var(--highlight)">Server Updates</h4>
                        
                        <div id="selfupdate_status_card" class="card" style="padding:12px;margin-bottom:16px;">
                            <div class="muted-text">Loading status…</div>
                        </div>

                        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                            <div style="font-weight:600;font-size:14px;">Update History</div>
                            <div style="display:flex;gap:8px;">
                                <button id="selfupdate_refresh_btn" class="ghost-btn">Refresh</button>
                            </div>
                        </div>
                        <div id="selfupdate_runs_container" class="card" style="padding:12px;overflow:auto;">
                            <div class="muted-text">Loading update history…</div>
                        </div>
                    </div>
                </div>

                <!-- Audit Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="audit">
                    <div class="panel log-panel">
                        <div class="log-controls audit-controls">
                            <div class="audit-filter-grid">
                                <label class="log-control column">
                                    <span>Time Range</span>
                                    <select id="audit_time_filter">
                                        <option value="24">Last 24h</option>
                                        <option value="168">Last 7 days</option>
                                        <option value="720">Last 30 days</option>
                                    </select>
                                </label>
                                <label class="log-control column">
                                    <span>Actor ID</span>
                                    <input type="text" id="audit_actor_filter" placeholder="Optional actor identifier" />
                                </label>
                                <label class="log-control column">
                                    <span>Tenant</span>
                                    <input type="text" id="audit_tenant_filter" placeholder="Tenant ID or name" />
                                </label>
                                <label class="log-control column">
                                    <span>Action</span>
                                    <input type="text" id="audit_action_filter" list="audit_action_suggestions" placeholder="Filter by action keyword" />
                                    <datalist id="audit_action_suggestions"></datalist>
                                </label>
                                <label class="log-control column">
                                    <span>Search</span>
                                    <input type="text" id="audit_search_filter" placeholder="Search actor, target, IP, metadata..." />
                                </label>
                                <div class="audit-severity-group">
                                    <span>Severity</span>
                                    <div class="audit-severity-options" id="audit_severity_filter">
                                        <label class="audit-severity-pill">
                                            <input type="checkbox" class="audit-severity-option" value="error" checked />
                                            <span>Error</span>
                                        </label>
                                        <label class="audit-severity-pill">
                                            <input type="checkbox" class="audit-severity-option" value="warn" checked />
                                            <span>Warning</span>
                                        </label>
                                        <label class="audit-severity-pill">
                                            <input type="checkbox" class="audit-severity-option" value="info" checked />
                                            <span>Info</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="audit-controls-row">
                                <label class="log-control">
                                    <input type="checkbox" id="audit_live_toggle" /> Auto-refresh (15s)
                                </label>
                                <div class="audit-controls-actions">
                                    <button class="ghost-btn" id="audit_clear_filters_btn">Reset Filters</button>
                                    <button id="refresh_audit_logs_btn">Refresh</button>
                                </div>
                            </div>
                            <div class="audit-summary" id="audit_summary" hidden>
                                <span id="audit_summary_counts">0 entries</span>
                                <span id="audit_summary_updated">Updated just now</span>
                                <span id="audit_live_status" class="audit-live-status">Auto-refresh off</span>
                            </div>
                        </div>
                        <div id="audit_logs_table" class="table-wrapper">
                            <div class="muted-text">Loading audit entries...</div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Logs Tab (System logs only - Audit moved to Admin) -->
        <div class="hidden" style="margin-top:12px;" data-tab="logs">
            <h3>System Logs</h3>

            <div class="panel log-panel">
                <div class="log-controls">
                    <div class="log-view-toggle">
                        <button class="log-view-btn active" data-log-view-mode="table" title="Table View">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v1h14V2a1 1 0 0 0-1-1H2zM1 5v.5h6V5H1zm7 0v.5h7V5H8zM1 7v.5h6V7H1zm7 0v.5h7V7H8zM1 9v.5h6V9H1zm7 0v.5h7V9H8zM1 11v.5h6V11H1zm7 0v.5h7V11H8z"/>
                            </svg>
                        </button>
                        <button class="log-view-btn" data-log-view-mode="raw" title="Raw View">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
                            </svg>
                        </button>
                    </div>
                    <label class="log-control"><input type="checkbox" id="pause_autoscroll" /> Pause auto-scroll</label>
                    <select id="log_level_filter">
                        <option value="">All Levels</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARN">WARN</option>
                        <option value="INFO">INFO</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="TRACE">TRACE</option>
                    </select>
                    <input type="text" id="log_search_filter" placeholder="Search logs..." />
                    <button id="copy_logs_btn">Copy Logs</button>
                    <button id="download_logs_btn">Download Logs</button>
                    <button id="clear_log_btn">Clear Log</button>
                </div>
                <div id="log_table_container" class="log-table-container">
                    <table class="log-table" id="log_table">
                        <thead>
                            <tr>
                                <th class="log-col-time">Time</th>
                                <th class="log-col-level">Level</th>
                                <th class="log-col-message">Message</th>
                                <th class="log-col-context">Context</th>
                            </tr>
                        </thead>
                        <tbody id="log_table_body"></tbody>
                    </table>
                </div>
                <pre id="log" class="hidden"></pre>
            </div>
        </div>

    </div> <!-- End content-container -->

    <!-- Toast notification container -->
    <div class="toast-container" id="toast_container"></div>

    <!-- Login Modal -->
    <div class="modal" id="login_modal" style="display:none;">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <span class="modal-title">Sign In</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:8px;color:var(--muted);">Sign in to access PrintMaster.</div>
                <label style="display:block;margin-bottom:6px;">Username</label>
                <input id="login_username" type="text" style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid var(--border);" />
                <label style="display:block;margin-bottom:6px;">Password</label>
                <input id="login_password" type="password" style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid var(--border);" />
                <div id="login_error" style="color:var(--danger);display:none;margin-bottom:8px;font-size:13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="login_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="login_submit">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm_modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="confirm_modal_title">Confirm Action</span>
                <span class="modal-close" id="confirm_modal_close_x">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirm_modal_message">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="confirm_modal_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="confirm_modal_confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div class="modal" id="agent_details_modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span class="modal-title" id="agent_details_title">Agent Details</span>
                <span class="modal-close" id="agent_details_close_x">&times;</span>
            </div>
            <div class="modal-body" id="agent_details_body" style="max-height: 500px; overflow-y: auto;">
                <div style="color:var(--muted);">Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="agent_details_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Printer Details modal with overlay (shared) -->
    <div id="printer_details_overlay" class="modal" style="display:none;">
        <div id="printer_details_modal" class="printer-details-dialog modal-content" style="max-width:900px;">
            <button class="modal-close-x" id="printer_details_close_x" title="Close">&times;</button>
            <h3 id="printer_details_title" style="margin-top:0;color:var(--highlight)">Printer Details</h3>
            <div id="printer_details_body"
                style="overflow-x:hidden;overflow-y:auto;font-family:system-ui;color:var(--text);word-wrap:break-word;flex:1;max-height:60vh;padding-right:8px;">
            </div>
            <div id="printer_details_actions" style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px;flex-shrink:0">
                <button class="modal-button modal-button-secondary" id="printer_details_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Agent Multi-step Modal -->
    <div class="modal modal-overlay" id="add_agent_modal" style="display:none;">
        <div class="modal-dialog" style="max-width:720px;">
            <div class="modal-header">
                <span class="modal-title" id="add_agent_title">Add Agent</span>
                <span class="modal-close" id="add_agent_close_x">&times;</span>
            </div>
            <div class="modal-body" id="add_agent_body" style="max-height:520px;overflow-y:auto;">
                <div id="add_agent_step_indicator" style="font-size:13px;color:var(--muted);margin-bottom:8px;">Step 1/3</div>
                <div id="add_agent_content">
                    <!-- Dynamic content rendered by app.js -->
                </div>
            </div>
            <div class="modal-footer" id="add_agent_footer">
                <button class="modal-button modal-button-secondary" id="add_agent_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="add_agent_primary">Next</button>
            </div>
        </div>
    </div>

    <!-- Generic Input Modal (used for small prompts, replaces prompt()) -->
    <div class="modal" id="input_modal" style="display:none;">
        <div class="modal-content" style="max-width:520px;">
            <div class="modal-header">
                <span class="modal-title" id="input_modal_title">Input</span>
                <span class="modal-close" id="input_modal_close_x">&times;</span>
            </div>
            <div class="modal-body" id="input_modal_body">
                <div id="input_modal_label" style="margin-bottom:8px;color:var(--muted);"></div>
                <input id="input_modal_input" type="text" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);" />
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="input_modal_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="input_modal_ok">OK</button>
            </div>
        </div>
    </div>

    <!-- SSO Provider Modal -->
    <div class="modal" id="sso_modal" style="display:none;">
        <div class="modal-content" style="max-width:640px;">
            <div class="modal-header">
                <span class="modal-title" id="sso_modal_title">Add OIDC Provider</span>
                <span class="modal-close" id="sso_modal_close">&times;</span>
            </div>
            <form id="sso_modal_form">
                <div class="modal-body" style="max-height:70vh;overflow:auto;display:flex;flex-direction:column;gap:16px;">
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Provider Template</span>
                        <select id="sso_template_select" style="padding:8px;border-radius:4px;border:1px solid var(--border);">
                            <option value="generic">Generic OIDC</option>
                            <option value="entra">Microsoft Entra ID</option>
                        </select>
                    </label>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Display Name</span>
                            <input id="sso_display_name" type="text" required style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="Acme SSO" />
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Slug</span>
                            <input id="sso_slug" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="acme" />
                            <small style="color:var(--muted);">Lowercase letters, numbers, and hyphen.</small>
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Tenant Scope</span>
                            <select id="sso_tenant" style="padding:8px;border-radius:4px;border:1px solid var(--border);"></select>
                            <small style="color:var(--muted);">Leave blank to make the provider global.</small>
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Default Role</span>
                            <select id="sso_default_role" style="padding:8px;border-radius:4px;border:1px solid var(--border);">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </label>
                    </div>
                    <label class="preset-section preset-generic" data-display="flex" style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Issuer URL</span>
                        <input id="sso_issuer" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="https://login.microsoftonline.com/..." />
                    </label>
                    <label class="preset-section preset-entra" data-display="flex" style="display:none;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Microsoft Entra Tenant (Directory) ID</span>
                        <input id="sso_entra_tenant" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="11111111-2222-3333-4444-555555555555" />
                        <small style="color:var(--muted);">We derive the issuer URL from this tenant ID.</small>
                    </label>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Client ID</span>
                        <input id="sso_client_id" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" />
                    </label>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Client Secret</span>
                        <input id="sso_client_secret" type="password" style="padding:8px;border-radius:4px;border:1px solid var(--border);" />
                        <small style="color:var(--muted);">Leave blank to keep the existing secret when editing.</small>
                    </label>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Button Text</span>
                            <input id="sso_button_text" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="Sign in with Contoso" />
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Icon URL</span>
                            <input id="sso_icon" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="https://.../logo.svg" />
                        </label>
                    </div>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Button Style (optional CSS classes)</span>
                        <input id="sso_button_style" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="btn btn-accent" />
                    </label>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Scopes</span>
                        <input id="sso_scopes" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" />
                        <small style="color:var(--muted);">Separate scopes with spaces or commas. "openid" is always included.</small>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
                        <input id="sso_auto_login" type="checkbox" />
                        <span>Automatically redirect users to this provider when it is the only option.</span>
                    </label>
                    <div id="sso_modal_error" style="display:none;color:var(--danger);font-size:13px;"></div>
                    <div id="sso_entra_instructions" class="sso-modal-helper preset-entra" data-display="block" style="display:none;">
                        <div style="font-weight:600;margin-bottom:6px;">Microsoft Entra setup checklist</div>
                        <ul>
                            <li>Create an app registration in <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/CreateApplicationBlade/quickStartType~/null/isMSAApp~/false" target="_blank" rel="noopener" class="sso-entra-portal-link">Microsoft Entra admin center</a>.</li>
                            <li>Select “Accounts in this organization only” and add <code id="sso_modal_redirect_uri_text">https://example.com/auth/oidc/callback</code> as a Web redirect URI.</li>
                            <li>Copy the Application (client) ID, create a client secret, and keep the Directory (tenant) ID.</li>
                            <li>Paste the client ID/secret here; the issuer URL is generated from your tenant ID automatically.</li>
                        </ul>
                        <button type="button" class="link-button" id="sso_modal_copy_redirect">Copy redirect URI</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-button modal-button-secondary" id="sso_modal_cancel">Cancel</button>
                    <button type="submit" class="modal-button modal-button-primary" id="sso_modal_submit">Save Provider</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal (create/edit) -->
    <div class="modal" id="user_modal" style="display:none;">
        <div class="modal-content user-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="user_modal_title">Add User</span>
                <span class="modal-close" id="user_modal_close_x">&times;</span>
            </div>
            <div class="modal-body user-modal-body">
                <div class="user-form-grid">
                    <div class="user-form-section">
                        <h4 class="user-form-section-title">Account Details</h4>
                        <label class="user-form-label">
                            <span>Username <span class="required">*</span></span>
                            <input id="user_username" type="text" class="user-form-input" placeholder="johndoe" />
                        </label>
                        <label class="user-form-label">
                            <span>Email</span>
                            <input id="user_email" type="email" class="user-form-input" placeholder="john@example.com" />
                        </label>
                        <label class="user-form-label">
                            <span>Role</span>
                            <select id="user_role" class="user-form-input">
                                <option value="viewer">Viewer</option>
                                <option value="operator">Operator</option>
                                <option value="admin">Admin</option>
                            </select>
                        </label>
                        <label class="user-form-label">
                            <span>Tenant</span>
                            <select id="user_tenant" class="user-form-input">
                                <option value="">(Global / Server)</option>
                            </select>
                            <span class="user-form-helper">Assign user to a specific tenant or leave global for server-wide access</span>
                        </label>
                    </div>
                    
                    <div class="user-form-section" id="user_password_section">
                        <div class="user-form-section-header">
                            <h4 class="user-form-section-title">Password</h4>
                            <label class="user-form-checkbox" id="user_change_password_toggle" style="display:none;">
                                <input type="checkbox" id="user_change_password" />
                                <span>Change password</span>
                            </label>
                        </div>
                        <div id="user_password_fields">
                            <label class="user-form-label">
                                <span>Password <span class="required" id="user_password_required">*</span></span>
                                <input id="user_password" type="password" class="user-form-input" placeholder="Enter password" autocomplete="new-password" />
                            </label>
                            <label class="user-form-label">
                                <span>Confirm Password <span class="required" id="user_password_confirm_required">*</span></span>
                                <input id="user_password_confirm" type="password" class="user-form-input" placeholder="Confirm password" autocomplete="new-password" />
                            </label>
                            <div class="password-strength" id="user_password_strength">
                                <div class="password-strength-bar">
                                    <div class="password-strength-fill" id="user_password_strength_fill"></div>
                                </div>
                                <div class="password-strength-text" id="user_password_strength_text">Enter a password</div>
                            </div>
                            <div class="password-requirements" id="user_password_requirements">
                                <div class="requirement" data-req="length"><span class="req-icon">○</span> Minimum 8 characters</div>
                                <div class="requirement" data-req="uppercase"><span class="req-icon">○</span> Uppercase letter</div>
                                <div class="requirement" data-req="lowercase"><span class="req-icon">○</span> Lowercase letter</div>
                                <div class="requirement" data-req="number"><span class="req-icon">○</span> Number</div>
                                <div class="requirement" data-req="special"><span class="req-icon">○</span> Special character</div>
                                <div class="requirement" data-req="match"><span class="req-icon">○</span> Passwords match</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="user_error" class="user-form-error"></div>
            </div>
            <div class="modal-footer user-modal-footer">
                <button class="btn-outline" id="user_cancel">Cancel</button>
                <button class="btn-primary" id="user_submit">Create User</button>
            </div>
        </div>
    </div>

    <!-- Invite User Modal -->
    <div class="modal" id="invite_user_modal" style="display:none;">
        <div class="modal-content user-modal-content">
            <div class="modal-header">
                <span class="modal-title">Invite User</span>
                <span class="modal-close" id="invite_user_modal_close_x">&times;</span>
            </div>
            <div class="modal-body user-modal-body">
                <div class="invite-info">
                    <svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>
                    <div class="invite-description">
                        <h4>Send an email invitation</h4>
                        <p>The user will receive an email with a link to set up their account and create a password.</p>
                    </div>
                </div>
                <div class="user-form-section" style="margin-top:20px;">
                    <label class="user-form-label">
                        <span>Email Address <span class="required">*</span></span>
                        <input id="invite_email" type="email" class="user-form-input" placeholder="john@example.com" />
                    </label>
                    <label class="user-form-label">
                        <span>Username</span>
                        <input id="invite_username" type="text" class="user-form-input" placeholder="Leave blank to use email prefix" />
                        <span class="user-form-helper">Optional. If blank, username will be derived from email address.</span>
                    </label>
                    <label class="user-form-label">
                        <span>Role</span>
                        <select id="invite_role" class="user-form-input">
                            <option value="viewer">Viewer</option>
                            <option value="operator">Operator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </label>
                    <label class="user-form-label">
                        <span>Tenant</span>
                        <select id="invite_tenant" class="user-form-input">
                            <option value="">(Global / Server)</option>
                        </select>
                    </label>
                </div>
                <div id="invite_error" class="user-form-error"></div>
                <div id="invite_smtp_warning" class="user-form-warning" style="display:none;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/></svg>
                    <span>Email invitations require SMTP to be configured in server settings.</span>
                </div>
            </div>
            <div class="modal-footer user-modal-footer">
                <button class="btn-outline" id="invite_user_cancel">Cancel</button>
                <button class="btn-primary" id="invite_user_submit" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/></svg>
                    Send Invitation
                </button>
            </div>
        </div>
    </div>

    <!-- Tenant Modal -->
    <div class="modal" id="tenant_modal" style="display:none;">
        <div class="modal-content tenant-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="tenant_modal_title">New Tenant</span>
                <button class="modal-close-x" id="tenant_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body tenant-modal-body">
                <div class="tenant-form-grid">
                    <!-- Left column: Core identity -->
                    <div class="tenant-form-section">
                        <div class="tenant-section-title">Tenant Information</div>
                        <label class="tenant-form-label">
                            <span>Tenant Name <span class="required">*</span></span>
                            <input id="tenant_name" type="text" class="tenant-form-input" placeholder="Acme Corp" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Billing / Reference Code</span>
                            <input id="tenant_billing_code" type="text" class="tenant-form-input" placeholder="ACME-OPS-01" />
                            <span class="tenant-form-helper">Internal reference for invoicing or tracking</span>
                        </label>
                        <label class="tenant-form-label">
                            <span>Login Domain (SSO)</span>
                            <input id="tenant_login_domain" type="text" class="tenant-form-input" placeholder="example.com" />
                            <span class="tenant-form-helper">Email domain for automatic tenant detection during SSO</span>
                        </label>
                    </div>
                    <!-- Right column: Contact details -->
                    <div class="tenant-form-section">
                        <div class="tenant-section-title">Primary Contact</div>
                        <label class="tenant-form-label">
                            <span>Contact Name</span>
                            <input id="tenant_contact_name" type="text" class="tenant-form-input" placeholder="Jane Smith" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Contact Email</span>
                            <input id="tenant_contact_email" type="email" class="tenant-form-input" placeholder="jane@example.com" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Contact Phone</span>
                            <input id="tenant_contact_phone" type="text" class="tenant-form-input" placeholder="+1 800 555 1234" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Address</span>
                            <textarea id="tenant_address" rows="2" class="tenant-form-input" placeholder="123 Main St, City, State"></textarea>
                        </label>
                    </div>
                </div>
                <!-- Full-width notes section -->
                <div class="tenant-form-section tenant-notes-section">
                    <label class="tenant-form-label">
                        <span>Notes</span>
                        <textarea id="tenant_description" rows="2" class="tenant-form-input" placeholder="Additional notes about this tenant..."></textarea>
                    </label>
                </div>
                <div id="tenant_error" class="tenant-form-error"></div>
            </div>
            <div class="modal-footer tenant-modal-footer">
                <button class="btn-outline" id="tenant_cancel">Cancel</button>
                <button class="btn-primary" id="tenant_save">Create Tenant</button>
            </div>
        </div>
    </div>

    <!-- Sites List Modal -->
    <div class="modal" id="sites_list_modal" style="display:none;">
        <div class="modal-content sites-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="sites_list_modal_title">Sites</span>
                <button class="modal-close-x" id="sites_list_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body sites-modal-body">
                <div class="sites-header">
                    <p class="muted-text" id="sites_list_subtitle">Manage sites for this tenant</p>
                    <button class="btn-primary" id="sites_list_add_btn">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        Add Site
                    </button>
                </div>
                <div id="sites_list_content">
                    <div class="muted-text">Loading sites...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Edit Modal -->
    <div class="modal" id="site_modal" style="display:none;">
        <div class="modal-content site-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="site_modal_title">New Site</span>
                <button class="modal-close-x" id="site_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body site-modal-body">
                <div class="site-form-grid">
                    <div class="site-form-section">
                        <div class="site-section-title">Site Details</div>
                        <label class="site-form-label">
                            <span>Site Name <span class="required">*</span></span>
                            <input id="site_name" type="text" class="site-form-input" placeholder="North Campus" />
                        </label>
                        <label class="site-form-label">
                            <span>Address</span>
                            <textarea id="site_address" rows="2" class="site-form-input" placeholder="123 Main St, City, State"></textarea>
                        </label>
                        <label class="site-form-label">
                            <span>Description</span>
                            <textarea id="site_description" rows="2" class="site-form-input" placeholder="Site notes..."></textarea>
                        </label>
                    </div>
                    <div class="site-form-section">
                        <div class="site-section-title">Assigned Agents</div>
                        <div id="site_agents_list" class="site-agents-list">
                            <div class="muted-text">Loading agents...</div>
                        </div>
                        <span class="site-form-helper">Select agents that serve this site. Devices will be grouped by agent unless filter rules are set.</span>
                    </div>
                </div>
                <div class="site-form-section site-rules-section">
                    <div class="site-section-header">
                        <div class="site-section-title">Device Filter Rules</div>
                        <button class="btn-outline btn-sm" id="site_add_rule_btn">
                            <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                            Add Rule
                        </button>
                    </div>
                    <p class="site-form-helper">When an agent serves multiple sites, use filter rules to route devices to the correct site. Leave empty to include all devices from assigned agents.</p>
                    <div id="site_filter_rules" class="site-filter-rules">
                        <!-- Filter rules will be rendered here -->
                    </div>
                </div>
                <div id="site_error" class="site-form-error"></div>
            </div>
            <div class="modal-footer site-modal-footer">
                <button class="btn-outline" id="site_cancel">Cancel</button>
                <button class="btn-primary" id="site_save">Create Site</button>
            </div>
        </div>
    </div>

    <script src="/static/sso-admin.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/rbac.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/app.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>

</body>

</html>
