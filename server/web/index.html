<!DOCTYPE html>
<html translate="no" data-lpignore="true" data-1p-ignore data-bwignore="true" data-form-type="other">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <!-- Prevent browser/extension interference -->
    <meta name="google" content="notranslate">
    <meta name="darkreader-lock">
    <meta name="theme-color" content="#002b36" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#fdf6e3" media="(prefers-color-scheme: light)">
    <meta name="format-detection" content="telephone=no">
    <title>PrintMaster Server</title>
    <script>window.__pm_shared = window.__pm_shared || {};</script>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='16' y='8' width='32' height='12' fill='%234a5568' rx='2'/><rect x='12' y='20' width='40' height='24' fill='%23718096' rx='3'/><rect x='16' y='24' width='32' height='16' fill='%23cbd5e0' rx='2'/><rect x='20' y='28' width='8' height='2' fill='%234299e1'/><rect x='20' y='32' width='12' height='2' fill='%234299e1'/><rect x='20' y='36' width='10' height='2' fill='%234299e1'/><circle cx='46' cy='32' r='3' fill='%2348bb78'/><rect x='16' y='44' width='32' height='12' fill='%234a5568' rx='2'/><rect x='20' y='48' width='24' height='4' fill='%23e2e8f0'/></svg>">
    <!-- flatpickr is injected centrally from common/web/shared.js -->
    <link rel="stylesheet" href="/static/shared.css{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}">
    <link rel="stylesheet" href="/static/style.css{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}">
    <script src="/static/shared.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/cards.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/metrics.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
</head>

<body>
    <div class="header-flex"
        style="display: flex; align-items: center; margin-bottom: 12px; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="header-logo" style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--highlight),var(--success));display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-sm);padding:3px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="24" height="24">
                        <rect x="16" y="8" width="32" height="12" fill="#4a5568" rx="2"/>
                        <rect x="12" y="20" width="40" height="24" fill="#718096" rx="3"/>
                        <rect x="16" y="24" width="32" height="16" fill="#cbd5e0" rx="2"/>
                        <rect x="20" y="28" width="8" height="2" fill="#4299e1"/>
                        <rect x="20" y="32" width="12" height="2" fill="#4299e1"/>
                        <rect x="20" y="36" width="10" height="2" fill="#4299e1"/>
                        <circle cx="46" cy="32" r="3" fill="#48bb78"/>
                        <rect x="16" y="44" width="32" height="12" fill="#4a5568" rx="2"/>
                        <rect x="20" y="48" width="24" height="4" fill="#e2e8f0"/>
                    </svg>
                </div>
                <h1 style="margin: 0;">PrintMaster Server</h1>
            </div>
            <div id="server_status" style="font-size:14px;color:var(--muted);">Loading...</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <button id="join_token_btn" title="Add an agent" class="modal-button modal-button-primary" style="display:none;">Add Agent</button>
            <label class="theme-toggle">
                <input type="checkbox" id="theme-toggle-checkbox">
                <div class="theme-toggle-slider">
                    <div class="theme-toggle-icon"></div>
                </div>
            </label>
            <button id="logout_btn" style="display:none;" title="Log out" class="modal-button">Log out</button>
        </div>
    </div>

    <!-- Main content container with floating appearance -->
    <div class="content-container">
        <div class="tabbar">
            <!-- Hamburger menu for mobile (legacy - hidden, using floating nav now) -->
            <div class="hamburger-menu">
                <div class="hamburger-header">
                    <span id="current_tab_label">Menu - Dashboard</span>
                    <div class="hamburger-icon">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            </div>
            <div class="mobile-nav" id="mobile_nav">
                <button class="tab active" data-target="dashboard">Dashboard</button>
                <button class="tab" data-target="agents">Agents</button>
                <button class="tab" data-target="devices">Devices</button>
                <button class="tab" data-target="metrics">Metrics</button>
                <button class="tab" data-target="logs">Logs</button>
            </div>
            <!-- Desktop tabs -->
            <div class="desktop-tabs" id="desktop_tabs">
                <button class="tab active" data-target="dashboard">Dashboard</button>
                <button class="tab" data-target="agents">Agents</button>
                <button class="tab" data-target="devices">Devices</button>
                <button class="tab" data-target="metrics">Metrics</button>
                <button class="tab" data-target="logs">Logs</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div style="margin-top:12px;" data-tab="dashboard">
            <div class="sidebar-layout dashboard-layout">
                <!-- Sidebar for search and filters -->
                <aside class="filter-sidebar dashboard-sidebar" id="dashboard_sidebar">
                    <div class="filter-sidebar-header dashboard-sidebar-header">
                        <h4>Search & Filter</h4>
                        <button class="ghost-btn filter-sidebar-toggle dashboard-sidebar-toggle" id="dashboard_sidebar_toggle" title="Toggle sidebar">
                            <span>◀</span>
                        </button>
                    </div>
                    
                    <div class="filter-sidebar-content dashboard-sidebar-content">
                        <!-- Search box -->
                        <div class="dashboard-search-section">
                            <label class="field">
                                <span>Search</span>
                                <input type="text" id="dashboard_search" placeholder="Search tenants, agents, devices…" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                            <div id="dashboard_search_results" class="dashboard-search-results hidden">
                                <span class="muted-text">No results</span>
                            </div>
                        </div>

                        <!-- Quick filters -->
                        <div class="dashboard-filter-section">
                            <div class="dashboard-filter-group">
                                <div class="filter-label">Show Levels</div>
                                <div class="dashboard-level-toggles">
                                    <label class="dashboard-level-toggle">
                                        <input type="checkbox" id="dashboard_show_tenants" checked />
                                        <span>Tenants</span>
                                    </label>
                                    <label class="dashboard-level-toggle">
                                        <input type="checkbox" id="dashboard_show_sites" checked />
                                        <span>Sites</span>
                                    </label>
                                    <label class="dashboard-level-toggle">
                                        <input type="checkbox" id="dashboard_show_agents" checked />
                                        <span>Agents</span>
                                    </label>
                                    <label class="dashboard-level-toggle">
                                        <input type="checkbox" id="dashboard_show_devices" checked />
                                        <span>Devices</span>
                                    </label>
                                </div>
                            </div>

                            <div class="dashboard-filter-group">
                                <div class="filter-label">Agent Status</div>
                                <div id="dashboard_agent_status_filter" class="pill-toggle-group compact" role="group">
                                    <button class="pill active" data-status="active" title="Active agents">Active</button>
                                    <button class="pill active" data-status="inactive" title="Inactive agents">Inactive</button>
                                    <button class="pill active" data-status="offline" title="Offline agents">Offline</button>
                                </div>
                            </div>

                            <div class="dashboard-filter-group">
                                <div class="filter-label">Device Supplies</div>
                                <div id="dashboard_supply_filter" class="pill-toggle-group compact" role="group">
                                    <button class="pill active" data-band="critical" title="Critical (≤10%)">Critical</button>
                                    <button class="pill active" data-band="low" title="Low (11-25%)">Low</button>
                                    <button class="pill active" data-band="medium" title="Medium (26-50%)">Medium</button>
                                    <button class="pill active" data-band="high" title="High (>50%)">High</button>
                                    <button class="pill active" data-band="unknown" title="Unknown supply level">Unknown</button>
                                </div>
                            </div>

                            <div class="dashboard-filter-group">
                                <div class="filter-label">Device Status</div>
                                <div id="dashboard_device_status_filter" class="pill-toggle-group compact" role="group">
                                    <button class="pill active" data-status="healthy" title="Healthy devices">Healthy</button>
                                    <button class="pill active" data-status="warning" title="Warning status">Warning</button>
                                    <button class="pill active" data-status="error" title="Error status">Error</button>
                                    <button class="pill active" data-status="jam" title="Paper jam">Jam</button>
                                </div>
                            </div>
                        </div>

                        <!-- Active filters display -->
                        <div id="dashboard_active_filters" class="filter-chip-row"></div>

                        <div class="dashboard-filter-actions">
                            <button id="dashboard_reset_filters" class="ghost-btn">Reset Filters</button>
                        </div>
                    </div>
                </aside>

                <!-- Main dashboard content -->
                <main class="dashboard-main">
                    <!-- Fleet overview summary cards -->
                    <div class="dashboard-summary" id="dashboard_summary">
                        <div class="dashboard-summary-card">
                            <div class="dashboard-summary-value" id="dashboard_tenant_count">-</div>
                            <div class="dashboard-summary-label">Tenants</div>
                        </div>
                        <div class="dashboard-summary-card">
                            <div class="dashboard-summary-value" id="dashboard_site_count">-</div>
                            <div class="dashboard-summary-label">Sites</div>
                        </div>
                        <div class="dashboard-summary-card">
                            <div class="dashboard-summary-value" id="dashboard_agent_count">-</div>
                            <div class="dashboard-summary-label">Agents</div>
                        </div>
                        <div class="dashboard-summary-card">
                            <div class="dashboard-summary-value" id="dashboard_device_count">-</div>
                            <div class="dashboard-summary-label">Devices</div>
                        </div>
                        <div class="dashboard-summary-card warning" id="dashboard_critical_card">
                            <div class="dashboard-summary-value" id="dashboard_critical_count">-</div>
                            <div class="dashboard-summary-label">Critical Supplies</div>
                        </div>
                        <div class="dashboard-summary-card" id="dashboard_low_card">
                            <div class="dashboard-summary-value" id="dashboard_low_count">-</div>
                            <div class="dashboard-summary-label">Low Supplies</div>
                        </div>
                        <div class="dashboard-summary-card">
                            <div class="dashboard-summary-value" id="dashboard_pages_count">-</div>
                            <div class="dashboard-summary-label">Total Pages</div>
                        </div>
                    </div>

                    <!-- Tree controls -->
                    <div class="dashboard-tree-controls">
                        <div class="dashboard-tree-controls-left">
                            <button id="dashboard_expand_all" class="ghost-btn" title="Expand all nodes">Expand All</button>
                            <button id="dashboard_collapse_all" class="ghost-btn" title="Collapse all nodes">Collapse All</button>
                        </div>
                        <div class="dashboard-tree-controls-right">
                            <button id="dashboard_refresh" class="ghost-btn" title="Refresh dashboard data">
                                <span class="refresh-icon">↻</span> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Tree view container -->
                    <div class="dashboard-tree-container" id="dashboard_tree">
                        <div class="dashboard-loading">
                            <div class="loading-spinner"></div>
                            <span>Loading fleet hierarchy…</span>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Agents Tab -->
        <div style="margin-top:12px;" data-tab="agents" class="hidden">
            <div class="sidebar-layout agents-layout">
                <!-- Sidebar for search and filters -->
                <aside class="filter-sidebar agents-sidebar" id="agents_sidebar">
                    <div class="filter-sidebar-header agents-sidebar-header">
                        <h4>Search & Filter</h4>
                        <button class="ghost-btn filter-sidebar-toggle agents-sidebar-toggle" id="agents_sidebar_toggle" title="Toggle sidebar">
                            <span>◀</span>
                        </button>
                    </div>
                    
                    <div class="filter-sidebar-content agents-sidebar-content">
                        <!-- Search box -->
                        <div class="sidebar-search-section">
                            <label class="field">
                                <span>Search</span>
                                <input type="text" id="agents_search" placeholder="Search name, hostname, ID…" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                        </div>

                        <!-- Dropdown filters -->
                        <div class="sidebar-filter-section">
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Version</span>
                                    <select id="agents_version_filter">
                                        <option value="">All Versions</option>
                                    </select>
                                </label>
                            </div>
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Platform</span>
                                    <select id="agents_platform_filter">
                                        <option value="">All Platforms</option>
                                    </select>
                                </label>
                            </div>
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Tenant</span>
                                    <select id="agents_tenant_filter">
                                        <option value="">All Tenants</option>
                                    </select>
                                </label>
                            </div>
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Sort By</span>
                                    <div class="sort-select">
                                        <select id="agents_sort_select">
                                            <option value="last_seen">Last Seen</option>
                                            <option value="name">Agent Name</option>
                                            <option value="status">Status</option>
                                            <option value="connection">Connection</option>
                                            <option value="version">Version</option>
                                            <option value="tenant">Tenant</option>
                                        </select>
                                        <button id="agents_sort_dir_btn" class="ghost-btn" title="Toggle sort direction" aria-label="Toggle sort direction">
                                            <span id="agents_sort_dir_icon">↓</span>
                                        </button>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Status filters -->
                        <div class="sidebar-filter-section">
                            <div class="sidebar-filter-group">
                                <div class="filter-label">Status</div>
                                <div id="agents_status_filter" class="pill-toggle-group compact" role="group" aria-label="Status filters">
                                    <button class="pill active" data-status="active" data-label="Active">Active</button>
                                    <button class="pill active" data-status="inactive" data-label="Inactive">Inactive</button>
                                    <button class="pill active" data-status="offline" data-label="Offline">Offline</button>
                                </div>
                            </div>
                            <div class="sidebar-filter-group">
                                <div class="filter-label">Connection</div>
                                <div id="agents_connection_filter" class="pill-toggle-group compact" role="group" aria-label="Connection filters">
                                    <button class="pill active" data-connection="ws" data-label="Live WS">Live WS</button>
                                    <button class="pill active" data-connection="http" data-label="HTTP">HTTP</button>
                                    <button class="pill active" data-connection="none" data-label="Offline">Offline</button>
                                </div>
                            </div>
                        </div>

                        <!-- Active filters display -->
                        <div id="agents_active_filters" class="filter-chip-row"></div>

                        <div class="sidebar-filter-actions">
                            <button id="agents_reset_filters" class="ghost-btn" style="width:100%;">Reset Filters</button>
                        </div>
                    </div>
                </aside>

                <!-- Main agents content -->
                <main class="agents-main">
                    <div class="agents-main-header">
                        <div>
                            <h3 style="margin-bottom:4px;">Fleet Agents</h3>
                            <div class="muted-text">Track connectivity, versions, and last-seen activity across every deployment.</div>
                        </div>
                        <div class="agents-main-actions">
                            <label class="field inline-check" title="Automatically check for agent updates when loading this page">
                                <input type="checkbox" id="agents_check_updates_toggle" checked />
                                <span>Auto-check</span>
                            </label>
                            <button id="agents_check_updates_btn" class="ghost-btn">Check Updates</button>
                            <div class="view-toggle" id="agents_view_toggle" role="group" aria-label="Agents view">
                                <button class="ghost-btn active" data-view="cards">Cards</button>
                                <button class="ghost-btn" data-view="table">Table</button>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Registrations Banner (hidden by default, shown when tenancy enabled and pending regs exist) -->
                    <div id="pending_registrations_section" class="pending-registrations-section hidden">
                        <div class="pending-registrations-header">
                            <div class="pending-registrations-title">
                                <span class="pending-registrations-icon">⚠️</span>
                                <span>Pending Agent Registrations</span>
                                <span class="pending-registrations-count" id="pending_registrations_count"></span>
                            </div>
                            <div class="pending-registrations-actions">
                                <button class="ghost-btn" id="pending_registrations_refresh">Refresh</button>
                                <button class="ghost-btn" id="pending_registrations_toggle" aria-expanded="false">Show Details</button>
                            </div>
                        </div>
                        <div class="pending-registrations-body hidden" id="pending_registrations_body">
                            <div class="pending-registrations-info">
                                <p>These agents attempted to connect using expired join tokens. Review and approve them to assign to a tenant, or reject if unauthorized.</p>
                            </div>
                            <div class="table-wrapper">
                                <table class="simple-table pending-registrations-table" id="pending_registrations_table">
                                    <thead>
                                        <tr>
                                            <th>Agent</th>
                                            <th>Platform</th>
                                            <th>IP Address</th>
                                            <th>Original Tenant</th>
                                            <th>Requested</th>
                                            <th>Status</th>
                                            <th class="actions-col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending_registrations_tbody">
                                        <tr><td colspan="7" class="muted-text">Loading…</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="agents_overview_metrics" class="metrics-overview-grid compact" style="margin-bottom:12px;">
                        <div class="metric-card loading">Loading agent metrics…</div>
                    </div>

                    <div id="agents_stats" class="agents-inline-stats"></div>

                    <div class="device-cards-container" id="agents_cards"></div>
                    <div id="agents_table_wrapper" class="hidden">
                        <div class="table-wrapper">
                            <table class="simple-table" id="agents_table">
                                <thead>
                                    <tr>
                                        <th data-sort-key="name">Agent</th>
                                        <th data-sort-key="tenant">Tenant</th>
                                        <th data-sort-key="status">Status</th>
                                        <th data-sort-key="connection">Connection</th>
                                        <th data-sort-key="platform">Platform</th>
                                        <th data-sort-key="version">Version</th>
                                        <th data-sort-key="last_seen">Last Seen</th>
                                        <th class="actions-col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="8" class="muted-text">Loading agents…</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Devices Tab -->
        <div style="margin-top:12px;" data-tab="devices" class="hidden">
            <div class="sidebar-layout devices-layout">
                <!-- Sidebar for search and filters -->
                <aside class="filter-sidebar devices-sidebar" id="devices_sidebar">
                    <div class="filter-sidebar-header devices-sidebar-header">
                        <h4>Search & Filter</h4>
                        <button class="ghost-btn filter-sidebar-toggle devices-sidebar-toggle" id="devices_sidebar_toggle" title="Toggle sidebar">
                            <span>◀</span>
                        </button>
                    </div>
                    
                    <div class="filter-sidebar-content devices-sidebar-content">
                        <!-- Search box -->
                        <div class="sidebar-search-section">
                            <label class="field">
                                <span>Search</span>
                                <input type="text" id="devices_search" placeholder="Search serial, IP, model…" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                        </div>

                        <!-- Dropdown filters -->
                        <div class="sidebar-filter-section">
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Agent</span>
                                    <select id="devices_agent_filter">
                                        <option value="">All Agents</option>
                                    </select>
                                </label>
                            </div>
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Tenant</span>
                                    <select id="devices_tenant_filter">
                                        <option value="">All Tenants</option>
                                    </select>
                                </label>
                            </div>
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Manufacturer</span>
                                    <select id="devices_manufacturer_filter">
                                        <option value="">All Manufacturers</option>
                                    </select>
                                </label>
                            </div>
                            <div class="sidebar-filter-group">
                                <label class="field">
                                    <span>Sort By</span>
                                    <div class="sort-select">
                                        <select id="devices_sort_select">
                                            <option value="last_seen">Last Seen</option>
                                            <option value="manufacturer">Manufacturer</option>
                                            <option value="agent">Agent</option>
                                            <option value="tenant">Tenant</option>
                                            <option value="status">Status</option>
                                            <option value="ip">Network</option>
                                            <option value="location">Location</option>
                                        </select>
                                        <button id="devices_sort_dir_btn" class="ghost-btn" title="Toggle sort direction" aria-label="Toggle sort direction">
                                            <span id="devices_sort_dir_icon">↓</span>
                                        </button>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Status filters -->
                        <div class="sidebar-filter-section">
                            <div class="sidebar-filter-group">
                                <div class="filter-label">Status</div>
                                <div id="devices_status_filter" class="pill-toggle-group compact" role="group" aria-label="Status filters">
                                    <button class="pill active" data-status="healthy" data-label="Healthy">Healthy</button>
                                    <button class="pill active" data-status="warning" data-label="Warning">Warning</button>
                                    <button class="pill active" data-status="error" data-label="Error">Error</button>
                                    <button class="pill active" data-status="jam" data-label="Jam">Jam</button>
                                </div>
                            </div>
                            <div class="sidebar-filter-group">
                                <div class="filter-label">Consumables</div>
                                <div id="devices_consumable_filter" class="pill-toggle-group compact" role="group" aria-label="Consumable filters">
                                    <button class="pill active" data-band="critical" data-label="Critical">Critical</button>
                                    <button class="pill active" data-band="low" data-label="Low">Low</button>
                                    <button class="pill active" data-band="medium" data-label="Medium">Medium</button>
                                    <button class="pill active" data-band="high" data-label="High">High</button>
                                    <button class="pill active" data-band="unknown" data-label="Unknown">Unknown</button>
                                </div>
                            </div>
                        </div>

                        <!-- Active filters display -->
                        <div id="devices_active_filters" class="filter-chip-row"></div>

                        <div class="sidebar-filter-actions">
                            <button id="devices_reset_filters" class="ghost-btn" style="width:100%;">Reset Filters</button>
                        </div>
                    </div>
                </aside>

                <!-- Main devices content -->
                <main class="devices-main">
                    <div class="devices-main-header">
                        <div>
                            <h3 style="margin-bottom:4px;">Fleet Devices</h3>
                            <div class="muted-text">Monitor connectivity, alerts, and consumables across every agent.</div>
                        </div>
                        <div class="devices-main-actions">
                            <div class="view-toggle" id="devices_view_toggle" role="group" aria-label="Devices view">
                                <button class="ghost-btn active" data-view="cards">Cards</button>
                                <button class="ghost-btn" data-view="table">Table</button>
                            </div>
                        </div>
                    </div>

                    <div id="devices_overview_metrics" class="metrics-overview-grid compact" style="margin-bottom:12px;">
                        <div class="metric-card loading">Loading fleet metrics…</div>
                    </div>

                    <div id="devices_stats" class="devices-inline-stats"></div>

                    <div class="device-cards-container" id="devices_cards"></div>
                    <div id="devices_table_wrapper" class="hidden">
                        <div class="table-wrapper">
                            <table class="simple-table" id="devices_table">
                                <thead>
                                    <tr>
                                        <th data-sort-key="manufacturer">Device</th>
                                        <th data-sort-key="status">Status</th>
                                        <th data-sort-key="consumables">Consumables</th>
                                        <th data-sort-key="agent">Agent</th>
                                        <th data-sort-key="tenant">Tenant</th>
                                        <th data-sort-key="ip">Network</th>
                                        <th data-sort-key="location">Location</th>
                                        <th data-sort-key="last_seen">Last Seen</th>
                                        <th class="actions-col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="9" class="muted-text">Loading devices…</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Metrics Tab -->
        <div style="margin-top:12px;" data-tab="metrics" class="hidden">
            <div class="metrics-header">
                <div>
                    <h3 style="margin-bottom:4px;">Fleet Metrics <span id="metrics_live_indicator" class="live-indicator" title="Live updates active">● LIVE</span></h3>
                    <div class="muted-text">Netdata-style view of fleet throughput, health, and server stats.</div>
                </div>
                <div class="metrics-range-controls" id="metrics_range_controls">
                    <button class="ghost-btn" data-range="5m">5m</button>
                    <button class="ghost-btn" data-range="15m">15m</button>
                    <button class="ghost-btn" data-range="30m">30m</button>
                    <button class="ghost-btn" data-range="1h">1h</button>
                    <button class="ghost-btn" data-range="6h">6h</button>
                    <button class="ghost-btn" data-range="12h">12h</button>
                    <button class="ghost-btn" data-range="24h">24h</button>
                    <button class="ghost-btn" data-range="7d">7d</button>
                    <button class="ghost-btn" data-range="30d">30d</button>
                    <button class="ghost-btn" data-range="90d">90d</button>
                </div>
            </div>

            <div id="metrics_stats" class="metrics-overview-grid">
                <div class="metric-card loading">Loading fleet overview…</div>
            </div>

            <!-- Fleet Throughput Charts (full-width, Netdata-style) -->
            <div class="metrics-section" style="margin-top:16px;">
                <h4 style="margin:0 0 8px;color:var(--highlight);">Fleet Throughput</h4>
                <div id="metrics_chart_grid" class="metrics-charts-fullwidth">
                    <div class="metric-chart-card loading">Preparing charts…</div>
                </div>
            </div>

            <!-- Consumables History Charts (full-width, Netdata-style) -->
            <div class="metrics-section" style="margin-top:16px;">
                <h4 style="margin:0 0 8px;color:var(--highlight);">Consumables History</h4>
                <div id="metrics_consumables_charts" class="metrics-charts-fullwidth">
                    <div class="metric-chart-card loading">Loading consumables history…</div>
                </div>
            </div>

            <!-- Agent Fleet Charts (full-width, Netdata-style) -->
            <div class="metrics-section" style="margin-top:16px;">
                <h4 style="margin:0 0 8px;color:var(--highlight);">Agent Fleet</h4>
                <div id="metrics_agent_fleet_charts" class="metrics-charts-fullwidth">
                    <div class="metric-chart-card loading">Loading agent fleet data…</div>
                </div>
            </div>

            <!-- Server Runtime Charts (full-width, Netdata-style) -->
            <div class="metrics-section" style="margin-top:16px;">
                <h4 style="margin:0 0 8px;color:var(--highlight);">Server Runtime</h4>
                <div id="metrics_server_charts" class="metrics-charts-fullwidth">
                    <div class="metric-chart-card loading">Loading server metrics…</div>
                </div>
            </div>

            <div class="metrics-layout" style="margin-top:16px;">
                <div id="metrics_consumables" class="metric-card">
                    <div class="card-title">Consumables</div>
                    <div class="muted-text">Loading consumable data…</div>
                </div>
                <div class="metrics-side-panel" id="metrics_server_panel">
                    <div class="metric-card loading">Loading server stats…</div>
                </div>
            </div>

            <div id="metrics_activity" class="metric-card" style="margin-top:12px;">
                <div class="card-title">Activity Log</div>
                <div class="muted-text">Waiting for data…</div>
            </div>
        </div>

        <!-- Admin Tab (rendered dynamically) - consolidates Users, Access, Tenants, Fleet, Server, Audit -->
        <template id="tab-template-admin">
            <div style="margin-top:12px;" data-tab="admin" class="hidden">
                <h3>Administration</h3>

                <div class="subtab-bar" id="admin_subtab_bar">
                    <button class="subtab admin-subtab active" data-adminview="users">Users</button>
                    <button class="subtab admin-subtab" data-adminview="access">Access</button>
                    <button class="subtab admin-subtab" data-adminview="tenants">Tenants</button>
                    <button class="subtab admin-subtab" data-adminview="fleet">Fleet</button>
                    <button class="subtab admin-subtab" data-adminview="server">Server</button>
                    <button class="subtab admin-subtab" data-adminview="alertsconfig">Alerts</button>
                    <button class="subtab admin-subtab" data-adminview="audit">Audit</button>
                </div>

                <!-- Users Sub-tab -->
                <div class="admin-view-panel" data-adminview-panel="users">
                    <div class="users-header">
                        <div>
                            <p class="users-subtitle">Manage local users and permissions</p>
                        </div>
                        <div class="users-header-actions">
                            <button id="invite_user_btn" class="btn-outline" title="Invite user via email">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>
                                Invite
                            </button>
                            <button id="new_user_btn" class="btn-primary">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                New User
                            </button>
                        </div>
                    </div>
                    <div id="users_list">
                        <div class="users-loading">Loading users...</div>
                    </div>
                </div>

                <!-- Access Sub-tab (SSO, Roles, Sessions) -->
                <div class="admin-view-panel hidden" data-adminview-panel="access">
                    <div class="access-sections">
                        <!-- SSO Providers Section -->
                        <div class="panel">
                            <h4 style="margin-top:0;color:var(--highlight)">Single Sign-On (OIDC)</h4>
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="color:var(--muted);font-size:13px;max-width:520px;">
                                    Connect identity providers for the hosted login page. Providers can be tenant-specific or global.
                                </div>
                                <div>
                                    <button id="sso_add_provider_btn">Add Provider</button>
                                </div>
                            </div>
                            <div id="sso_providers_list" class="card" style="padding:12px;overflow:auto;">
                                <div class="muted-text">Loading identity providers…</div>
                            </div>
                        </div>

                        <!-- Roles Reference Section -->
                        <div class="panel" style="margin-top:16px;">
                            <h4 style="margin-top:0;color:var(--highlight)">Roles & Permissions</h4>
                            <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">
                                Reference for built-in role permissions. Custom roles coming soon.
                            </div>
                            <div id="roles_matrix" class="card" style="padding:12px;overflow:auto;">
                                <table class="roles-table">
                                    <thead>
                                        <tr>
                                            <th>Permission</th>
                                            <th>Admin</th>
                                            <th>Operator</th>
                                            <th>Viewer</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>View Agents & Devices</td><td>✓</td><td>✓</td><td>✓</td></tr>
                                        <tr><td>View Metrics & Logs</td><td>✓</td><td>✓</td><td>✓</td></tr>
                                        <tr><td>Manage Agents (edit, delete)</td><td>✓</td><td>✓</td><td></td></tr>
                                        <tr><td>Generate Installer Packages</td><td>✓</td><td>✓</td><td></td></tr>
                                        <tr><td>Access Agent/Device Proxy</td><td>✓</td><td>✓</td><td></td></tr>
                                        <tr><td>Manage Users & Sessions</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>Manage Tenants & Tokens</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>Configure SSO Providers</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>Modify Server Settings</td><td>✓</td><td></td><td></td></tr>
                                        <tr><td>View Audit Logs</td><td>✓</td><td></td><td></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Sessions Section -->
                        <div class="panel" style="margin-top:16px;">
                            <h4 style="margin-top:0;color:var(--highlight)">Active Sessions</h4>
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="color:var(--muted);font-size:13px;">
                                    View and revoke active user sessions.
                                </div>
                                <button id="sessions_refresh_btn" class="ghost-btn">Refresh</button>
                            </div>
                            <div id="sessions_list" class="card" style="padding:12px;overflow:auto;">
                                <div class="muted-text">Loading sessions…</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tenants Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="tenants">
                    <div class="tenants-view-panel" data-tenantsview-panel="directory">
                        <div class="sidebar-layout tenants-layout">
                            <!-- Sidebar with filters -->
                            <aside class="filter-sidebar tenants-sidebar">
                                <div class="filter-sidebar-header tenants-sidebar-header">
                                    <h4>Filters</h4>
                                    <button class="filter-sidebar-toggle tenants-sidebar-toggle" id="tenants_sidebar_toggle" title="Toggle sidebar">
                                        <span>◀</span>
                                    </button>
                                </div>
                                <div class="filter-sidebar-content tenants-sidebar-content">
                                    <div class="sidebar-filter-section">
                                        <!-- Search -->
                                        <div class="sidebar-filter-group">
                                            <label for="tenants_search">Search</label>
                                            <input type="text" id="tenants_search" placeholder="Name, contact, ID...">
                                        </div>
                                        
                                        <!-- Sort -->
                                        <div class="sidebar-filter-group">
                                            <label for="tenants_sort_select">Sort By</label>
                                            <div class="sort-row">
                                                <select id="tenants_sort_select">
                                                    <option value="name">Name</option>
                                                    <option value="created">Created Date</option>
                                                    <option value="contact">Contact Name</option>
                                                </select>
                                                <button id="tenants_sort_dir_btn" class="sort-dir-btn" title="Toggle sort direction">↑</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Reset -->
                                    <button id="tenants_reset_filters" class="ghost-btn" style="width:100%;margin-top:12px;">Reset Filters</button>
                                </div>
                            </aside>
                            
                            <!-- Main content -->
                            <main class="tenants-main">
                                <div class="tenants-main-header">
                                    <div>
                                        <span class="count-label">Total:</span> <span id="tenants_total_count">0</span>
                                        <span class="count-label" style="margin-left:12px;">Showing:</span> <span id="tenants_showing_count">0</span>
                                    </div>
                                    <div class="tenants-main-actions">
                                        <button id="new_tenant_btn">+ New Tenant</button>
                                    </div>
                                </div>
                                <div id="tenants_list">
                                    <div style="color:var(--muted);">Loading tenants...</div>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>

                <!-- Fleet Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="fleet">
                    <div class="managed-settings-grid">
                        <div class="panel" id="managed_settings_panel">
                            <h4 style="margin-top:0;color:var(--highlight)">Fleet Settings</h4>
                            <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">
                                Configure discovery, SNMP, and agent behavior pushed to all connected agents.
                            </div>
                            <div class="settings-scope-bar">
                                <div class="settings-scope-buttons">
                                    <button class="settings-scope-btn active" data-scope="global">Global Defaults</button>
                                    <button class="settings-scope-btn" data-scope="tenant">Tenant Overrides</button>
                                    <button class="settings-scope-btn" data-scope="agent">Agent Overrides</button>
                                </div>
                                <div class="settings-tenant-controls hidden" id="settings_tenant_controls">
                                    <label>
                                        <span>Tenant</span>
                                        <select id="settings_tenant_select"></select>
                                    </label>
                                    <button id="settings_reset_overrides_btn" class="ghost-btn">Clear Overrides</button>
                                </div>
                                <div class="settings-tenant-controls hidden" id="settings_agent_controls">
                                    <label>
                                        <span>Agent</span>
                                        <select id="settings_agent_select"></select>
                                    </label>
                                    <button id="settings_reset_agent_overrides_btn" class="ghost-btn">Clear Overrides</button>
                                </div>
                                <div class="settings-updated" id="settings_last_updated"></div>
                            </div>

                            <div id="settings_form_root" class="settings-form-root">
                                <div class="muted-text">Loading managed settings…</div>
                            </div>

                            <div class="settings-actions">
                                <div class="settings-status" id="settings_status"></div>
                                <div class="settings-action-buttons">
                                    <button id="settings_discard_btn" class="ghost-btn">Discard Changes</button>
                                    <button id="settings_save_btn" class="primary">Save Changes</button>
                                </div>
                            </div>
                        </div>

                        <div class="panel" id="settings_summary_panel">
                            <h4 id="settings_summary_title" style="margin-top:0;color:var(--highlight);">Management Summary</h4>
                            <div id="settings_override_list" class="muted-text">Select a tenant to view overrides.</div>
                        </div>
                    </div>

                    <!-- Agent Updates Section -->
                    <div class="panel" style="margin-top:16px;">
                        <h4 style="margin-top:0;color:var(--highlight)">Agent Updates</h4>
                        
                        <div id="agent_update_policy_root" class="settings-form-root" style="margin-bottom:16px;">
                            <div class="muted-text">Loading agent update policy…</div>
                        </div>

                        <div class="card" style="padding:16px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                                <div style="font-weight:600;font-size:14px;color:var(--highlight)">Cached Release Artifacts</div>
                                <div style="display:flex;gap:8px;">
                                    <button id="releases_sync_btn" class="ghost-btn">Sync from GitHub</button>
                                </div>
                            </div>
                            <div id="releases_artifacts_container" style="overflow:auto;">
                                <div class="muted-text">Loading cached artifacts…</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Server Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="server">
                    <div class="panel">
                        <h4 style="margin-top:0;color:var(--highlight)">Server Settings</h4>
                        <div style="color:var(--muted);font-size:13px;margin-bottom:12px;max-width:600px;">
                            Core configuration affecting this PrintMaster server instance.
                        </div>
                        <div id="server_settings_container" class="card" style="padding:12px;display:flex;flex-direction:column;gap:12px;">
                            <div class="muted-text">Loading server settings…</div>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:16px;">
                        <h4 style="margin-top:0;color:var(--highlight)">Server Updates</h4>
                        
                        <div id="selfupdate_status_card" class="card" style="padding:12px;margin-bottom:16px;">
                            <div class="muted-text">Loading status…</div>
                        </div>

                        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                            <div style="font-weight:600;font-size:14px;">Update History</div>
                            <div style="display:flex;gap:8px;">
                                <button id="selfupdate_refresh_btn" class="ghost-btn">Refresh</button>
                            </div>
                        </div>
                        <div id="selfupdate_runs_container" class="card" style="padding:12px;overflow:auto;">
                            <div class="muted-text">Loading update history…</div>
                        </div>
                    </div>
                </div>

                <!-- Audit Sub-tab -->
                <div class="admin-view-panel hidden" data-adminview-panel="audit">
                    <div class="panel log-panel">
                        <div class="log-controls audit-controls">
                            <div class="audit-filter-grid">
                                <label class="log-control column">
                                    <span>Time Range</span>
                                    <select id="audit_time_filter">
                                        <option value="24">Last 24h</option>
                                        <option value="168">Last 7 days</option>
                                        <option value="720">Last 30 days</option>
                                    </select>
                                </label>
                                <label class="log-control column">
                                    <span>Actor ID</span>
                                    <input type="text" id="audit_actor_filter" placeholder="Optional actor identifier" autocomplete="off" data-1p-ignore data-lpignore="true" />
                                </label>
                                <label class="log-control column">
                                    <span>Tenant</span>
                                    <input type="text" id="audit_tenant_filter" placeholder="Tenant ID or name" autocomplete="off" data-1p-ignore data-lpignore="true" />
                                </label>
                                <label class="log-control column">
                                    <span>Action</span>
                                    <input type="text" id="audit_action_filter" list="audit_action_suggestions" placeholder="Filter by action keyword" autocomplete="off" data-1p-ignore data-lpignore="true" />
                                    <datalist id="audit_action_suggestions"></datalist>
                                </label>
                                <label class="log-control column">
                                    <span>Search</span>
                                    <input type="text" id="audit_search_filter" placeholder="Search actor, target, IP, metadata..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                                </label>
                                <div class="audit-severity-group">
                                    <span>Severity</span>
                                    <div class="audit-severity-options" id="audit_severity_filter">
                                        <label class="audit-severity-pill">
                                            <input type="checkbox" class="audit-severity-option" value="error" checked />
                                            <span>Error</span>
                                        </label>
                                        <label class="audit-severity-pill">
                                            <input type="checkbox" class="audit-severity-option" value="warn" checked />
                                            <span>Warning</span>
                                        </label>
                                        <label class="audit-severity-pill">
                                            <input type="checkbox" class="audit-severity-option" value="info" checked />
                                            <span>Info</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="audit-controls-row">
                                <label class="log-control">
                                    <input type="checkbox" id="audit_live_toggle" /> Auto-refresh (15s)
                                </label>
                                <div class="audit-controls-actions">
                                    <button class="ghost-btn" id="audit_clear_filters_btn">Reset Filters</button>
                                    <button id="refresh_audit_logs_btn">Refresh</button>
                                </div>
                            </div>
                            <div class="audit-summary" id="audit_summary" hidden>
                                <span id="audit_summary_counts">0 entries</span>
                                <span id="audit_summary_updated">Updated just now</span>
                                <span id="audit_live_status" class="audit-live-status">Auto-refresh off</span>
                            </div>
                        </div>
                        <div id="audit_logs_table" class="table-wrapper">
                            <div class="muted-text">Loading audit entries...</div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Config Sub-tab (admin-only alert rule management) -->
                <div class="admin-view-panel hidden" data-adminview-panel="alertsconfig">
                    <!-- Quick Stats Summary -->
                    <div class="alerts-quick-stats" id="alerts_config_stats">
                        <div class="alerts-quick-stat">
                            <div class="alerts-quick-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                            </div>
                            <div class="alerts-quick-stat-content">
                                <span class="alerts-quick-stat-value" id="stat_rules_count">0</span>
                                <span class="alerts-quick-stat-label">Alert Rules</span>
                            </div>
                        </div>
                        <div class="alerts-quick-stat">
                            <div class="alerts-quick-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/></svg>
                            </div>
                            <div class="alerts-quick-stat-content">
                                <span class="alerts-quick-stat-value" id="stat_channels_count">0</span>
                                <span class="alerts-quick-stat-label">Channels</span>
                            </div>
                        </div>
                        <div class="alerts-quick-stat">
                            <div class="alerts-quick-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M4.978.855a.5.5 0 1 0-.956.29l.41 1.352A4.985 4.985 0 0 0 3 6h10a4.985 4.985 0 0 0-1.432-3.503l.41-1.352a.5.5 0 1 0-.956-.29l-.291.956A4.978 4.978 0 0 0 8 1a4.979 4.979 0 0 0-2.731.811l-.29-.956z"/><path d="M13 6v1H3V6h10zm-1 4a4.5 4.5 0 0 1-9 0V7h9v3z"/></svg>
                            </div>
                            <div class="alerts-quick-stat-content">
                                <span class="alerts-quick-stat-value" id="stat_policies_count">0</span>
                                <span class="alerts-quick-stat-label">Policies</span>
                            </div>
                        </div>
                        <div class="alerts-quick-stat">
                            <div class="alerts-quick-stat-icon" style="background:rgba(203, 75, 22, 0.15);color:var(--warning);">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>
                            </div>
                            <div class="alerts-quick-stat-content">
                                <span class="alerts-quick-stat-value" id="stat_windows_count">0</span>
                                <span class="alerts-quick-stat-label">Maintenance</span>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Rules Section -->
                    <div class="alerts-section" id="alert_rules_section">
                        <div class="alerts-section-header" onclick="toggleAlertsSection('alert_rules_section')">
                            <div class="alerts-section-title">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                                Alert Rules
                                <span class="alerts-section-badge" id="alert_rules_badge">0</span>
                            </div>
                            <div class="alerts-section-actions">
                                <button id="new_alert_rule_btn" class="btn-primary btn-sm" onclick="event.stopPropagation();">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                    New Rule
                                </button>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="alerts-section-content">
                            <p class="muted-text" style="margin:0 0 16px 0;font-size:13px;">Configure alert thresholds by scope (device, agent, site, tenant, fleet). Rules trigger notifications when conditions are met.</p>
                            <div id="alert_rules_list">
                                <div class="config-empty-state">
                                    <div class="config-empty-state-icon">
                                        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                                    </div>
                                    <div class="config-empty-state-title">No alert rules configured</div>
                                    <div class="config-empty-state-text">Create your first alert rule to start monitoring devices, agents, and fleet health.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Channels Section -->
                    <div class="alerts-section" id="notification_channels_section">
                        <div class="alerts-section-header" onclick="toggleAlertsSection('notification_channels_section')">
                            <div class="alerts-section-title">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/></svg>
                                Notification Channels
                                <span class="alerts-section-badge" id="channels_badge">0</span>
                            </div>
                            <div class="alerts-section-actions">
                                <button id="new_notification_channel_btn" class="btn-outline btn-sm" onclick="event.stopPropagation();">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                    Add Channel
                                </button>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="alerts-section-content">
                            <p class="muted-text" style="margin:0 0 16px 0;font-size:13px;">Configure where alert notifications are sent (email, webhook, Slack, Teams, etc.).</p>
                            <div id="notification_channels_list">
                                <div class="config-empty-state">
                                    <div class="config-empty-state-icon">
                                        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2z"/></svg>
                                    </div>
                                    <div class="config-empty-state-title">No notification channels configured</div>
                                    <div class="config-empty-state-text">Add a channel to receive alerts via email, Slack, Teams, and more.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Escalation Policies Section -->
                    <div class="alerts-section" id="escalation_policies_section">
                        <div class="alerts-section-header" onclick="toggleAlertsSection('escalation_policies_section')">
                            <div class="alerts-section-title">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M4.978.855a.5.5 0 1 0-.956.29l.41 1.352A4.985 4.985 0 0 0 3 6h10a4.985 4.985 0 0 0-1.432-3.503l.41-1.352a.5.5 0 1 0-.956-.29l-.291.956A4.978 4.978 0 0 0 8 1a4.979 4.979 0 0 0-2.731.811l-.29-.956z"/><path d="M13 6v1H3V6h10zm-1 4a4.5 4.5 0 0 1-9 0V7h9v3z"/></svg>
                                Escalation Policies
                                <span class="alerts-section-badge" id="policies_badge">0</span>
                            </div>
                            <div class="alerts-section-actions">
                                <button id="new_escalation_policy_btn" class="btn-outline btn-sm" onclick="event.stopPropagation();">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                    New Policy
                                </button>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="alerts-section-content">
                            <p class="muted-text" style="margin:0 0 16px 0;font-size:13px;">Escalate unacknowledged alerts after a time threshold. Increase severity or notify additional channels.</p>
                            <div id="escalation_policies_list">
                                <div class="config-empty-state">
                                    <div class="config-empty-state-icon">
                                        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor"><path d="M4.978.855a.5.5 0 1 0-.956.29l.41 1.352A4.985 4.985 0 0 0 3 6h10a4.985 4.985 0 0 0-1.432-3.503l.41-1.352a.5.5 0 1 0-.956-.29l-.291.956A4.978 4.978 0 0 0 8 1a4.979 4.979 0 0 0-2.731.811l-.29-.956z"/><path d="M13 6v1H3V6h10zm-1 4a4.5 4.5 0 0 1-9 0V7h9v3z"/></svg>
                                    </div>
                                    <div class="config-empty-state-title">No escalation policies configured</div>
                                    <div class="config-empty-state-text">Create policies to automatically escalate alerts that aren't acknowledged.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Behavior Settings -->
                    <div class="alert-config-row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(340px, 1fr));gap:16px;margin-top:16px;">
                        <!-- Suppression / Maintenance Windows -->
                        <div class="alerts-section" id="maintenance_windows_section" style="margin-bottom:0;">
                            <div class="alerts-section-header" onclick="toggleAlertsSection('maintenance_windows_section')">
                                <div class="alerts-section-title">
                                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>
                                    Maintenance Windows
                                    <span class="alerts-section-badge" id="windows_badge">0</span>
                                </div>
                                <div class="alerts-section-actions">
                                    <button id="new_maintenance_window_btn" class="btn-outline btn-sm" onclick="event.stopPropagation();">
                                        <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                        Schedule
                                    </button>
                                    <button class="alerts-section-toggle" title="Toggle section">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="alerts-section-content">
                                <p class="muted-text" style="margin:0 0 12px 0;font-size:12px;">Suppress alerts during scheduled maintenance periods.</p>
                                <div id="maintenance_windows_list">
                                    <div class="muted-text" style="padding:20px;text-align:center;">No maintenance windows scheduled.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quiet Hours -->
                        <div class="alerts-section" id="quiet_hours_section" style="margin-bottom:0;">
                            <div class="alerts-section-header" onclick="toggleAlertsSection('quiet_hours_section')">
                                <div class="alerts-section-title">
                                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>
                                    Quiet Hours
                                </div>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                            <div class="alerts-section-content">
                                <p class="muted-text" style="margin:0 0 12px 0;font-size:12px;">Suppress notifications during specified hours. Alerts are still logged but not sent.</p>
                                <div class="quiet-hours-config">
                                    <label class="field inline-check" style="margin-bottom:12px;">
                                        <input type="checkbox" id="quiet_hours_enabled" />
                                        <span>Enable Quiet Hours</span>
                                    </label>
                                    <div class="quiet-hours-times" id="quiet_hours_times" style="display:none;">
                                        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                                            <label class="field">
                                                <span>Start</span>
                                                <input type="time" id="quiet_hours_start" value="22:00" />
                                            </label>
                                            <label class="field">
                                                <span>End</span>
                                                <input type="time" id="quiet_hours_end" value="07:00" />
                                            </label>
                                            <label class="field">
                                                <span>Timezone</span>
                                                <select id="quiet_hours_timezone">
                                                    <option value="local">Local Time</option>
                                                    <option value="UTC">UTC</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div style="margin-top:8px;">
                                            <label class="field inline-check">
                                                <input type="checkbox" id="quiet_hours_critical_override" checked />
                                                <span>Allow critical alerts during quiet hours</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Flapping Detection & Alert Grouping -->
                    <div class="alert-config-row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(340px, 1fr));gap:16px;margin-top:16px;">
                        <!-- Flapping Detection -->
                        <div class="alerts-section" id="flapping_section" style="margin-bottom:0;">
                            <div class="alerts-section-header" onclick="toggleAlertsSection('flapping_section')">
                                <div class="alerts-section-title">
                                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/></svg>
                                    Flapping Detection
                                </div>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                            <div class="alerts-section-content">
                                <p class="muted-text" style="margin:0 0 12px 0;font-size:12px;">Suppress alerts for resources that rapidly change state (online/offline cycling).</p>
                                <label class="field inline-check" style="margin-bottom:12px;">
                                    <input type="checkbox" id="flapping_detection_enabled" checked />
                                    <span>Enable Flapping Detection</span>
                                </label>
                                <div class="flapping-config" id="flapping_config">
                                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                                        <label class="field">
                                            <span>State changes</span>
                                            <input type="number" id="flapping_threshold" value="5" min="2" max="20" style="width:80px;" />
                                        </label>
                                        <label class="field">
                                            <span>Within (minutes)</span>
                                            <input type="number" id="flapping_window" value="10" min="1" max="60" style="width:80px;" />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alert Grouping -->
                        <div class="alerts-section" id="grouping_section" style="margin-bottom:0;">
                            <div class="alerts-section-header" onclick="toggleAlertsSection('grouping_section')">
                                <div class="alerts-section-title">
                                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/></svg>
                                    Alert Grouping
                                </div>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                            <div class="alerts-section-content">
                                <p class="muted-text" style="margin:0 0 12px 0;font-size:12px;">Collapse related alerts into parent alerts (e.g., 10 device alerts → 1 site alert).</p>
                                <label class="field inline-check" style="margin-bottom:12px;">
                                    <input type="checkbox" id="alert_grouping_enabled" checked />
                                    <span>Enable Alert Grouping</span>
                                </label>
                                <div class="grouping-config" id="grouping_config">
                                    <label class="field">
                                        <span>Group threshold (% of scope)</span>
                                        <input type="number" id="grouping_threshold" value="50" min="10" max="100" style="width:80px;" />
                                </label>
                                <div style="color:var(--muted);font-size:12px;margin-top:4px;">
                                    When >50% of devices at a site alert, show as "Site Degraded" instead of individual alerts.
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Dependencies -->
                    <div class="alerts-section" id="dependencies_section" style="margin-top:16px;">
                        <div class="alerts-section-header" onclick="toggleAlertsSection('dependencies_section')">
                            <div class="alerts-section-title">
                                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M0 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V2zm3 0H1v2h2V2zm9 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zm3 0h-2v2h2V2zM0 8a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V8zm3 0H1v2h2V8zm9 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V8zm3 0h-2v2h2V8zM0 14a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1v-1zm3 0H1v1h2v-1zm9 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1zm3 0h-2v1h2v-1z"/><path d="M8 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13A.5.5 0 0 1 8 1z"/><path d="M8 1a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 1zM4 5h8v1H4V5z"/></svg>
                                Alert Dependencies
                            </div>
                            <div class="alerts-section-actions">
                                <label class="field inline-check" style="margin:0;" onclick="event.stopPropagation();">
                                    <input type="checkbox" id="alert_dependencies_enabled" checked />
                                    <span style="font-size:12px;">Enable</span>
                                </label>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="alerts-section-content">
                            <p class="muted-text" style="margin:0 0 16px 0;font-size:13px;">Suppress downstream alerts when parent resources are down. For example, if an agent is offline, suppress device alerts for that agent's devices.</p>
                            <div class="dependency-rules">
                                <div class="dependency-rule-item">
                                    <div class="dependency-icon">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
                                    </div>
                                    <div class="dependency-rule-content">
                                        <span class="dependency-rule-title">Agent offline → suppress device alerts</span>
                                        <span class="dependency-rule-desc">When an agent goes offline, device alerts for that agent are suppressed</span>
                                    </div>
                                    <span class="dependency-status enabled">Active</span>
                                </div>
                                <div class="dependency-rule-item">
                                    <div class="dependency-icon">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
                                    </div>
                                    <div class="dependency-rule-content">
                                        <span class="dependency-rule-title">Site outage → suppress agent &amp; device alerts</span>
                                        <span class="dependency-rule-desc">When a site is down, all agent and device alerts for that site are suppressed</span>
                                    </div>
                                    <span class="dependency-status enabled">Active</span>
                                </div>
                                <div class="dependency-rule-item">
                                    <div class="dependency-icon">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
                                    </div>
                                    <div class="dependency-rule-content">
                                        <span class="dependency-rule-title">Tenant outage → suppress site, agent &amp; device alerts</span>
                                        <span class="dependency-rule-desc">When a tenant is down, all downstream alerts are suppressed</span>
                                    </div>
                                    <span class="dependency-status enabled">Active</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Scheduling Section -->
                    <div class="alerts-section" id="report_scheduling_section" style="margin-top:16px;">
                        <div class="alerts-section-header" onclick="toggleAlertsSection('report_scheduling_section')">
                            <div class="alerts-section-title">
                                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0V7zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0V9z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                                Report Scheduling
                                <span class="alerts-section-badge" id="schedules_badge">0</span>
                            </div>
                            <div class="alerts-section-actions">
                                <button id="new_scheduled_report_btn" class="btn-outline btn-sm" onclick="event.stopPropagation();">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                    New Schedule
                                </button>
                                <button class="alerts-section-toggle" title="Toggle section">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="alerts-section-content">
                            <p class="muted-text" style="margin:0 0 16px 0;font-size:13px;">Schedule automated reports for fleet status, usage summaries, and supply levels.</p>
                            <div id="scheduled_reports_list">
                                <div class="config-empty-state">
                                    <div class="config-empty-state-icon">
                                        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor"><path d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0V7zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0V9z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/></svg>
                                    </div>
                                    <div class="config-empty-state-title">No scheduled reports</div>
                                    <div class="config-empty-state-text">Create a schedule to automatically generate and send reports.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Alerts Tab (viewable by operators - summary, active alerts, history, reports) -->
        <template id="tab-template-alerts">
            <div style="margin-top:12px;" data-tab="alerts" class="hidden">
                <h3>Alerts & Reports</h3>

                <div class="subtab-bar" id="alerts_subtab_bar">
                    <button class="subtab alerts-subtab active" data-alertsview="summary">Summary</button>
                    <button class="subtab alerts-subtab" data-alertsview="active">Active Alerts</button>
                    <button class="subtab alerts-subtab" data-alertsview="history">History</button>
                    <button class="subtab alerts-subtab" data-alertsview="reports">Reports</button>
                </div>

                <!-- Alert Summary Sub-tab (dashboard view) -->
                <div class="alerts-view-panel" data-alertsview-panel="summary">
                    <!-- Fleet Health Overview -->
                    <div class="alert-summary-section">
                        <h4 class="alert-summary-title">Fleet Health</h4>
                        <div class="alert-summary-grid">
                            <div class="alert-summary-card healthy" id="summary_healthy_card">
                                <div class="summary-card-icon">
                                    <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                    </svg>
                                </div>
                                <div class="summary-card-content">
                                    <div class="summary-card-value" id="summary_healthy_count">0</div>
                                    <div class="summary-card-label">Healthy</div>
                                </div>
                            </div>
                            <div class="alert-summary-card warning" id="summary_warning_card">
                                <div class="summary-card-icon">
                                    <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                    </svg>
                                </div>
                                <div class="summary-card-content">
                                    <div class="summary-card-value" id="summary_warning_count">0</div>
                                    <div class="summary-card-label">Warnings</div>
                                </div>
                            </div>
                            <div class="alert-summary-card critical" id="summary_critical_card">
                                <div class="summary-card-icon">
                                    <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146zM8 4c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                    </svg>
                                </div>
                                <div class="summary-card-content">
                                    <div class="summary-card-value" id="summary_critical_count">0</div>
                                    <div class="summary-card-label">Critical</div>
                                </div>
                            </div>
                            <div class="alert-summary-card offline" id="summary_offline_card">
                                <div class="summary-card-icon">
                                    <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M10.706 3.294A12.545 12.545 0 0 0 8 3C5.259 3 2.723 3.882.663 5.379a.485.485 0 0 0-.048.736.518.518 0 0 0 .668.05A11.448 11.448 0 0 1 8 4c.63 0 1.249.05 1.852.148l.854-.854zM8 6c-1.905 0-3.68.56-5.166 1.526a.48.48 0 0 0-.063.745.525.525 0 0 0 .652.065 8.448 8.448 0 0 1 3.51-1.27L8 6zm2.596 1.404.785-.785c.63.24 1.227.545 1.785.907a.482.482 0 0 1 .063.745.525.525 0 0 1-.652.065 8.462 8.462 0 0 0-1.98-.932zM8 10l.933-.933a6.455 6.455 0 0 1 2.013.637c.285.145.326.524.1.75l-.015.015a.532.532 0 0 1-.611.09A5.478 5.478 0 0 0 8 10zm4.905-4.905.747-.747c.59.3 1.153.645 1.685 1.03a.485.485 0 0 1 .047.737.518.518 0 0 1-.668.05 11.493 11.493 0 0 0-1.811-1.07zM9.02 11.78c.238.14.236.464.04.66l-.707.706a.5.5 0 0 1-.707 0l-.707-.707c-.195-.195-.197-.518.04-.66A1.99 1.99 0 0 1 8 11.5c.374 0 .723.102 1.021.28zm4.355-9.905a.53.53 0 0 1 .75.75l-10.75 10.75a.53.53 0 0 1-.75-.75l10.75-10.75z"/>
                                    </svg>
                                </div>
                                <div class="summary-card-content">
                                    <div class="summary-card-value" id="summary_offline_count">0</div>
                                    <div class="summary-card-label">Offline</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scope-level Status -->
                    <div class="alert-summary-row">
                        <div class="alert-summary-section flex-1">
                            <h4 class="alert-summary-title">By Scope</h4>
                            <div class="scope-status-grid">
                                <div class="scope-status-item">
                                    <span class="scope-label">Devices</span>
                                    <div class="scope-bar-container">
                                        <div class="scope-bar" id="scope_bar_devices" style="--healthy:100%;--warning:0%;--critical:0%;"></div>
                                    </div>
                                    <span class="scope-count" id="scope_count_devices">0 / 0</span>
                                </div>
                                <div class="scope-status-item">
                                    <span class="scope-label">Agents</span>
                                    <div class="scope-bar-container">
                                        <div class="scope-bar" id="scope_bar_agents" style="--healthy:100%;--warning:0%;--critical:0%;"></div>
                                    </div>
                                    <span class="scope-count" id="scope_count_agents">0 / 0</span>
                                </div>
                                <div class="scope-status-item">
                                    <span class="scope-label">Sites</span>
                                    <div class="scope-bar-container">
                                        <div class="scope-bar" id="scope_bar_sites" style="--healthy:100%;--warning:0%;--critical:0%;"></div>
                                    </div>
                                    <span class="scope-count" id="scope_count_sites">0 / 0</span>
                                </div>
                                <div class="scope-status-item">
                                    <span class="scope-label">Tenants</span>
                                    <div class="scope-bar-container">
                                        <div class="scope-bar" id="scope_bar_tenants" style="--healthy:100%;--warning:0%;--critical:0%;"></div>
                                    </div>
                                    <span class="scope-count" id="scope_count_tenants">0 / 0</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert-summary-section flex-1">
                            <h4 class="alert-summary-title">Alert Breakdown</h4>
                            <div class="alert-type-breakdown" id="alert_type_breakdown">
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Supply Low</span>
                                    <span class="breakdown-value" id="breakdown_supply">0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Device Offline</span>
                                    <span class="breakdown-value" id="breakdown_device_offline">0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Agent Offline</span>
                                    <span class="breakdown-value" id="breakdown_agent_offline">0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Site Outage</span>
                                    <span class="breakdown-value" id="breakdown_site_outage">0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Usage Threshold</span>
                                    <span class="breakdown-value" id="breakdown_usage">0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Errors</span>
                                    <span class="breakdown-value" id="breakdown_errors">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Alerts & Suppression Status -->
                    <div class="alert-summary-row">
                        <div class="alert-summary-section flex-2">
                            <div class="summary-section-header">
                                <h4 class="alert-summary-title">Recent Alerts</h4>
                                <a href="#" class="summary-link" id="view_all_alerts_link">View All →</a>
                            </div>
                            <div id="recent_alerts_summary" class="recent-alerts-list">
                                <div class="muted-text">No recent alerts</div>
                            </div>
                        </div>

                        <div class="alert-summary-section flex-1">
                            <h4 class="alert-summary-title">Status</h4>
                            <div class="alert-status-info">
                                <div class="status-info-item">
                                    <span class="status-dot" id="status_dot_suppression"></span>
                                    <span>Alert Suppression</span>
                                    <span class="status-value" id="status_suppression">Inactive</span>
                                </div>
                                <div class="status-info-item">
                                    <span class="status-dot active" id="status_dot_monitoring"></span>
                                    <span>Monitoring</span>
                                    <span class="status-value" id="status_monitoring">Active</span>
                                </div>
                                <div class="status-info-item">
                                    <span class="status-dot" id="status_dot_quiet"></span>
                                    <span>Quiet Hours</span>
                                    <span class="status-value" id="status_quiet_hours">Off</span>
                                </div>
                                <div class="status-info-item">
                                    <span>Active Rules</span>
                                    <span class="status-value" id="status_active_rules">0</span>
                                </div>
                                <div class="status-info-item">
                                    <span>Notification Channels</span>
                                    <span class="status-value" id="status_channels">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Alerts Sub-tab -->
                <div class="alerts-view-panel hidden" data-alertsview-panel="active">
                    <div class="alerts-overview-grid" id="alerts_overview_metrics">
                        <div class="metric-card alert-metric-card critical">
                            <div class="metric-value" id="alerts_critical_count">0</div>
                            <div class="metric-label">Critical</div>
                        </div>
                        <div class="metric-card alert-metric-card warning">
                            <div class="metric-value" id="alerts_warning_count">0</div>
                            <div class="metric-label">Warning</div>
                        </div>
                        <div class="metric-card alert-metric-card info">
                            <div class="metric-value" id="alerts_info_count">0</div>
                            <div class="metric-label">Info</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="alerts_acknowledged_count">0</div>
                            <div class="metric-label">Acknowledged</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="alerts_suppressed_count">0</div>
                            <div class="metric-label">Suppressed</div>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:16px;">
                        <div class="alerts-toolbar">
                            <div class="alerts-toolbar-left">
                                <label class="field">
                                    <span>Severity</span>
                                    <select id="alerts_severity_filter">
                                        <option value="">All</option>
                                        <option value="critical">Critical</option>
                                        <option value="warning">Warning</option>
                                        <option value="info">Info</option>
                                    </select>
                                </label>
                                <label class="field">
                                    <span>Scope</span>
                                    <select id="alerts_scope_filter">
                                        <option value="">All Scopes</option>
                                        <option value="device">Device</option>
                                        <option value="agent">Agent</option>
                                        <option value="site">Site</option>
                                        <option value="tenant">Tenant</option>
                                        <option value="fleet">Fleet</option>
                                    </select>
                                </label>
                                <label class="field">
                                    <span>Type</span>
                                    <select id="alerts_type_filter">
                                        <option value="">All Types</option>
                                        <optgroup label="Device Alerts">
                                            <option value="device.supply.low">Supply Low</option>
                                            <option value="device.supply.critical">Supply Critical</option>
                                            <option value="device.offline">Device Offline</option>
                                            <option value="device.error">Device Error</option>
                                            <option value="device.usage.high">High Usage</option>
                                            <option value="device.usage.spike">Usage Spike</option>
                                        </optgroup>
                                        <optgroup label="Agent Alerts">
                                            <option value="agent.offline">Agent Offline</option>
                                            <option value="agent.unhealthy">Agent Unhealthy</option>
                                            <option value="agent.update.failed">Update Failed</option>
                                            <option value="agent.version.outdated">Version Outdated</option>
                                            <option value="agent.storage.full">Storage Full</option>
                                        </optgroup>
                                        <optgroup label="Site Alerts">
                                            <option value="site.outage">Site Outage</option>
                                            <option value="site.partial_outage">Partial Outage</option>
                                            <option value="site.degraded">Site Degraded</option>
                                        </optgroup>
                                        <optgroup label="Tenant Alerts">
                                            <option value="tenant.outage">Tenant Outage</option>
                                            <option value="tenant.partial_outage">Partial Outage</option>
                                            <option value="tenant.no_data">No Data</option>
                                        </optgroup>
                                        <optgroup label="Fleet Alerts">
                                            <option value="fleet.mass_outage">Mass Outage</option>
                                            <option value="fleet.update.stalled">Update Stalled</option>
                                        </optgroup>
                                    </select>
                                </label>
                                <label class="field">
                                    <span>Tenant</span>
                                    <select id="alerts_tenant_filter">
                                        <option value="">All Tenants</option>
                                    </select>
                                </label>
                            </div>
                            <div class="alerts-toolbar-right">
                                <button id="acknowledge_selected_btn" class="btn-outline" disabled>Acknowledge Selected</button>
                                <button id="suppress_selected_btn" class="btn-outline" disabled>Suppress</button>
                                <button id="refresh_alerts_btn" class="ghost-btn">Refresh</button>
                            </div>
                        </div>
                        <div id="active_alerts_list" class="alerts-list">
                            <div class="alerts-empty-state">
                                <svg width="48" height="48" viewBox="0 0 16 16" fill="var(--success)">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                </svg>
                                <div class="alerts-empty-title">All Clear</div>
                                <div class="alerts-empty-text">No active alerts at this time. Configure alert rules in Admin → Alerts.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alert History Sub-tab -->
                <div class="alerts-view-panel hidden" data-alertsview-panel="history">
                    <div class="panel">
                        <div class="alerts-toolbar">
                            <div class="alerts-toolbar-left">
                                <label class="field">
                                    <span>Time Range</span>
                                    <select id="alerts_history_time_filter">
                                        <option value="24">Last 24 hours</option>
                                        <option value="168">Last 7 days</option>
                                        <option value="720">Last 30 days</option>
                                        <option value="2160">Last 90 days</option>
                                    </select>
                                </label>
                                <label class="field">
                                    <span>Status</span>
                                    <select id="alerts_history_status_filter">
                                        <option value="">All</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="acknowledged">Acknowledged</option>
                                        <option value="suppressed">Suppressed</option>
                                        <option value="escalated">Escalated</option>
                                        <option value="expired">Expired</option>
                                    </select>
                                </label>
                                <label class="field">
                                    <span>Scope</span>
                                    <select id="alerts_history_scope_filter">
                                        <option value="">All Scopes</option>
                                        <option value="device">Device</option>
                                        <option value="agent">Agent</option>
                                        <option value="site">Site</option>
                                        <option value="tenant">Tenant</option>
                                        <option value="fleet">Fleet</option>
                                    </select>
                                </label>
                                <label class="field">
                                    <span>Search</span>
                                    <input type="text" id="alerts_history_search" placeholder="Search alerts..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                                </label>
                            </div>
                            <div class="alerts-toolbar-right">
                                <button id="export_history_btn" class="btn-outline">Export CSV</button>
                            </div>
                        </div>
                        <div id="alerts_history_container" class="alert-history-table-container">
                            <table class="alert-history-table" id="alerts_history_table">
                                <thead>
                                    <tr>
                                        <th class="ah-col-time">Triggered</th>
                                        <th class="ah-col-severity">Severity</th>
                                        <th class="ah-col-title">Alert</th>
                                        <th class="ah-col-scope">Scope</th>
                                        <th class="ah-col-duration">Duration</th>
                                        <th class="ah-col-resolved">Resolved</th>
                                    </tr>
                                </thead>
                                <tbody id="alerts_history_body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Sub-tab -->
                <div class="alerts-view-panel hidden" data-alertsview-panel="reports">
                    <div class="reports-grid">
                        <div class="panel report-card">
                            <h4 style="margin-top:0;color:var(--highlight)">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
                                    <path d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0V7zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0V9z"/>
                                    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                                </svg>
                                Fleet Status
                            </h4>
                            <p class="muted-text">Overview of all agents and devices with current status.</p>
                            <button class="btn-outline" id="generate_fleet_report_btn">Generate Report</button>
                        </div>
                        <div class="panel report-card">
                            <h4 style="margin-top:0;color:var(--highlight)">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
                                    <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/>
                                </svg>
                                Usage Audit
                            </h4>
                            <p class="muted-text">Page counts, print volumes, and usage trends by device.</p>
                            <div style="display:flex;gap:8px;align-items:center;margin:8px 0 12px;">
                                <label class="muted-text" style="font-size:12px;">Range</label>
                                <select id="usage_report_range" style="flex:1;min-width:0;">
                                    <option value="current">Current</option>
                                    <option value="last_7d">Last week</option>
                                    <option value="last_30d" selected>Last month</option>
                                    <option value="custom_365d">Last year</option>
                                </select>
                            </div>
                            <button class="btn-outline" id="generate_usage_report_btn">Generate Report</button>
                        </div>
                        <div class="panel report-card">
                            <h4 style="margin-top:0;color:var(--highlight)">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
                                    <path d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1H2zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                </svg>
                                Supply Levels
                            </h4>
                            <p class="muted-text">Toner, ink, and consumable levels across the fleet.</p>
                            <button class="btn-outline" id="generate_supply_report_btn">Generate Report</button>
                        </div>
                        <div class="panel report-card">
                            <h4 style="margin-top:0;color:var(--highlight)">
                                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
                                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                </svg>
                                Alert History
                            </h4>
                            <p class="muted-text">Historical alert data with trends and resolution times.</p>
                            <button class="btn-outline" id="generate_alert_report_btn">Generate Report</button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:16px;">
                        <h4 style="margin-top:0;color:var(--highlight)">Recent Reports</h4>
                        <div id="recent_reports_list" class="table-wrapper">
                            <div class="muted-text">No reports generated yet.</div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Logs Tab (System logs only - Audit moved to Admin) -->
        <div class="hidden" style="margin-top:12px;" data-tab="logs">
            <h3>System Logs</h3>

            <div class="panel log-panel">
                <div class="log-controls">
                    <div class="log-view-toggle">
                        <button class="log-view-btn active" data-log-view-mode="table" title="Table View">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v1h14V2a1 1 0 0 0-1-1H2zM1 5v.5h6V5H1zm7 0v.5h7V5H8zM1 7v.5h6V7H1zm7 0v.5h7V7H8zM1 9v.5h6V9H1zm7 0v.5h7V9H8zM1 11v.5h6V11H1zm7 0v.5h7V11H8z"/>
                            </svg>
                        </button>
                        <button class="log-view-btn" data-log-view-mode="raw" title="Raw View">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
                            </svg>
                        </button>
                    </div>
                    <label class="log-control"><input type="checkbox" id="pause_autoscroll" /> Pause auto-scroll</label>
                    <select id="log_level_filter">
                        <option value="">All Levels</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARN">WARN</option>
                        <option value="INFO">INFO</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="TRACE">TRACE</option>
                    </select>
                    <input type="text" id="log_search_filter" placeholder="Search logs..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                    <button id="copy_logs_btn">Copy Logs</button>
                    <button id="download_logs_btn">Download Logs</button>
                    <button id="clear_log_btn">Clear Log</button>
                </div>
                <div id="log_table_container" class="log-table-container">
                    <table class="log-table" id="log_table">
                        <thead>
                            <tr>
                                <th class="log-col-time">Time</th>
                                <th class="log-col-level">Level</th>
                                <th class="log-col-message">Message</th>
                                <th class="log-col-context">Context</th>
                            </tr>
                        </thead>
                        <tbody id="log_table_body"></tbody>
                    </table>
                </div>
                <pre id="log" class="hidden"></pre>
            </div>
        </div>

    </div> <!-- End content-container -->

    <!-- Toast notification container -->
    <div class="toast-container" id="toast_container"></div>

    <!-- Login Modal -->
    <div class="modal" id="login_modal" style="display:none;">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <span class="modal-title">Sign In</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:8px;color:var(--muted);">Sign in to access PrintMaster.</div>
                <label style="display:block;margin-bottom:6px;">Username</label>
                <input id="login_username" type="text" style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid var(--border);" />
                <label style="display:block;margin-bottom:6px;">Password</label>
                <input id="login_password" type="password" style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid var(--border);" />
                <div id="login_error" style="color:var(--danger);display:none;margin-bottom:8px;font-size:13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="login_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="login_submit">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm_modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="confirm_modal_title">Confirm Action</span>
                <span class="modal-close" id="confirm_modal_close_x">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirm_modal_message">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="confirm_modal_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="confirm_modal_confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div class="modal" id="agent_details_modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span class="modal-title" id="agent_details_title">Agent Details</span>
                <span class="modal-close" id="agent_details_close_x">&times;</span>
            </div>
            <div class="modal-body" id="agent_details_body" style="max-height: 500px; overflow-y: auto;">
                <div style="color:var(--muted);">Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="agent_details_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Printer Details modal with overlay (shared) -->
    <div id="printer_details_overlay" class="modal" style="display:none;">
        <div id="printer_details_modal" class="printer-details-dialog modal-content" style="max-width:900px;">
            <button class="modal-close-x" id="printer_details_close_x" title="Close">&times;</button>
            <h3 id="printer_details_title" style="margin-top:0;color:var(--highlight)">Printer Details</h3>
            <div id="printer_details_body"
                style="overflow-x:hidden;overflow-y:auto;font-family:system-ui;color:var(--text);word-wrap:break-word;flex:1;max-height:60vh;padding-right:8px;">
            </div>
            <div id="printer_details_actions" style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px;flex-shrink:0">
                <button class="modal-button modal-button-secondary" id="printer_details_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Agent Multi-step Modal -->
    <div class="modal modal-overlay" id="add_agent_modal" style="display:none;">
        <div class="modal-dialog" style="max-width:720px;">
            <div class="modal-header">
                <span class="modal-title" id="add_agent_title">Add Agent</span>
                <span class="modal-close" id="add_agent_close_x">&times;</span>
            </div>
            <div class="modal-body" id="add_agent_body" style="max-height:520px;overflow-y:auto;">
                <div id="add_agent_step_indicator" style="font-size:13px;color:var(--muted);margin-bottom:8px;">Step 1/3</div>
                <div id="add_agent_content">
                    <!-- Dynamic content rendered by app.js -->
                </div>
            </div>
            <div class="modal-footer" id="add_agent_footer">
                <button class="modal-button modal-button-secondary" id="add_agent_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="add_agent_primary">Next</button>
            </div>
        </div>
    </div>

    <!-- Generic Input Modal (used for small prompts, replaces prompt()) -->
    <div class="modal" id="input_modal" style="display:none;">
        <div class="modal-content" style="max-width:520px;">
            <div class="modal-header">
                <span class="modal-title" id="input_modal_title">Input</span>
                <span class="modal-close" id="input_modal_close_x">&times;</span>
            </div>
            <div class="modal-body" id="input_modal_body">
                <div id="input_modal_label" style="margin-bottom:8px;color:var(--muted);"></div>
                <input id="input_modal_input" type="text" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);" />
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="input_modal_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="input_modal_ok">OK</button>
            </div>
        </div>
    </div>

    <!-- SSO Provider Modal -->
    <div class="modal" id="sso_modal" style="display:none;">
        <div class="modal-content" style="max-width:640px;">
            <div class="modal-header">
                <span class="modal-title" id="sso_modal_title">Add OIDC Provider</span>
                <span class="modal-close" id="sso_modal_close">&times;</span>
            </div>
            <form id="sso_modal_form">
                <div class="modal-body" style="max-height:70vh;overflow:auto;display:flex;flex-direction:column;gap:16px;">
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Provider Template</span>
                        <select id="sso_template_select" style="padding:8px;border-radius:4px;border:1px solid var(--border);">
                            <option value="generic">Generic OIDC</option>
                            <option value="entra">Microsoft Entra ID</option>
                        </select>
                    </label>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Display Name</span>
                            <input id="sso_display_name" type="text" required style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="Acme SSO" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Slug</span>
                            <input id="sso_slug" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="acme" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small style="color:var(--muted);">Lowercase letters, numbers, and hyphen.</small>
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Tenant Scope</span>
                            <select id="sso_tenant" style="padding:8px;border-radius:4px;border:1px solid var(--border);"></select>
                            <small style="color:var(--muted);">Leave blank to make the provider global.</small>
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Default Role</span>
                            <select id="sso_default_role" style="padding:8px;border-radius:4px;border:1px solid var(--border);">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </label>
                    </div>
                    <label class="preset-section preset-generic" data-display="flex" style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Issuer URL</span>
                        <input id="sso_issuer" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="https://login.microsoftonline.com/..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                    </label>
                    <label class="preset-section preset-entra" data-display="flex" style="display:none;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Microsoft Entra Tenant (Directory) ID</span>
                        <input id="sso_entra_tenant" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="11111111-2222-3333-4444-555555555555" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        <small style="color:var(--muted);">We derive the issuer URL from this tenant ID.</small>
                    </label>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Client ID</span>
                        <input id="sso_client_id" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" autocomplete="off" data-1p-ignore data-lpignore="true" />
                    </label>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Client Secret</span>
                        <input id="sso_client_secret" type="password" style="padding:8px;border-radius:4px;border:1px solid var(--border);" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        <small style="color:var(--muted);">Leave blank to keep the existing secret when editing.</small>
                    </label>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Button Text</span>
                            <input id="sso_button_text" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="Sign in with Contoso" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                            <span>Icon URL</span>
                            <input id="sso_icon" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="https://.../logo.svg" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                    </div>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Button Style (optional CSS classes)</span>
                        <input id="sso_button_style" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" placeholder="btn btn-accent" autocomplete="off" data-1p-ignore data-lpignore="true" />
                    </label>
                    <label style="display:flex;flex-direction:column;font-size:13px;gap:6px;">
                        <span>Scopes</span>
                        <input id="sso_scopes" type="text" style="padding:8px;border-radius:4px;border:1px solid var(--border);" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        <small style="color:var(--muted);">Separate scopes with spaces or commas. "openid" is always included.</small>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
                        <input id="sso_auto_login" type="checkbox" />
                        <span>Automatically redirect users to this provider when it is the only option.</span>
                    </label>
                    <div id="sso_modal_error" style="display:none;color:var(--danger);font-size:13px;"></div>
                    <div id="sso_entra_instructions" class="sso-modal-helper preset-entra" data-display="block" style="display:none;">
                        <div style="font-weight:600;margin-bottom:6px;">Microsoft Entra setup checklist</div>
                        <ul>
                            <li>Create an app registration in <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/CreateApplicationBlade/quickStartType~/null/isMSAApp~/false" target="_blank" rel="noopener" class="sso-entra-portal-link">Microsoft Entra admin center</a>.</li>
                            <li>Select “Accounts in this organization only” and add <code id="sso_modal_redirect_uri_text">https://example.com/auth/oidc/callback</code> as a Web redirect URI.</li>
                            <li>Copy the Application (client) ID, create a client secret, and keep the Directory (tenant) ID.</li>
                            <li>Paste the client ID/secret here; the issuer URL is generated from your tenant ID automatically.</li>
                        </ul>
                        <button type="button" class="link-button" id="sso_modal_copy_redirect">Copy redirect URI</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-button modal-button-secondary" id="sso_modal_cancel">Cancel</button>
                    <button type="submit" class="modal-button modal-button-primary" id="sso_modal_submit">Save Provider</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal (create/edit) -->
    <div class="modal" id="user_modal" style="display:none;">
        <div class="modal-content user-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="user_modal_title">Add User</span>
                <span class="modal-close" id="user_modal_close_x">&times;</span>
            </div>
            <div class="modal-body user-modal-body">
                <div class="user-form-grid">
                    <div class="user-form-section">
                        <h4 class="user-form-section-title">Account Details</h4>
                        <label class="user-form-label">
                            <span>Username <span class="required">*</span></span>
                            <input id="user_username" type="text" class="user-form-input" placeholder="johndoe" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="user-form-label">
                            <span>Email</span>
                            <input id="user_email" type="email" class="user-form-input" placeholder="john@example.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="user-form-label">
                            <span>Role</span>
                            <select id="user_role" class="user-form-input">
                                <option value="viewer">Viewer</option>
                                <option value="operator">Operator</option>
                                <option value="admin">Admin</option>
                            </select>
                        </label>
                        <label class="user-form-label">
                            <span>Tenant</span>
                            <select id="user_tenant" class="user-form-input">
                                <option value="">(Global / Server)</option>
                            </select>
                            <span class="user-form-helper">Assign user to a specific tenant or leave global for server-wide access</span>
                        </label>
                    </div>
                    
                    <div class="user-form-section" id="user_password_section">
                        <div class="user-form-section-header">
                            <h4 class="user-form-section-title">Password</h4>
                            <label class="user-form-checkbox" id="user_change_password_toggle" style="display:none;">
                                <input type="checkbox" id="user_change_password" />
                                <span>Change password</span>
                            </label>
                        </div>
                        <div id="user_password_fields">
                            <label class="user-form-label">
                                <span>Password <span class="required" id="user_password_required">*</span></span>
                                <input id="user_password" type="password" class="user-form-input" placeholder="Enter password" autocomplete="new-password" />
                            </label>
                            <label class="user-form-label">
                                <span>Confirm Password <span class="required" id="user_password_confirm_required">*</span></span>
                                <input id="user_password_confirm" type="password" class="user-form-input" placeholder="Confirm password" autocomplete="new-password" />
                            </label>
                            <div class="password-strength" id="user_password_strength">
                                <div class="password-strength-bar">
                                    <div class="password-strength-fill" id="user_password_strength_fill"></div>
                                </div>
                                <div class="password-strength-text" id="user_password_strength_text">Enter a password</div>
                            </div>
                            <div class="password-requirements" id="user_password_requirements">
                                <div class="requirement" data-req="length"><span class="req-icon">○</span> Minimum 8 characters</div>
                                <div class="requirement" data-req="uppercase"><span class="req-icon">○</span> Uppercase letter</div>
                                <div class="requirement" data-req="lowercase"><span class="req-icon">○</span> Lowercase letter</div>
                                <div class="requirement" data-req="number"><span class="req-icon">○</span> Number</div>
                                <div class="requirement" data-req="special"><span class="req-icon">○</span> Special character</div>
                                <div class="requirement" data-req="match"><span class="req-icon">○</span> Passwords match</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="user_error" class="user-form-error"></div>
            </div>
            <div class="modal-footer user-modal-footer">
                <button class="btn-outline" id="user_cancel">Cancel</button>
                <button class="btn-primary" id="user_submit">Create User</button>
            </div>
        </div>
    </div>

    <!-- Invite User Modal -->
    <div class="modal" id="invite_user_modal" style="display:none;">
        <div class="modal-content user-modal-content">
            <div class="modal-header">
                <span class="modal-title">Invite User</span>
                <span class="modal-close" id="invite_user_modal_close_x">&times;</span>
            </div>
            <div class="modal-body user-modal-body">
                <div class="invite-info">
                    <svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>
                    <div class="invite-description">
                        <h4>Send an email invitation</h4>
                        <p>The user will receive an email with a link to set up their account and create a password.</p>
                    </div>
                </div>
                <div class="user-form-section" style="margin-top:20px;">
                    <label class="user-form-label">
                        <span>Email Address <span class="required">*</span></span>
                        <input id="invite_email" type="email" class="user-form-input" placeholder="john@example.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                    </label>
                    <label class="user-form-label">
                        <span>Username</span>
                        <input id="invite_username" type="text" class="user-form-input" placeholder="Leave blank to use email prefix" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        <span class="user-form-helper">Optional. If blank, username will be derived from email address.</span>
                    </label>
                    <label class="user-form-label">
                        <span>Role</span>
                        <select id="invite_role" class="user-form-input">
                            <option value="viewer">Viewer</option>
                            <option value="operator">Operator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </label>
                    <label class="user-form-label">
                        <span>Tenant</span>
                        <select id="invite_tenant" class="user-form-input">
                            <option value="">(Global / Server)</option>
                        </select>
                    </label>
                </div>
                <div id="invite_error" class="user-form-error"></div>
                <div id="invite_smtp_warning" class="user-form-warning" style="display:none;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/></svg>
                    <span>Email invitations require SMTP to be configured in server settings.</span>
                </div>
            </div>
            <div class="modal-footer user-modal-footer">
                <button class="btn-outline" id="invite_user_cancel">Cancel</button>
                <button class="btn-primary" id="invite_user_submit" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/></svg>
                    Send Invitation
                </button>
            </div>
        </div>
    </div>

    <!-- Tenant Modal -->
    <div class="modal" id="tenant_modal" style="display:none;">
        <div class="modal-content tenant-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="tenant_modal_title">New Tenant</span>
                <button class="modal-close-x" id="tenant_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body tenant-modal-body">
                <div class="tenant-form-grid">
                    <!-- Left column: Core identity -->
                    <div class="tenant-form-section">
                        <div class="tenant-section-title">Tenant Information</div>
                        <label class="tenant-form-label">
                            <span>Tenant Name <span class="required">*</span></span>
                            <input id="tenant_name" type="text" class="tenant-form-input" placeholder="Acme Corp" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Billing / Reference Code</span>
                            <input id="tenant_billing_code" type="text" class="tenant-form-input" placeholder="ACME-OPS-01" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <span class="tenant-form-helper">Internal reference for invoicing or tracking</span>
                        </label>
                        <label class="tenant-form-label">
                            <span>Login Domain (SSO)</span>
                            <input id="tenant_login_domain" type="text" class="tenant-form-input" placeholder="example.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <span class="tenant-form-helper">Email domain for automatic tenant detection during SSO</span>
                        </label>
                    </div>
                    <!-- Right column: Contact details -->
                    <div class="tenant-form-section">
                        <div class="tenant-section-title">Primary Contact</div>
                        <label class="tenant-form-label">
                            <span>Contact Name</span>
                            <input id="tenant_contact_name" type="text" class="tenant-form-input" placeholder="Jane Smith" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Contact Email</span>
                            <input id="tenant_contact_email" type="email" class="tenant-form-input" placeholder="jane@example.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Contact Phone</span>
                            <input id="tenant_contact_phone" type="text" class="tenant-form-input" placeholder="+1 800 555 1234" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Address</span>
                            <textarea id="tenant_address" rows="2" class="tenant-form-input" placeholder="123 Main St, City, State"></textarea>
                        </label>
                    </div>
                </div>
                <!-- Full-width notes section -->
                <div class="tenant-form-section tenant-notes-section">
                    <label class="tenant-form-label">
                        <span>Notes</span>
                        <textarea id="tenant_description" rows="2" class="tenant-form-input" placeholder="Additional notes about this tenant..."></textarea>
                    </label>
                </div>
                
                <!-- Onboarding Options (shown only for new tenants) -->
                <div id="tenant_onboarding_section" class="tenant-onboarding-section" style="display:none;">
                    <div class="tenant-section-title" style="margin-bottom:12px;">Customer Onboarding <span class="onboarding-optional">(optional)</span></div>
                    
                    <!-- Invite Admin Toggle -->
                    <div class="onboarding-option">
                        <label class="onboarding-toggle">
                            <input type="checkbox" id="tenant_invite_admin_toggle" />
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="onboarding-option-info">
                            <div class="onboarding-option-title">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path d="M2 13c0-2.21 2.686-4 6-4s6 1.79 6 4v1H2v-1z"/></svg>
                                Invite Initial Admin
                            </div>
                            <div class="onboarding-option-desc">Send an invitation email to create the first admin user for this customer</div>
                        </div>
                    </div>
                    <div id="tenant_invite_admin_fields" class="onboarding-fields" style="display:none;">
                        <label class="tenant-form-label">
                            <span>Admin Email <span class="required">*</span></span>
                            <input id="tenant_admin_email" type="email" class="tenant-form-input" placeholder="admin@customer.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="tenant-form-label">
                            <span>Admin Username</span>
                            <input id="tenant_admin_username" type="text" class="tenant-form-input" placeholder="Leave blank to derive from email" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <span class="tenant-form-helper">Optional. If blank, username will be derived from email address.</span>
                        </label>
                    </div>
                    
                    <!-- Send Agent Email Toggle -->
                    <div class="onboarding-option" style="margin-top:16px;">
                        <label class="onboarding-toggle">
                            <input type="checkbox" id="tenant_send_agent_toggle" />
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="onboarding-option-info">
                            <div class="onboarding-option-title">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zM16 4.697v7.104l-5.803-3.558L16 4.697z"/></svg>
                                Send Agent Deployment Email
                            </div>
                            <div class="onboarding-option-desc">Email installation instructions for setting up the PrintMaster agent</div>
                        </div>
                    </div>
                    <div id="tenant_send_agent_fields" class="onboarding-fields" style="display:none;">
                        <label class="tenant-form-label">
                            <span>Recipient Email <span class="required">*</span></span>
                            <input id="tenant_agent_email" type="email" class="tenant-form-input" placeholder="it@customer.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <span class="tenant-form-helper">This person will receive the agent bootstrap script with installation instructions.</span>
                        </label>
                        <label class="tenant-form-label">
                            <span>Target Platform</span>
                            <select id="tenant_agent_platform" class="tenant-form-input">
                                <option value="windows">Windows</option>
                                <option value="linux">Linux</option>
                                <option value="darwin">macOS</option>
                            </select>
                        </label>
                    </div>
                    
                    <!-- SMTP Warning -->
                    <div id="tenant_smtp_warning" class="onboarding-smtp-warning" style="display:none;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                        <span>SMTP is not configured. Email invitations cannot be sent. <a href="#settings/email">Configure email settings</a></span>
                    </div>
                </div>
                
                <div id="tenant_error" class="tenant-form-error"></div>
            </div>
            <div class="modal-footer tenant-modal-footer">
                <button class="btn-outline" id="tenant_cancel">Cancel</button>
                <button class="btn-primary" id="tenant_save">Create Tenant</button>
            </div>
        </div>
    </div>

    <!-- Sites List Modal -->
    <div class="modal" id="sites_list_modal" style="display:none;">
        <div class="modal-content sites-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="sites_list_modal_title">Sites</span>
                <button class="modal-close-x" id="sites_list_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body sites-modal-body">
                <div class="sites-header">
                    <p class="muted-text" id="sites_list_subtitle">Manage sites for this tenant</p>
                    <button class="btn-primary" id="sites_list_add_btn">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        Add Site
                    </button>
                </div>
                <div id="sites_list_content">
                    <div class="muted-text">Loading sites...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Edit Modal -->
    <div class="modal" id="site_modal" style="display:none;">
        <div class="modal-content site-modal-content">
            <div class="modal-header">
                <span class="modal-title" id="site_modal_title">New Site</span>
                <button class="modal-close-x" id="site_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body site-modal-body">
                <div class="site-form-grid">
                    <div class="site-form-section">
                        <div class="site-section-title">Site Details</div>
                        <label class="site-form-label">
                            <span>Site Name <span class="required">*</span></span>
                            <input id="site_name" type="text" class="site-form-input" placeholder="North Campus" />
                        </label>
                        <label class="site-form-label">
                            <span>Address</span>
                            <textarea id="site_address" rows="2" class="site-form-input" placeholder="123 Main St, City, State"></textarea>
                        </label>
                        <label class="site-form-label">
                            <span>Description</span>
                            <textarea id="site_description" rows="2" class="site-form-input" placeholder="Site notes..."></textarea>
                        </label>
                    </div>
                    <div class="site-form-section">
                        <div class="site-section-title">Assigned Agents</div>
                        <div id="site_agents_list" class="site-agents-list">
                            <div class="muted-text">Loading agents...</div>
                        </div>
                        <span class="site-form-helper">Select agents that serve this site. Devices will be grouped by agent unless filter rules are set.</span>
                    </div>
                </div>
                <div class="site-form-section site-rules-section">
                    <div class="site-section-header">
                        <div class="site-section-title">Device Filter Rules</div>
                        <button class="btn-outline btn-sm" id="site_add_rule_btn">
                            <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                            Add Rule
                        </button>
                    </div>
                    <p class="site-form-helper">When an agent serves multiple sites, use filter rules to route devices to the correct site. Leave empty to include all devices from assigned agents.</p>
                    <div id="site_filter_rules" class="site-filter-rules">
                        <!-- Filter rules will be rendered here -->
                    </div>
                </div>
                <div id="site_error" class="site-form-error"></div>
            </div>
            <div class="modal-footer site-modal-footer">
                <button class="btn-outline" id="site_cancel">Cancel</button>
                <button class="btn-primary" id="site_save">Create Site</button>
            </div>
        </div>
    </div>

    <!-- Alert Rule Modal -->
    <div class="modal" id="alert_rule_modal" style="display:none;">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <span class="modal-title" id="alert_rule_modal_title">New Alert Rule</span>
                <button class="modal-close-x" id="alert_rule_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body" style="max-height:500px;overflow-y:auto;">
                <label class="field">
                    <span>Rule Name <span class="required">*</span></span>
                    <input id="alert_rule_name" type="text" placeholder="Low Toner Warning" />
                </label>
                <label class="field">
                    <span>Description</span>
                    <textarea id="alert_rule_description" rows="2" placeholder="Optional description..."></textarea>
                </label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <label class="field">
                        <span>Alert Type <span class="required">*</span></span>
                        <select id="alert_rule_type">
                            <option value="toner_low">Toner Low</option>
                            <option value="toner_critical">Toner Critical</option>
                            <option value="device_offline">Device Offline</option>
                            <option value="device_error">Device Error</option>
                            <option value="agent_offline">Agent Offline</option>
                            <option value="page_count">Page Count Threshold</option>
                            <option value="supply_empty">Supply Empty</option>
                            <option value="custom">Custom</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Severity <span class="required">*</span></span>
                        <select id="alert_rule_severity">
                            <option value="info">Info</option>
                            <option value="warning" selected>Warning</option>
                            <option value="critical">Critical</option>
                        </select>
                    </label>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <label class="field">
                        <span>Scope</span>
                        <select id="alert_rule_scope">
                            <option value="fleet">Fleet (All Devices)</option>
                            <option value="tenant">Tenant</option>
                            <option value="site">Site</option>
                            <option value="agent">Agent</option>
                            <option value="device">Device</option>
                        </select>
                    </label>
                    <label class="field" id="alert_rule_scope_id_field" style="display:none;">
                        <span>Scope Target</span>
                        <input id="alert_rule_scope_id" type="text" placeholder="ID or serial" />
                    </label>
                </div>
                <label class="field">
                    <span>Threshold</span>
                    <input id="alert_rule_threshold" type="number" placeholder="e.g., 10 for 10%" />
                </label>
                <label class="field">
                    <span>Notification Channels</span>
                    <div id="alert_rule_channels" style="max-height:120px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;padding:8px;">
                        <div class="muted-text">Loading channels...</div>
                    </div>
                </label>
                <label class="field inline-check" style="margin-top:8px;">
                    <input type="checkbox" id="alert_rule_enabled" checked />
                    <span>Enable this rule</span>
                </label>
                <div id="alert_rule_error" style="color:var(--danger);display:none;margin-top:8px;font-size:13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="alert_rule_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="alert_rule_save">Save Rule</button>
            </div>
        </div>
    </div>

    <!-- Notification Channel Modal (Redesigned) -->
    <div class="modal" id="notification_channel_modal" style="display:none;">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <span class="modal-title" id="notification_channel_modal_title">New Notification Channel</span>
                <button class="modal-close-x" id="notification_channel_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body" style="padding:0;">
                <!-- Channel Type Selector with Visual Cards -->
                <div class="channel-type-selector" style="padding:20px;background:var(--bg-tertiary);border-bottom:1px solid var(--divider);">
                    <label style="display:block;font-weight:600;margin-bottom:12px;color:var(--text);">Select Channel Type</label>
                    <div class="channel-type-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:8px;">
                        <label class="channel-type-card" data-type="email">
                            <input type="radio" name="channel_type_radio" value="email" checked style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                            </div>
                            <span>Email</span>
                        </label>
                        <label class="channel-type-card" data-type="slack">
                            <input type="radio" name="channel_type_radio" value="slack" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>
                            </div>
                            <span>Slack</span>
                        </label>
                        <label class="channel-type-card" data-type="discord">
                            <input type="radio" name="channel_type_radio" value="discord" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            </div>
                            <span>Discord</span>
                        </label>
                        <label class="channel-type-card" data-type="teams">
                            <input type="radio" name="channel_type_radio" value="teams" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.19 8.77h-3.74V6.52c0-.59.48-1.08 1.08-1.08h1.58c.6 0 1.08.48 1.08 1.08v2.25zm-3.74 1.25h4.55c.55 0 1 .45 1 1v4.08c0 1.66-1.34 3-3 3h-.55c-1.66 0-3-1.34-3-3v-4.08c0-.55.45-1 1-1zm3.8-5.89c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-5.97 1.25H8.64c-.83 0-1.5.67-1.5 1.5v3.64h.78v5.21c0 .83.67 1.5 1.5 1.5h2.36c.83 0 1.5-.67 1.5-1.5v-5.21h.78V6.88c0-.83-.67-1.5-1.5-1.5zm-2.32-1.57c1.38 0 2.5-1.12 2.5-2.5s-1.12-2.5-2.5-2.5-2.5 1.12-2.5 2.5 1.12 2.5 2.5 2.5z"/></svg>
                            </div>
                            <span>Teams</span>
                        </label>
                        <label class="channel-type-card" data-type="telegram">
                            <input type="radio" name="channel_type_radio" value="telegram" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                            </div>
                            <span>Telegram</span>
                        </label>
                        <label class="channel-type-card" data-type="pagerduty">
                            <input type="radio" name="channel_type_radio" value="pagerduty" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.965 1.18C15.085.164 13.769 0 10.683 0H3.73v14.55h6.926c2.743 0 4.8-.164 6.61-1.37 1.975-1.303 3.004-3.49 3.004-6.063 0-2.956-1.406-5.005-3.305-5.938zM11.32 10.57H7.64V3.924h3.57c3.003 0 4.61 1.109 4.61 3.239 0 2.431-1.85 3.407-4.5 3.407zM3.73 17.79h3.91V24H3.73z"/></svg>
                            </div>
                            <span>PagerDuty</span>
                        </label>
                        <label class="channel-type-card" data-type="pushover">
                            <input type="radio" name="channel_type_radio" value="pushover" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-2h2V7h-2v8z"/></svg>
                            </div>
                            <span>Pushover</span>
                        </label>
                        <label class="channel-type-card" data-type="ntfy">
                            <input type="radio" name="channel_type_radio" value="ntfy" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                            </div>
                            <span>ntfy</span>
                        </label>
                        <label class="channel-type-card" data-type="webhook">
                            <input type="radio" name="channel_type_radio" value="webhook" style="display:none;">
                            <div class="channel-type-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10 15l5.88-4L10 7v8zm11.89 2.89c-2.6.63-5.68.83-9.89.83-4.21 0-7.29-.2-9.89-.83C.95 17.6.21 17.18 0 16.53V7.47c.21-.65.95-1.07 2.11-1.36C4.71 5.48 7.79 5.28 12 5.28c4.21 0 7.29.2 9.89.83 1.16.29 1.9.71 2.11 1.36v9.06c-.21.65-.95 1.07-2.11 1.36z"/></svg>
                            </div>
                            <span>Webhook</span>
                        </label>
                    </div>
                </div>
                <!-- Hidden select for compatibility -->
                <select id="channel_type" style="display:none;">
                    <option value="email">Email</option>
                    <option value="slack">Slack</option>
                    <option value="discord">Discord</option>
                    <option value="teams">Microsoft Teams</option>
                    <option value="telegram">Telegram</option>
                    <option value="pagerduty">PagerDuty</option>
                    <option value="pushover">Pushover</option>
                    <option value="ntfy">ntfy</option>
                    <option value="webhook">Webhook</option>
                </select>
                
                <!-- Configuration Form -->
                <div style="padding:20px;">
                    <label class="field">
                        <span>Channel Name <span class="required">*</span></span>
                        <input id="channel_name" type="text" placeholder="e.g., Ops Team Alerts" autocomplete="off" data-1p-ignore data-lpignore="true" />
                    </label>
                    
                    <!-- Email-specific fields -->
                    <div id="channel_config_email" class="channel-config-section">
                        <div class="config-section-header">
                            <span class="config-section-title">Email Configuration</span>
                            <span class="config-section-hint">Uses server SMTP settings</span>
                        </div>
                        <label class="field">
                            <span>Recipients <span class="required">*</span></span>
                            <input id="channel_email_to" type="text" placeholder="admin@example.com, alerts@example.com" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small class="field-hint">Comma-separated email addresses</small>
                        </label>
                        <label class="field">
                            <span>Subject Prefix</span>
                            <input id="channel_email_subject" type="text" placeholder="[PrintMaster Alert]" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                    </div>
                    
                    <!-- Slack-specific fields -->
                    <div id="channel_config_slack" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">Slack Configuration</span>
                            <a href="https://api.slack.com/messaging/webhooks" target="_blank" class="config-section-link">How to create a webhook</a>
                        </div>
                        <label class="field">
                            <span>Webhook URL <span class="required">*</span></span>
                            <input id="channel_slack_url" type="url" placeholder="https://hooks.slack.com/services/T00.../B00.../xxx" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <div class="field-row">
                            <label class="field" style="flex:1;">
                                <span>Channel Override</span>
                                <input id="channel_slack_channel" type="text" placeholder="#alerts" autocomplete="off" data-1p-ignore data-lpignore="true" />
                                <small class="field-hint">Optional, uses webhook default</small>
                            </label>
                            <label class="field" style="flex:1;">
                                <span>Bot Username</span>
                                <input id="channel_slack_username" type="text" placeholder="PrintMaster" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                        </div>
                    </div>
                    
                    <!-- Discord-specific fields -->
                    <div id="channel_config_discord" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">Discord Configuration</span>
                            <a href="https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks" target="_blank" class="config-section-link">How to create a webhook</a>
                        </div>
                        <label class="field">
                            <span>Webhook URL <span class="required">*</span></span>
                            <input id="channel_discord_url" type="url" placeholder="https://discord.com/api/webhooks/..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="field">
                            <span>Bot Username</span>
                            <input id="channel_discord_username" type="text" placeholder="PrintMaster" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small class="field-hint">Display name for messages</small>
                        </label>
                    </div>
                    
                    <!-- Teams-specific fields -->
                    <div id="channel_config_teams" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">Microsoft Teams Configuration</span>
                            <a href="https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook" target="_blank" class="config-section-link">How to create a webhook</a>
                        </div>
                        <label class="field">
                            <span>Incoming Webhook URL <span class="required">*</span></span>
                            <input id="channel_teams_url" type="url" placeholder="https://outlook.office.com/webhook/..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                    </div>
                    
                    <!-- Telegram-specific fields -->
                    <div id="channel_config_telegram" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">Telegram Configuration</span>
                            <a href="https://core.telegram.org/bots#how-do-i-create-a-bot" target="_blank" class="config-section-link">How to create a bot</a>
                        </div>
                        <label class="field">
                            <span>Bot Token <span class="required">*</span></span>
                            <input id="channel_telegram_token" type="password" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v..." autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small class="field-hint">Get this from @BotFather</small>
                        </label>
                        <label class="field">
                            <span>Chat ID <span class="required">*</span></span>
                            <input id="channel_telegram_chat" type="text" placeholder="-1001234567890 or @channelname" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small class="field-hint">Channel, group, or user ID</small>
                        </label>
                    </div>
                    
                    <!-- PagerDuty-specific fields -->
                    <div id="channel_config_pagerduty" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">PagerDuty Configuration</span>
                            <a href="https://support.pagerduty.com/docs/services-and-integrations" target="_blank" class="config-section-link">Setup guide</a>
                        </div>
                        <label class="field">
                            <span>Integration/Routing Key <span class="required">*</span></span>
                            <input id="channel_pagerduty_key" type="password" placeholder="Your Events API v2 integration key" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small class="field-hint">From your PagerDuty service integration</small>
                        </label>
                        <label class="field">
                            <span>Default Severity</span>
                            <select id="channel_pagerduty_severity">
                                <option value="critical">Critical</option>
                                <option value="error">Error</option>
                                <option value="warning" selected>Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </label>
                    </div>
                    
                    <!-- Pushover-specific fields -->
                    <div id="channel_config_pushover" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">Pushover Configuration</span>
                            <a href="https://pushover.net/api" target="_blank" class="config-section-link">API Documentation</a>
                        </div>
                        <div class="field-row">
                            <label class="field" style="flex:1;">
                                <span>User/Group Key <span class="required">*</span></span>
                                <input id="channel_pushover_user" type="password" placeholder="Your user or group key" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                            <label class="field" style="flex:1;">
                                <span>API Token <span class="required">*</span></span>
                                <input id="channel_pushover_token" type="password" placeholder="Your application API token" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                        </div>
                        <div class="field-row">
                            <label class="field" style="flex:1;">
                                <span>Device (optional)</span>
                                <input id="channel_pushover_device" type="text" placeholder="Leave blank for all devices" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                            <label class="field" style="flex:1;">
                                <span>Sound</span>
                                <select id="channel_pushover_sound">
                                    <option value="">Default</option>
                                    <option value="pushover">Pushover</option>
                                    <option value="bike">Bike</option>
                                    <option value="bugle">Bugle</option>
                                    <option value="cashregister">Cash Register</option>
                                    <option value="classical">Classical</option>
                                    <option value="cosmic">Cosmic</option>
                                    <option value="siren">Siren</option>
                                    <option value="none">None (silent)</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <!-- ntfy-specific fields -->
                    <div id="channel_config_ntfy" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">ntfy Configuration</span>
                            <a href="https://ntfy.sh/docs/" target="_blank" class="config-section-link">Documentation</a>
                        </div>
                        <div class="field-row">
                            <label class="field" style="flex:2;">
                                <span>Server URL</span>
                                <input id="channel_ntfy_server" type="url" placeholder="https://ntfy.sh (default)" autocomplete="off" data-1p-ignore data-lpignore="true" />
                                <small class="field-hint">Leave blank for ntfy.sh public server</small>
                            </label>
                            <label class="field" style="flex:1;">
                                <span>Topic <span class="required">*</span></span>
                                <input id="channel_ntfy_topic" type="text" placeholder="printmaster-alerts" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                        </div>
                        <div class="field-row" id="ntfy_auth_fields">
                            <label class="field" style="flex:1;">
                                <span>Username</span>
                                <input id="channel_ntfy_username" type="text" placeholder="Optional" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                            <label class="field" style="flex:1;">
                                <span>Password</span>
                                <input id="channel_ntfy_password" type="password" placeholder="Optional" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            </label>
                        </div>
                        <label class="field">
                            <span>Or Access Token</span>
                            <input id="channel_ntfy_token" type="password" placeholder="tk_... (alternative to username/password)" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                    </div>
                    
                    <!-- Webhook-specific fields -->
                    <div id="channel_config_webhook" class="channel-config-section" style="display:none;">
                        <div class="config-section-header">
                            <span class="config-section-title">Webhook Configuration</span>
                            <span class="config-section-hint">POST JSON payload to your endpoint</span>
                        </div>
                        <label class="field">
                            <span>Webhook URL <span class="required">*</span></span>
                            <input id="channel_webhook_url" type="url" placeholder="https://example.com/webhook" autocomplete="off" data-1p-ignore data-lpignore="true" />
                        </label>
                        <label class="field">
                            <span>HTTP Method</span>
                            <select id="channel_webhook_method">
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>Custom Headers (JSON)</span>
                            <textarea id="channel_webhook_headers" rows="2" style="font-family:var(--font-mono);font-size:12px;" placeholder='{"Authorization": "Bearer token123"}'></textarea>
                            <small class="field-hint">Optional custom HTTP headers</small>
                        </label>
                    </div>
                    
                    <!-- Common Options Divider -->
                    <div class="config-divider">
                        <span>Delivery Options</span>
                    </div>
                    
                    <div class="field-row">
                        <label class="field" style="flex:1;">
                            <span>Minimum Severity</span>
                            <select id="channel_min_severity">
                                <option value="">All severities</option>
                                <option value="info">Info and above</option>
                                <option value="warning">Warning and above</option>
                                <option value="critical">Critical only</option>
                            </select>
                        </label>
                        <label class="field" style="flex:1;">
                            <span>Rate Limit</span>
                            <input id="channel_rate_limit" type="number" min="0" value="0" placeholder="0" autocomplete="off" data-1p-ignore data-lpignore="true" />
                            <small class="field-hint">Max per hour (0 = no limit)</small>
                        </label>
                    </div>
                    
                    <label class="field inline-check" style="margin-top:12px;">
                        <input type="checkbox" id="channel_enabled" checked />
                        <span>Enable this channel</span>
                    </label>
                    
                    <div id="channel_error" class="channel-form-error" style="display:none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="channel_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="channel_save">Save Channel</button>
            </div>
        </div>
    </div>

    <!-- Escalation Policy Modal -->
    <div class="modal" id="escalation_policy_modal" style="display:none;">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <span class="modal-title" id="escalation_policy_modal_title">New Escalation Policy</span>
                <button class="modal-close-x" id="escalation_policy_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <label class="field">
                    <span>Policy Name <span class="required">*</span></span>
                    <input id="escalation_name" type="text" placeholder="Critical Alert Escalation" />
                </label>
                <label class="field">
                    <span>Description</span>
                    <textarea id="escalation_description" rows="2" placeholder="Optional description..."></textarea>
                </label>
                
                <div class="field" style="margin-top:16px;">
                    <span style="font-weight:500;">Escalation Steps</span>
                    <small class="field-hint">Define escalation steps. Alerts will escalate to the next step if not acknowledged.</small>
                    <div id="escalation_steps_container" style="margin-top:8px;"></div>
                    <button type="button" class="btn btn-sm" id="add_escalation_step" style="margin-top:8px;">+ Add Step</button>
                </div>
                
                <label class="field inline-check" style="margin-top:16px;">
                    <input type="checkbox" id="escalation_enabled" checked />
                    <span>Enable this policy</span>
                </label>
                <div id="escalation_error" style="color:var(--danger);display:none;margin-top:8px;font-size:13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="escalation_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="escalation_save">Save Policy</button>
            </div>
        </div>
    </div>

    <!-- Maintenance Window Modal -->
    <div class="modal" id="maintenance_window_modal" style="display:none;">
        <div class="modal-content" style="max-width:550px;">
            <div class="modal-header">
                <span class="modal-title" id="maintenance_window_modal_title">Schedule Maintenance Window</span>
                <button class="modal-close-x" id="maintenance_window_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <label class="field">
                    <span>Window Name <span class="required">*</span></span>
                    <input id="maintenance_name" type="text" placeholder="Weekly Maintenance" />
                </label>
                <label class="field">
                    <span>Description</span>
                    <textarea id="maintenance_description" rows="2" placeholder="Optional notes..."></textarea>
                </label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <label class="field">
                        <span>Start Time <span class="required">*</span></span>
                        <input id="maintenance_start" type="datetime-local" />
                    </label>
                    <label class="field">
                        <span>End Time <span class="required">*</span></span>
                        <input id="maintenance_end" type="datetime-local" />
                    </label>
                </div>
                <label class="field">
                    <span>Scope</span>
                    <select id="maintenance_scope">
                        <option value="fleet">Fleet (All)</option>
                        <option value="tenant">Tenant</option>
                        <option value="site">Site</option>
                        <option value="agent">Agent</option>
                        <option value="device">Device</option>
                    </select>
                </label>
                <label class="field" id="maintenance_scope_id_field" style="display:none;">
                    <span>Scope Target ID</span>
                    <input id="maintenance_scope_id" type="text" placeholder="ID or serial" />
                </label>
                <label class="field inline-check" style="margin-top:12px;">
                    <input type="checkbox" id="maintenance_recurring" />
                    <span>Recurring window</span>
                </label>
                <div id="maintenance_error" style="color:var(--danger);display:none;margin-top:8px;font-size:13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="maintenance_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="maintenance_save">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Scheduled Report Modal -->
    <div class="modal" id="scheduled_report_modal" style="display:none;">
        <div class="modal-content" style="max-width:550px;">
            <div class="modal-header">
                <span class="modal-title" id="scheduled_report_modal_title">Schedule Report</span>
                <button class="modal-close-x" id="scheduled_report_modal_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <label class="field">
                    <span>Schedule Name <span class="required">*</span></span>
                    <input id="schedule_name" type="text" placeholder="Weekly Fleet Report" />
                </label>
                <label class="field">
                    <span>Report Type <span class="required">*</span></span>
                    <select id="schedule_report_type">
                        <option value="device_inventory">Device Inventory</option>
                        <option value="agent_inventory">Agent Inventory</option>
                        <option value="usage_summary">Usage Summary</option>
                        <option value="usage_by_device">Usage By Device</option>
                        <option value="supplies_status">Supplies Status</option>
                        <option value="alert_summary">Alert Summary</option>
                        <option value="alert_history">Alert History</option>
                    </select>
                </label>
                <label class="field">
                    <span>Frequency <span class="required">*</span></span>
                    <select id="schedule_frequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </label>
                <div id="schedule_day_field" style="display:none;">
                    <label class="field">
                        <span>Day</span>
                        <select id="schedule_day">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </label>
                </div>
                <div id="schedule_day_of_month_field" style="display:none;">
                    <label class="field">
                        <span>Day of Month</span>
                        <input id="schedule_day_of_month" type="number" min="1" max="28" value="1" />
                    </label>
                </div>
                <label class="field">
                    <span>Time</span>
                    <input id="schedule_time" type="time" value="08:00" />
                </label>
                <label class="field">
                    <span>Format</span>
                    <select id="schedule_format">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </label>
                <label class="field inline-check" style="margin-top:12px;">
                    <input type="checkbox" id="schedule_enabled" checked />
                    <span>Enable this schedule</span>
                </label>
                <div id="schedule_error" style="color:var(--danger);display:none;margin-top:8px;font-size:13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="schedule_cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="schedule_save">Save Schedule</button>
            </div>
        </div>
    </div>

    <!-- Report Download Modal -->
    <div class="modal" id="report_download_modal" style="display:none;">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <span class="modal-title">Report Ready</span>
                <button class="modal-close-x" id="report_download_close_x" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="report_download_info" style="margin-bottom:16px;">
                    <p style="margin:0;color:var(--text);">Your report has been generated.</p>
                </div>
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button class="btn-primary" id="report_download_csv">Download CSV</button>
                    <button class="btn-outline" id="report_download_json">Download JSON</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="report_download_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Mobile navigation overlay and floating toggle button -->
    <div class="mobile-nav-overlay" id="mobile_nav_overlay"></div>
    <button class="mobile-nav-toggle" id="mobile_nav_toggle" title="Menu" aria-label="Toggle navigation menu">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </button>

    <script src="/static/sso-admin.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/rbac.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/utils/formatters.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/utils/charts.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>
    <script src="/static/app.js{{if .AssetVersion}}?v={{.AssetVersion}}{{end}}"></script>

</body>

</html>
