<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>PrintMaster Agent</title>
    <script>window.__pm_shared = window.__pm_shared || {};</script>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='16' y='8' width='32' height='12' fill='%234a5568' rx='2'/><rect x='12' y='20' width='40' height='24' fill='%23718096' rx='3'/><rect x='16' y='24' width='32' height='16' fill='%23cbd5e0' rx='2'/><rect x='20' y='28' width='8' height='2' fill='%234299e1'/><rect x='20' y='32' width='12' height='2' fill='%234299e1'/><rect x='20' y='36' width='10' height='2' fill='%234299e1'/><circle cx='46' cy='32' r='3' fill='%2348bb78'/><rect x='16' y='44' width='32' height='12' fill='%234a5568' rx='2'/><rect x='20' y='48' width='24' height='4' fill='%23e2e8f0'/></svg>">
    <!-- flatpickr is injected centrally from common/web/shared.js -->
    <link rel="stylesheet" href="static/shared.css">
    <link rel="stylesheet" href="static/style.css">
    <script src="static/shared.js"></script>
    <script src="static/cards.js"></script>
    <script src="static/metrics.js"></script>
</head>

<body>
    <div class="header-flex"
        style="display: flex; align-items: center; margin-bottom: 4px; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <h1 style="margin: 0;">PrintMaster Agent UI</h1>
            <div class="server-status-control" data-role="admin" style="display:none">
                <button id="join_token_btn" data-role="admin" style="display:none" class="modal-button modal-button-primary" title="Join a server with login approval">Join Server</button>
                <span id="server_status_badge" class="server-status-badge" aria-live="polite">Disconnected</span>
            </div>
        </div>
        <label class="theme-toggle">
            <input type="checkbox" id="theme-toggle-checkbox">
            <div class="theme-toggle-slider">
                <div class="theme-toggle-icon"></div>
            </div>
        </label>
    </div>
    
    <!-- Header info bar with version and server details -->
    <div id="header_info_bar" class="header-info-bar">
        <span class="header-info-item" id="header_version" title="Agent version">v‚Äî</span>
        <span class="header-info-sep">‚Ä¢</span>
        <span class="header-info-item" id="header_server" title="Server connection">Standalone</span>
        <span class="header-info-sep hidden" id="header_tenant_sep">‚Ä¢</span>
        <span class="header-info-item hidden" id="header_tenant" title="Tenant"></span>
    </div>

    <!-- Main content container with floating appearance -->
    <div class="content-container">
        <div class="tabbar">
            <!-- Hamburger menu for mobile -->
            <div class="hamburger-menu">
                <div class="hamburger-header">
                    <span id="current_tab_label">Menu - Devices</span>
                    <div class="hamburger-icon">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            </div>
            <div class="mobile-nav" id="mobile_nav">
                <button class="tab active" data-target="devices">Devices</button>
                <button class="tab" data-target="settings" data-role="admin" style="display:none">Settings</button>
                <button class="tab" data-target="logs" data-role="admin" style="display:none">Logs</button>
            </div>
            <!-- Desktop tabs -->
            <button class="tab active" data-target="devices">Devices</button>
            <button class="tab" data-target="settings" data-role="admin" style="display:none">Settings</button>
            <button class="tab" data-target="logs" data-role="admin" style="display:none">Logs</button>
        </div>

        <div style="margin-top:12px;" data-tab="devices">
            <h3>Devices</h3>

            <!-- Discover controls -->
            <div style="display:flex;gap:12px;align-items:flex-start;margin-top:6px;margin-bottom:12px;flex-wrap:wrap">
                <button class="primary" id="discover_now_btn" data-role="admin" style="display:none">Discover Now</button>
            </div>

            <!-- Discovered Printers Section -->
            <div id="discovered_section" style="margin-bottom:20px;">
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
                    <h4 style="margin:0;color:var(--highlight)">Discovered Printers</h4>
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                        <input type="text" id="discovered_search" placeholder="Search devices..."
                            style="padding:6px 12px;width:200px;" />

                        <label
                            style="cursor:pointer;color:var(--text);display:flex;align-items:center;gap:6px;font-size:13px;">
                            <input type="checkbox" id="show_saved_in_discovered">
                            <span>Show Known Devices</span>
                        </label>
                    </div>
                </div>

                <div id="discovered_stats" style="display:flex;gap:12px;margin-bottom:12px;font-size:13px;"></div>
                <div class="device-cards-container" id="discovered_devices_cards"></div>
                <div style="margin-top:16px;display:flex;gap:12px;align-items:center;">
                    <button data-action="save-all-discovered" data-role="admin" style="display:none">Save All</button>
                    <span style="color:var(--muted)">|</span>
                    <button data-action="clear-discovered" data-role="admin" style="display:none">Clear</button>
                </div>
            </div>

            <!-- Separator -->
            <hr style="border:none;border-top:1px solid #004b56;margin:20px 0" />

            <!-- Saved Devices Section -->
            <div style="margin-bottom:20px;">
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
                    <h4 style="margin:0;color:var(--highlight)">Saved Devices</h4>
                    <input type="text" id="saved_search" placeholder="Search devices..."
                        style="padding:6px 12px;width:200px;" />
                </div>
                <div id="saved_stats" style="display:flex;gap:12px;margin-bottom:12px;font-size:13px;"></div>
                <div class="saved-device-cards-container" id="saved_devices_cards"></div>
                <div style="margin-top:16px;display:flex;gap:8px;">
                    <button class="delete" style="margin-left:auto;" data-action="delete-all-saved" data-role="admin" style="display:none">Delete All Saved
                        Devices</button>
                </div>
            </div>
        </div>

        <!-- Sandbox UI removed -->

        <div style="margin-top:12px;" data-tab="settings" class="hidden" data-role="admin" style="display:none">
            <h3>Settings</h3>

            <!-- Settings Controls (Sticky) -->
            <div class="settings-sticky-bar">
                <label id="autosave_label">
                    <input type="checkbox" id="settings_autosave" />
                    <span style="font-weight:500;font-size:14px;">Auto-save</span>
                </label>
                <div id="settings_buttons" class="settings-buttons">
                    <button id="settings_apply_btn">Apply</button>
                    <button id="settings_revert_btn">Revert</button>
                    <button id="settings_reset_btn">Reset</button>
                </div>
                <label id="advanced_toggle_label">
                    <input type="checkbox" id="settings_advanced_toggle" />
                    <span style="font-weight:500;font-size:14px;">Advanced</span>
                </label>
                <div id="autosave_feedback" class="autosave-feedback">‚úì Settings saved</div>
            </div>

            <!-- Settings Grid Container -->
            <div class="settings-grid agent-settings-stack" data-layout="single">

                <!-- Quick Actions -->
                <div class="panel">
                    <h4 style="margin-top:0;color:var(--highlight)">Quick Actions</h4>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <button class="primary" id="discover_now_settings_btn" style="width:100%;">Discover Now</button>
                        <div style="color:var(--muted);font-size:12px;">
                            Manually trigger a discovery scan with current settings.
                        </div>
                    </div>
                </div>

                <!-- Agent Updates -->
                <div class="panel" id="autoupdate_panel">
                    <h4 style="margin-top:0;color:var(--highlight)">Agent Updates</h4>
                    <div class="autoupdate-status-row">
                        <span id="autoupdate_status_badge" class="autoupdate-status-pill">Loading...</span>
                        <span id="autoupdate_status_copy" class="autoupdate-status-copy">Checking update service...</span>
                    </div>
                    <div id="autoupdate_disabled_notice" class="autoupdate-disabled hidden"></div>
                    <div class="autoupdate-meta">
                        <div>
                            <div class="meta-label">Current Version</div>
                            <div class="meta-value" id="autoupdate_current_version">&mdash;</div>
                        </div>
                        <div>
                            <div class="meta-label">Latest Published</div>
                            <div class="meta-value" id="autoupdate_latest_version">&mdash;</div>
                        </div>
                        <div>
                            <div class="meta-label">Update Channel</div>
                            <div class="meta-value" id="autoupdate_channel">&mdash;</div>
                        </div>
                        <div>
                            <div class="meta-label">Policy Source</div>
                            <div class="meta-value" id="autoupdate_policy">&mdash;</div>
                        </div>
                        <div>
                            <div class="meta-label">Last Check</div>
                            <div class="meta-value" id="autoupdate_last_check">&mdash;</div>
                        </div>
                        <div>
                            <div class="meta-label">Next Check</div>
                            <div class="meta-value" id="autoupdate_next_check">&mdash;</div>
                        </div>
                    </div>
                    <div id="autoupdate_available_callout" class="autoupdate-available hidden"></div>
                    <div class="autoupdate-actions">
                        <button id="autoupdate_refresh_btn" type="button">Refresh Status</button>
                        <button id="autoupdate_check_btn" type="button" class="primary">Check for Update</button>
                        <button id="autoupdate_force_btn" type="button" class="delete">Update Now</button>
                    </div>
                    <div class="autoupdate-hint" id="autoupdate_policy_hint">
                        Manual actions ignore maintenance windows but keep disk space and integrity checks.
                    </div>
                </div>

                <!-- IP Sources -->
                <div class="panel">
                    <h4 style="margin-top:0;color:var(--highlight)">IP Sources</h4>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">What to scan</div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                            <!-- Parent toggle for all IP scanning features -->
                            <div>
                                <label style="display:flex;align-items:center;gap:8px;">
                                    <input type="checkbox" id="ip_scanning_enabled" />
                                    <span><strong>Enable IP scanning</strong></span>
                                    <span style="color:var(--muted);font-size:12px;">(controls subnet/manual ranges and active probes)</span>
                                </label>
                            </div>

                            <div class="ipscan-subtoggle">
                                <label style="display:flex;align-items:center;gap:8px;">
                                    <input type="checkbox" id="scan_local_subnet_enabled" />
                                    <span><strong>Scan detected local subnet</strong></span>
                                </label>
                                <div style="margin-left:24px;margin-top:4px;color:var(--muted);font-size:12px;">
                                    Detected: <span id="detected_subnet_display"
                                        style="font-family:monospace;">(loading...)</span>
                                    <div id="detected_subnet_reason" style="color:var(--muted);font-size:12px;margin-top:6px;display:none;"></div>
                                </div>
                            </div>

                            <div class="ipscan-subtoggle">
                                <label style="display:flex;align-items:center;gap:8px;">
                                    <input type="checkbox" id="manual_ranges_enabled" />
                                    <span>Manual IP ranges</span>
                                    <span style="color:var(--muted);font-size:12px;">(advanced: multi-subnet or
                                        specific
                                        targeting)</span>
                                </label>
                            </div>
                    </div>
                </div>

                <!-- Active Probes -->
                <div class="panel">
                    <h4 style="margin-top:0;color:var(--highlight)">Active Probes</h4>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">How to find devices</div>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="discovery_arp_enabled" />
                            <span>ARP cache</span>
                            <span style="color:var(--muted);font-size:12px;">(instant, no overhead)</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="discovery_icmp_enabled" />
                            <span>ICMP ping</span>
                            <span style="color:var(--muted);font-size:12px;">(reliable liveness check)</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="discovery_tcp_enabled" />
                            <span>TCP ports</span>
                            <span style="color:var(--muted);font-size:12px;">(9100, 80, 443, 515 - works when ICMP
                                blocked)</span>
                        </label>
                        <label class="advanced-setting" style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="discovery_mdns_enabled" />
                            <span>mDNS/DNS-SD</span>
                            <span style="color:var(--muted);font-size:12px;">(5s scan window, optional - covered by
                                live
                                mDNS)</span>
                        </label>

                        <!-- Advanced area for Active Probes - move ranges textarea here -->
                        <details style="margin-top:10px;border:1px solid var(--border);padding:8px;border-radius:6px;" class="ipscan-subtoggle">
                            <summary style="cursor:pointer;color:var(--highlight);font-weight:500;">Advanced Active Probes</summary>
                            <div style="margin-top:8px;color:var(--muted);font-size:12px;margin-bottom:8px;">Advanced probe options and IP ranges (manual ranges)</div>
                            <div style="padding:6px;">
                                <div style="color:var(--muted);font-size:12px;margin-bottom:8px">
                                    Formats: <code>192.168.1.50</code> | <code>192.168.1.0/24</code> |
                                    <code>192.168.1.1-50</code> | <code>192.168.1.x</code>
                                </div>
                                <textarea id="ranges_text" class="advanced-setting-textarea"
                                    style="width:100%;height:100px;font-family:monospace;font-size:12px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;box-sizing:border-box;"
                                    placeholder="One entry per line"></textarea>
                                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                                    <button data-action="clear-ranges" style="font-size:12px;padding:4px 10px;">Clear</button>
                                    <button data-action="save-ranges" style="font-size:12px;padding:4px 10px;">Save ranges</button>
                                    <span style="color:var(--muted);font-size:12px;margin-left:8px;">Ranges moved here from IP Sources</span>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Device Identification -->
                <div class="panel">
                    <h4 style="margin-top:0;color:var(--highlight)">Device Identification</h4>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">What info to collect</div>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="discovery_snmp_enabled" />
                            <span>SNMP queries</span>
                            <span style="color:var(--muted);font-size:12px;">(essential: manufacturer, model,
                                serial,
                                metrics)</span>
                        </label>
                    </div>
                </div>

                <!-- Auto Discovery -->
                <div class="panel">
                    <h4 style="margin-top:0;color:var(--highlight)">Auto Discovery</h4>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">Automatic scanning and saving</div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;font-weight:500;">
                            <input type="checkbox" id="auto_discover_checkbox" />
                            <span>Enable Auto Discover</span>
                            <span style="color:var(--muted);font-size:12px;font-weight:normal;">(periodic scans +
                                continuous listening)</span>
                        </label>
                        <label id="show_discover_button_anyway_container" class="mini-toggle-container">
                            <input type="checkbox" id="show_discover_button_anyway" />
                            <span>Show Discover Button Anyway</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;font-weight:500;">
                            <input type="checkbox" id="autosave_checkbox" />
                            <span>Autosave Discovered Devices</span>
                            <span style="color:var(--muted);font-size:12px;font-weight:normal;">(automatically save
                                new
                                devices as found)</span>
                        </label>
                        <label id="show_discovered_devices_anyway_container" class="mini-toggle-container">
                            <input type="checkbox" id="show_discovered_devices_anyway" />
                            <span>Show Discovered Devices Anyway</span>
                        </label>
                    </div>
                </div>

                <!-- Passive Discovery Methods -->
                <div class="panel">
                    <h4 style="margin-top:0;color:var(--highlight)">Passive Discovery Methods</h4>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">Listen for device announcements</div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;font-weight:500;">
                            <input type="checkbox" id="passive_discovery_enabled" />
                            <span>Enable Passive Discovery</span>
                            <span style="color:var(--muted);font-size:12px;font-weight:normal;">(continuous listening)</span>
                        </label>
                    </div>
                    <div id="passive_discovery_methods_container"
                        style="display:none;margin-top:8px;">
                        <div style="margin-bottom:8px;color:var(--muted);font-size:12px;">
                            When enabled, these methods listen for device announcements continuously (no active
                            scanning
                            overhead).
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <label class="mini-toggle-container" style="display:flex;">
                                <input type="checkbox" id="discovery_live_wsd_enabled" />
                                <span>WS-Discovery <span style="color:var(--muted);font-weight:normal;">(recommended:
                                        Windows native,
                                        HP/Canon/Epson)</span></span>
                            </label>
                            <label class="mini-toggle-container" style="display:flex;">
                                <input type="checkbox" id="discovery_live_mdns_enabled" />
                                <span>mDNS/DNS-SD <span style="color:var(--muted);font-weight:normal;">(recommended:
                                        macOS/Linux, modern printers)</span></span>
                            </label>
                            <label class="mini-toggle-container advanced-setting" style="display:flex;">
                                <input type="checkbox" id="discovery_live_ssdp_enabled" />
                                <span>SSDP/UPnP <span style="color:var(--muted);font-weight:normal;">(optional:
                                        broad discovery, lower printer coverage)</span></span>
                            </label>
                            <label class="mini-toggle-container advanced-setting" style="display:flex;">
                                <input type="checkbox" id="discovery_live_snmptrap_enabled" />
                                <span>SNMP Traps <span style="color:var(--muted);font-weight:normal;">(advanced:
                                        requires admin/root, port 162)</span></span>
                            </label>
                            <label class="mini-toggle-container advanced-setting" style="display:flex;">
                                <input type="checkbox" id="discovery_live_llmnr_enabled" />
                                <span>LLMNR <span style="color:var(--muted);font-weight:normal;">(optional: Windows
                                        hostname resolution, port 5355)</span></span>
                            </label>
                        </div>
                    </div>
                </div>

            <!-- Metrics Monitoring -->
            <div class="panel">
                <h4 style="margin-top:0;color:var(--highlight)">Metrics Monitoring</h4>
                <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">
                    Periodically collect metrics (page counts, toner levels) from saved devices for historical
                    tracking.
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="metrics_rescan_enabled" />
                        <span>Enable Metrics Monitoring</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin-left:20px;">
                        <span style="min-width:120px;">Rescan Interval:</span>
                        <input type="number" id="metrics_rescan_interval" min="5" max="1440" step="5" value="60"
                            style="width:80px;" />
                        <span style="color:var(--muted);font-size:12px;">minutes (5-1440)</span>
                    </label>
                </div>
            </div>

            <!-- SNMP Settings -->
            <div class="panel advanced-setting">
                <h4 style="margin-top:0;color:var(--highlight)">SNMP Settings</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Configure default SNMP parameters for device discovery and monitoring.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Default Community String:</span>
                        <input id="dev_snmp_community" type="text" style="width:220px" placeholder="public" />
                        <span style="color:var(--muted);font-size:12px;">SNMP v1/v2c community (read-only
                            access)</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Timeout (milliseconds):</span>
                        <input id="dev_snmp_timeout" type="number" style="width:120px" min="500" max="10000"
                            step="100" />
                        <span style="color:var(--muted);font-size:12px;">500-10000ms, affects network wait
                            time</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Retry Attempts:</span>
                        <input id="dev_snmp_retries" type="number" style="width:120px" min="0" max="5" step="1" />
                        <span style="color:var(--muted);font-size:12px;">0-5, how many times to retry failed
                            queries</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="dev_epson_remote_mode" />
                        <span>Enable Epson Remote Mode</span>
                        <span style="color:var(--muted);font-size:12px;">Experimental Epson-only SNMP commands for richer metrics.</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="snmp_walk_enabled" />
                        <span>Enable full SNMP walks for unknown devices</span>
                        <span style="color:var(--muted);font-size:12px;">Automatically walk MIB tree to gather all
                            available
                            data</span>
                    </label>
                </div>
            </div>

            <!-- Logging Settings -->
            <div class="panel">
                <h4 style="margin-top:0;color:var(--highlight)">Logging Settings</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Control logging levels and debug output.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Log Level:</span>
                        <select id="dev_debug_logging" style="width:180px;">
                            <option value="error">ERROR - Only errors</option>
                            <option value="warn">WARN - Warnings and errors</option>
                            <option value="info" selected>INFO - Normal operations</option>
                            <option value="debug">DEBUG - Detailed debugging</option>
                            <option value="trace">TRACE - Very verbose (use with tags)</option>
                        </select>
                        <span style="color:var(--muted);font-size:12px;">Set minimum log level to display</span>
                    </label>
                    <label class="advanced-setting" style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="dev_dump_parse_debug" />
                        <span>Persist parse debug for every scan</span>
                        <span style="color:var(--muted);font-size:12px;">Saves detailed JSON to logs/
                            directory</span>
                    </label>
                    <div class="advanced-setting"
                        style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <span style="font-weight:500;color:var(--highlight)">Trace Logging (Granular)</span>
                            <button style="padding:2px 8px;font-size:12px">Refresh</button>
                        </div>
                        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">
                            Enable specific trace categories to get detailed logs without noise. Changes persist
                            across
                            restarts.
                        </div>
                        <div id="trace_tags_container">
                            <span style="color:var(--muted);font-size:12px">Loading...</span>
                        </div>
                        <button style="margin-top:8px">Save Trace Tags</button>
                    </div>

                </div>
            </div>

            <!-- Performance Settings -->
            <div class="panel advanced-setting" style="margin-bottom:16px;">
                <h4 style="margin-top:0;color:var(--highlight)">Performance Settings</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Adjust performance parameters for discovery and scanning operations.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Discovery Concurrency:</span>
                        <input id="dev_discover_concurrency" type="number" style="width:120px" min="1" max="500"
                            step="10" />
                        <span style="color:var(--muted);font-size:12px;">Parallel device probes (1-500)</span>
                    </label>
                </div>
            </div>

            <!-- Integration Settings -->
            <div class="panel advanced-setting" style="margin-bottom:16px;">
                <h4 style="margin-top:0;color:var(--highlight)">Integration Settings</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Configure integration with external systems and asset management.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Asset ID Regex Pattern:</span>
                        <input id="dev_asset_id_regex" type="text" style="width:320px"
                            placeholder="e.g. \\\b\\\d{5}\\\b" />
                    </label>
                    <div style="color:var(--muted);font-size:12px;margin-left:208px;margin-top:-6px;">
                        Regular expression to extract asset IDs from device names or locations.
                    </div>
                </div>
            </div>

            <!-- Network Settings -->
            <div class="panel advanced-setting" style="margin-bottom:16px;">
                <h4 style="margin-top:0;color:var(--highlight)">Network Settings</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Configure network interfaces and proxy behavior.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="enable_http" checked />
                        <span>Enable HTTP</span>
                        <span style="color:var(--muted);font-size:12px;">Serve web UI over HTTP</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">HTTP port:</span>
                        <input id="http_port" type="text" style="width:120px" placeholder="8080" value="8080" />
                        <span style="color:var(--muted);font-size:12px;">Port for HTTP server</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="enable_https" checked />
                        <span>Enable HTTPS/TLS</span>
                        <span style="color:var(--muted);font-size:12px;">Serve web UI over encrypted connection (uses auto-generated self-signed certificate)</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">HTTPS port:</span>
                        <input id="https_port" type="text" style="width:120px" placeholder="8443" value="8443" />
                        <span style="color:var(--muted);font-size:12px;">Port for HTTPS server</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="redirect_http_to_https" />
                        <span>Auto-upgrade HTTP to HTTPS</span>
                        <span style="color:var(--muted);font-size:12px;">Redirect HTTP requests to HTTPS (temporary redirect, can be toggled off)</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="proxy_verify_ssl" />
                        <span>Verify SSL certificates when proxying to devices</span>
                        <span style="color:var(--muted);font-size:12px;">Strict SSL validation for device connections (currently allows self-signed)</span>
                    </label>
                    <div style="margin-top:8px;padding:8px;background:var(--bg-subtle);border-radius:4px;font-size:12px;color:var(--muted);">
                        <strong>Certificate Info:</strong> Self-signed certificates are auto-generated on first run and stored in 
                        <code style="background:var(--bg);padding:2px 4px;border-radius:2px;">%LOCALAPPDATA%\PrintMaster\</code>
                        <button id="regenerate_certs_btn" style="margin-left:12px;padding:4px 8px;font-size:11px;cursor:pointer;background:var(--highlight);color:white;border:none;border-radius:3px;">
                            Regenerate Certificates
                        </button>
                    </div>

                    <details style="margin-top:8px;border:1px solid var(--border);padding:8px;border-radius:4px;">
                        <summary style="cursor:pointer;color:var(--highlight);font-weight:500;">Custom Certificate</summary>
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span style="min-width:200px;">Custom certificate path:</span>
                                <input id="custom_cert_path" type="text" style="width:320px" placeholder="Leave empty to use auto-generated" />
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span style="min-width:200px;">Custom key path:</span>
                                <input id="custom_key_path" type="text" style="width:320px" placeholder="Leave empty to use auto-generated" />
                            </label>
                            <div style="color:var(--muted);font-size:12px;">
                                Provide absolute paths to your own certificate and key files. Leave empty to use auto-generated self-signed certificates.
                            </div>
                        </div>
                    </details>

                    <details style="margin-top:8px;border:1px solid var(--border);padding:8px;border-radius:4px;">
                        <summary style="cursor:pointer;color:var(--highlight);font-weight:500;">Advanced Network
                            Settings
                        </summary>
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <input type="checkbox" id="enable_ipv6" checked />
                                <span>Enable IPv6 support</span>
                                <span style="color:var(--muted);font-size:12px;">Discover and connect to devices via IPv6</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;">
                                <input type="checkbox" id="bind_all_interfaces" />
                                <span>Bind to all network interfaces (0.0.0.0)</span>
                                <span style="color:var(--muted);font-size:12px;">‚ö†Ô∏è Allow external connections (security risk)</span>
                            </label>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="panel advanced-setting" style="margin-bottom:16px;">
                <h4 style="margin-top:0;color:var(--highlight)">Security Settings</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Configure security and authentication options.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="enable_saved_credentials" checked />
                        <span>Enable saved credentials</span>
                        <span style="color:var(--muted);font-size:12px;">Allow saving/using web UI credentials for proxy auto-login</span>
                    </label>
                </div>
            </div>

            <!-- Data Management Settings -->
            <div class="panel advanced-setting" style="margin-bottom:16px;">
                <h4 style="margin-top:0;color:var(--highlight)">Data Management</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Configure data retention and database operations.
                    </div>

                    <!-- Database Info -->
                    <div
                        style="border:1px solid var(--border);padding:12px;border-radius:4px;background:rgba(0,75,86,0.1);">
                        <div style="color:var(--highlight);margin-bottom:8px;font-weight:bold;">Database</div>
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span style="min-width:188px;">Database file:</span>
                                <input id="sqlite_db_path" type="text" style="width:320px;" value="printmaster.db"
                                    readonly />
                                <span style="color:var(--muted);font-size:12px;">Local SQLite database</span>
                            </label>
                        </div>
                    </div>

                    <label style="display:flex;align-items:center;gap:8px;">
                        <span style="min-width:200px;">Metrics history retention:</span>
                        <input id="metrics_retention_days" type="number" style="width:120px" min="7" max="1825"
                            value="365" />
                        <span style="color:var(--muted);font-size:12px;">Keep metrics for N days (7-1825)</span>
                    </label>

                    <details style="margin-top:8px;border:1px solid var(--border);padding:8px;border-radius:4px;">
                        <summary style="cursor:pointer;color:var(--highlight);font-weight:500;">Dangerous Operations</summary>
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
                            <!-- Clear Database -->
                            <div id="clear_db_section">
                                <div style="color:var(--highlight);margin-bottom:8px;font-weight:bold;">‚ö†Ô∏è Clear Database</div>
                                <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">
                                    Backs up the current SQLite database and starts fresh. All devices, metrics, and history 
                                    will be saved to a backup file (printmaster.db.backup_TIMESTAMP).
                                </div>
                                <button id="clear_database_btn" class="delete" style="padding:8px 16px;">
                                    üóëÔ∏è Clear Database (Backup & Reset)
                                </button>
                            </div>
                        </div>
                    </details>
                </div>
            </div> <!-- UI Preferences -->
            <div class="panel">
                <h4 style="margin-top:0;color:var(--highlight)">UI Preferences</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">
                        Customize the web interface appearance and behavior.
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="dev_show_legacy" />
                        <span>Show legacy main-page components</span>
                        <span style="color:var(--muted);font-size:12px;">For backward compatibility</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="show_advanced_settings" checked />
                        <span>Show advanced settings</span>
                        <span style="color:var(--muted);font-size:12px;">Display additional configuration options</span>
                    </label>
                </div>
            </div>
        </div> <!-- End settings-grid -->
    </div>

    <div class="hidden" style="margin-top:12px;" data-tab="logs">
        <h3>Scan Log</h3>
        <div class="log-controls">
            <div class="log-view-toggle">
                <button class="log-view-btn active" data-log-view-mode="table" title="Table View">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v1h14V2a1 1 0 0 0-1-1H2zM1 5v.5h6V5H1zm7 0v.5h7V5H8zM1 7v.5h6V7H1zm7 0v.5h7V7H8zM1 9v.5h6V9H1zm7 0v.5h7V9H8zM1 11v.5h6V11H1zm7 0v.5h7V11H8z"/>
                    </svg>
                </button>
                <button class="log-view-btn" data-log-view-mode="raw" title="Raw View">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
                    </svg>
                </button>
            </div>
            <label class="log-control"><input type="checkbox" id="pause_autoscroll" /> Pause auto-scroll</label>
            <select id="log_level_filter">
                <option value="">All Levels</option>
                <option value="ERROR">ERROR</option>
                <option value="WARN">WARN</option>
                <option value="INFO">INFO</option>
                <option value="DEBUG">DEBUG</option>
                <option value="TRACE">TRACE</option>
            </select>
            <input type="text" id="log_search_filter" placeholder="Search logs..." />
            <button id="copy_logs_btn">Copy Logs</button>
            <button id="download_logs_btn">Download Log Package</button>
            <button id="clear_log_btn">Clear Log</button>
        </div>
        <div id="log_table_container" class="log-table-container">
            <table class="log-table" id="log_table">
                <thead>
                    <tr>
                        <th class="log-col-time">Time</th>
                        <th class="log-col-level">Level</th>
                        <th class="log-col-message">Message</th>
                        <th class="log-col-context">Context</th>
                    </tr>
                </thead>
                <tbody id="log_table_body"></tbody>
            </table>
        </div>
        <pre id="log" class="hidden"></pre>
    </div>

    <!-- Candidate modal removed -->

    <!-- Toast notification container -->
    <div class="toast-container" id="toast_container"></div>

    <script src="static/app.js"></script>

    </div> <!-- End content-container -->

    <!-- Confirmation Modal - positioned outside content-container for proper viewport centering -->
    <div id="confirm_modal" class="modal-overlay" style="display:none;">
        <div class="modal-dialog">
            <button class="modal-close-x" id="confirm_modal_close_x" title="Close">&times;</button>
            <h3 id="confirm_modal_title" class="modal-title">Confirm Action</h3>
            <p id="confirm_modal_message" class="modal-message"></p>
            <div class="modal-buttons">
                <button id="confirm_modal_cancel" class="modal-button modal-button-secondary">Cancel</button>
                <button id="confirm_modal_confirm" class="modal-button modal-button-primary">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Device Authorization Modal -->
    <div id="device_auth_modal" class="modal-overlay" style="display:none;">
        <div class="device-auth-dialog">
            <button class="modal-close-x" id="device_auth_close_x" title="Close">&times;</button>
            <h3 style="margin-top:0;color:var(--highlight)">Login-Based Server Onboarding</h3>
            <p class="device-auth-subtitle">Start approval on another device and an administrator can approve this agent without sharing join tokens.</p>

            <div class="device-auth-field">
                <label for="device_auth_server_url">Server URL</label>
                <input id="device_auth_server_url" type="text" placeholder="https://printmaster.example:9443" />
            </div>

            <div class="device-auth-field-grid">
                <div class="device-auth-field">
                    <label for="device_auth_agent_name">Display name (optional)</label>
                    <input id="device_auth_agent_name" type="text" placeholder="Front Desk Agent" />
                </div>
                <div class="device-auth-field">
                    <label for="device_auth_ca_path">Custom CA path (optional)</label>
                    <input id="device_auth_ca_path" type="text" placeholder="C:\\path\\to\\ca.pem" />
                </div>
            </div>

            <label class="device-auth-checkbox">
                <input type="checkbox" id="device_auth_insecure" />
                <span>Allow insecure TLS / skip certificate verification (not recommended)</span>
            </label>

            <div class="device-auth-actions">
                <button id="device_auth_start_btn" class="modal-button modal-button-primary">Start approval</button>
                <button id="device_auth_restart_btn" class="modal-button modal-button-secondary" disabled>Reset</button>
            </div>

            <div id="device_auth_pending" class="device-auth-pending hidden">
                <div class="device-auth-status">
                    <span id="device_auth_status_badge" class="device-auth-badge device-auth-status-pending">Pending</span>
                    <span id="device_auth_status_text">Waiting for approval‚Ä¶</span>
                </div>
                <div class="device-auth-code" id="device_auth_code">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                <div class="device-auth-meta">
                    <a id="device_auth_authorize_link" href="#" target="_blank" rel="noopener" class="device-auth-link disabled">Open approval page</a>
                    <span>Expires: <strong id="device_auth_expires">‚Äî</strong></span>
                </div>
                <p class="device-auth-hint">Share this code with an administrator or open the link on another device to approve the agent.</p>
            </div>

            <div id="device_auth_message" class="device-auth-message"></div>

            <div class="device-auth-footer">
                <button id="device_auth_code_btn" class="modal-button modal-button-secondary">Enter join code</button>
                <button id="device_auth_cancel_btn" class="modal-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Server Connection Modal -->
    <div id="server_info_modal" class="modal-overlay" style="display:none;">
        <div class="server-info-dialog">
            <button class="modal-close-x" id="server_info_close_x" title="Close">&times;</button>
            <h3 style="margin-top:0;color:var(--highlight)">Server Connection</h3>
            <div id="server_info_status" class="server-status-chip">Not connected</div>
            <div class="server-info-grid">
                <div class="server-info-field">
                    <span class="label">Server URL</span>
                    <code id="server_info_url">Not configured</code>
                </div>
                <div class="server-info-field">
                    <span class="label">Agent ID</span>
                    <code id="server_info_agent_id">Not generated</code>
                </div>
                <div class="server-info-field">
                    <span class="label">Agent Name</span>
                    <span id="server_info_name">Using system hostname</span>
                </div>
                <div class="server-info-field">
                    <span class="label">TLS Mode</span>
                    <span id="server_info_insecure">TLS verification enforced</span>
                </div>
                <div class="server-info-field">
                    <span class="label">CA Path</span>
                    <code id="server_info_ca_path">Not configured</code>
                </div>
                <div class="server-info-field">
                    <span class="label">Intervals</span>
                    <span id="server_info_intervals">Heartbeat: default ‚Ä¢ Upload: default</span>
                </div>
                <div class="server-info-field">
                    <span class="label">Last Heartbeat</span>
                    <span id="server_info_last_heartbeat">Never</span>
                </div>
                <div class="server-info-field">
                    <span class="label">Last Upload</span>
                    <span id="server_info_last_upload">Never</span>
                </div>
                <div class="server-info-field">
                    <span class="label">Last Metrics Upload</span>
                    <span id="server_info_last_metrics">Never</span>
                </div>
                <div class="server-info-field">
                    <span class="label">Agent Token Stored</span>
                    <span id="server_info_agent_token">No</span>
                </div>
                <div class="server-info-field">
                    <span class="label">Join Token Stored</span>
                    <span id="server_info_join_token">No</span>
                </div>
            </div>
            <div class="server-modal-actions">
                <button id="server_info_rejoin_btn" class="modal-button modal-button-secondary">Rejoin with new token</button>
                <button id="server_info_unjoin_btn" class="modal-button modal-button-danger">Disconnect from Server</button>
                <button id="server_info_close_btn" class="modal-button">Close</button>
            </div>
        </div>
    </div>

    <!-- WebUI Modal - positioned outside content-container for proper viewport centering -->
    <div id="webui_modal" class="webui-modal">
        <div class="webui-modal-content">
            <button class="modal-close-x" id="webui_modal_close_x" title="Close">&times;</button>
            <h3 class="webui-modal-title">Open Web Interface</h3>
            <div class="webui-modal-buttons">
                <button id="webui_proxy_btn" class="webui-modal-button">
                    <div class="webui-modal-button-title">üîê Proxy UI</div>
                    <div class="webui-modal-button-desc">Access through PrintMaster proxy (recommended)</div>
                </button>
                <button id="webui_direct_btn" class="webui-modal-button">
                    <div class="webui-modal-button-title">üåê Direct UI</div>
                    <div class="webui-modal-button-desc">Open printer's web interface directly</div>
                </button>
            </div>
            <button class="webui-modal-close">Cancel</button>
        </div>
    </div>

    <!-- Printer Details modal with overlay - positioned outside content-container for proper viewport centering -->
    <div id="printer_details_overlay" class="modal-overlay" style="display:none;">
        <div id="printer_details_modal" class="printer-details-dialog">
            <button class="modal-close-x" id="printer_details_close_x" title="Close">&times;</button>
            <h3 id="printer_details_title" style="margin-top:0;color:var(--highlight)">Printer Details</h3>
            <div id="printer_details_body"
                style="overflow-x:hidden;overflow-y:auto;font-family:system-ui;color:var(--text);word-wrap:break-word;flex:1">
            </div>
            <div id="printer_details_actions" style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px;flex-shrink:0">
                <button>Close</button>
            </div>
        </div>
    </div>

</body>

</html>