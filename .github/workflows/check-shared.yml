name: Check shared namespace

on:
  push:
  pull_request:

jobs:
  check-shared:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if guarded showToast/showConfirm/showAlert patterns remain
        run: |
          set -e
          echo "Searching for legacy guard patterns..."
          # Patterns we consider forbidden in JS files
          patterns=(
            "window.__pm_shared && typeof window.__pm_shared.showToast"
            "window.__pm_shared && typeof window.__pm_shared.showConfirm"
            "window.__pm_shared && typeof window.__pm_shared.showAlert"
            "window.__pm_shared && typeof window.__pm_shared.showPrompt"
          )

          found=0
          for p in "${patterns[@]}"; do
            if grep -R --line-number -n --exclude-dir=node_modules -e "$p" .; then
              echo "\nERROR: Found guarded usage pattern: $p"
              found=1
            fi
          done

          if [ "$found" -eq 1 ]; then
            echo "\nRemove legacy guard scaffolding and call window.__pm_shared.* directly (wrap in try/catch only if necessary)."
            exit 1
          fi

      - name: Verify bootstrap snippet present in index.html files
        run: |
          set -e
          echo "Checking agent/web/index.html and server/web/index.html for bootstrap snippet..."
          missing=0
          for f in agent/web/index.html server/web/index.html; do
            if [ -f "$f" ]; then
              if ! grep -q "window.__pm_shared = window.__pm_shared || {}" "$f"; then
                echo "ERROR: $f does not contain the synchronous bootstrap snippet 'window.__pm_shared = window.__pm_shared || {}'."
                missing=1
              fi
              # Also ensure shared.js appears before app.js
              shared_line=$(grep -n "shared.js" -n "$f" || true)
              app_line=$(grep -n "app.js" -n "$f" || true)
              if [ -n "$shared_line" ] && [ -n "$app_line" ]; then
                shared_num=$(echo "$shared_line" | head -n1 | cut -d: -f1)
                app_num=$(echo "$app_line" | head -n1 | cut -d: -f1)
                if [ "$shared_num" -ge "$app_num" ]; then
                  echo "ERROR: In $f the shared script does not appear before the app script. Ensure shared.js is included first."
                  missing=1
                fi
              fi
            else
              echo "Note: $f not present in repo â€” skipping"
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "One or more index.html checks failed. Add the bootstrap snippet and ensure script order."
            exit 1
          fi

      - name: Success
        run: echo "shared namespace checks passed"
