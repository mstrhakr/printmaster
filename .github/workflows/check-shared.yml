name: Check shared namespace

on:
  push:
  pull_request:

jobs:
  check-shared:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if guarded showToast/showConfirm/showAlert patterns remain
        run: |
          set -e
          echo "Searching for legacy guard patterns..."
          # Patterns we consider forbidden in JS files (legacy guard scaffolding)
          patterns=(
            "window.__pm_shared && typeof window.__pm_shared.showToast"
            "window.__pm_shared && typeof window.__pm_shared.showConfirm"
            "window.__pm_shared && typeof window.__pm_shared.showAlert"
            "window.__pm_shared && typeof window.__pm_shared.showPrompt"
            "window.__pm_shared_cards && typeof window.__pm_shared_cards.renderSavedCard"
            "window.__pm_shared_metrics && typeof window.__pm_shared_metrics.loadDeviceMetrics"
          )

          found=0
          for p in "${patterns[@]}"; do
            # Use plain grep for literal substrings to avoid unintended regexp pitfalls
            # Exclude node_modules and the .github directory (workflow files) from the search
            if grep -R --line-number --exclude-dir=node_modules --exclude-dir=.github -e "$p" .; then
              echo "\nERROR: Found guarded usage pattern: $p"
              found=1
            fi
          done

          if [ "$found" -eq 1 ]; then
            echo "\nRemove legacy guard scaffolding and call window.__pm_shared.* / window.__pm_shared_cards.* / window.__pm_shared_metrics.* directly (wrap in try/catch only if necessary)."
            exit 1
          fi

      - name: Verify bootstrap snippet present in index.html files
        run: |
          set -e
          echo "Checking agent/web/index.html and server/web/index.html for bootstrap snippet..."
          missing=0
          for f in agent/web/index.html server/web/index.html; do
            if [ -f "$f" ]; then
              if ! grep -q "window.__pm_shared = window.__pm_shared || {}" "$f"; then
                echo "ERROR: $f does not contain the synchronous bootstrap snippet 'window.__pm_shared = window.__pm_shared || {}'."
                missing=1
              fi
              # Also ensure shared.js, cards.js and metrics.js appear before app.js
              app_line=$(grep -n "app.js" "$f" || true)
              if [ -z "$app_line" ]; then
                echo "ERROR: app.js not found in $f (expected script that calls shared APIs)."
                missing=1
              else
                app_num=$(echo "$app_line" | head -n1 | cut -d: -f1)

                for script in shared.js cards.js metrics.js; do
                  script_line=$(grep -n "$script" "$f" || true)
                  if [ -z "$script_line" ]; then
                    echo "ERROR: $f does not include required script $script. Include /static/$script before app.js."
                    missing=1
                  else
                    script_num=$(echo "$script_line" | head -n1 | cut -d: -f1)
                    if [ "$script_num" -ge "$app_num" ]; then
                      echo "ERROR: In $f the script $script does not appear before app.js. Ensure /static/$script is included in the head before app.js."
                      missing=1
                    fi
                  fi
                done
              fi
            else
              echo "Note: $f not present in repo â€” skipping"
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "One or more index.html checks failed. Add the bootstrap snippet and ensure script order."
            exit 1
          fi

      - name: Success
        run: echo "shared namespace checks passed"
