name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'agent-v*'     # Agent tags: agent-v0.4.5
      - 'server-v*'    # Server tags: server-v0.3.4
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-agent:
    name: Test Agent
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache: false
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-agent-${{ hashFiles('agent/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-agent-
      continue-on-error: true
    
    - name: Download common dependencies
      working-directory: ./common
      run: go mod download
    
    - name: Download agent dependencies
      working-directory: ./agent
      run: go mod download
    
    - name: Run agent tests
      working-directory: ./agent
      run: go test -v -coverprofile=coverage.out ./...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./agent/coverage.out
        flags: agent
        fail_ci_if_error: false

  test-server:
    name: Test Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache: false
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-server-${{ hashFiles('server/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-server-
      continue-on-error: true
    
    - name: Download common dependencies
      working-directory: ./common
      run: go mod download
    
    - name: Download server dependencies
      working-directory: ./server
      run: go mod download
    
    - name: Run server tests
      working-directory: ./server
      run: go test -v -coverprofile=coverage.out ./...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./server/coverage.out
        flags: server
        fail_ci_if_error: false

  test-e2e:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache: false
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-e2e-${{ hashFiles('tests/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-e2e-
      continue-on-error: true
    
    - name: Download E2E test dependencies
      working-directory: ./tests
      run: go mod download
    
    - name: Run E2E tests
      working-directory: ./tests
      run: go test -v -count=1 ./...
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results
        path: tests/*.log
        if-no-files-found: ignore

  build-binaries:
    name: Build Release Binaries
    needs: [test-agent, test-server, test-e2e]
    if: github.event_name == 'release'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache: false
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-build-${{ hashFiles('agent/go.sum', 'server/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-build-
      continue-on-error: true
    
    - name: Get version
      id: version
      shell: bash
      run: |
        if [ -f agent/VERSION ]; then
          echo "agent_version=$(cat agent/VERSION)" >> $GITHUB_OUTPUT
        fi
        if [ -f server/VERSION ]; then
          echo "server_version=$(cat server/VERSION)" >> $GITHUB_OUTPUT
        fi
        echo "git_commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
    
    - name: Build Agent
      working-directory: ./agent
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        go build -ldflags="-s -w -X 'main.Version=${{ steps.version.outputs.agent_version }}' -X 'main.BuildTime=${{ steps.version.outputs.build_time }}' -X 'main.GitCommit=${{ steps.version.outputs.git_commit }}' -X 'main.BuildType=release'" -o printmaster-agent-v${{ steps.version.outputs.agent_version }}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }} .
    
    - name: Build Server
      working-directory: ./server
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        go build -ldflags="-s -w -X 'main.Version=${{ steps.version.outputs.server_version }}' -X 'main.BuildTime=${{ steps.version.outputs.build_time }}' -X 'main.GitCommit=${{ steps.version.outputs.git_commit }}' -X 'main.BuildType=release'" -o printmaster-server-v${{ steps.version.outputs.server_version }}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }} .
    
    - name: Upload Agent Binary
      uses: actions/upload-artifact@v4
      with:
        name: agent-${{ matrix.goos }}-${{ matrix.goarch }}
        path: agent/printmaster-agent-v${{ steps.version.outputs.agent_version }}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }}
    
    - name: Upload Server Binary
      uses: actions/upload-artifact@v4
      with:
        name: server-${{ matrix.goos }}-${{ matrix.goarch }}
        path: server/printmaster-server-v${{ steps.version.outputs.server_version }}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }}

  build-docker:
    name: Build and Push Docker Images (Multi-Arch)
    needs: [test-agent, test-server, test-e2e]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        variant:
          - dockerfile: Dockerfile
            suffix: ''
            description: 'distroless'
          - dockerfile: Dockerfile.scratch
            suffix: '-scratch'
            description: 'scratch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/amd64,linux/arm64,linux/arm/v7
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: |
          image=moby/buildkit:latest
          network=host
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get version
      id: version
      run: |
        if [ -f server/VERSION ]; then
          echo "version=$(cat server/VERSION)" >> $GITHUB_OUTPUT
        else
          echo "version=dev" >> $GITHUB_OUTPUT
        fi
        echo "git_commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
    
    - name: Extract metadata for ${{ matrix.variant.description }}
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server
        flavor: |
          suffix=${{ matrix.variant.suffix }},onlatest=true
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
          type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ steps.version.outputs.version }},enable=${{ github.event_name == 'release' }}
    
    - name: Build and push Docker image (${{ matrix.variant.description }})
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./server/${{ matrix.variant.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_TIME=${{ steps.version.outputs.build_time }}
          GIT_COMMIT=${{ steps.version.outputs.git_commit }}
        cache-from: type=gha,scope=${{ matrix.variant.description }}
        cache-to: type=gha,mode=max,scope=${{ matrix.variant.description }}
        platforms: linux/amd64,linux/arm64,linux/arm/v7
        provenance: false
        sbom: false

  release:
    name: Attach Release Assets
    needs: [build-binaries, build-docker]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release binaries
      run: |
        cd artifacts
        
        # Extract all binaries from artifact folders
        for dir in */; do
          name="${dir%/}"
          
          # Find the binary file inside
          binary=$(find "$dir" -type f \( -executable -o -name "*.exe" \) | head -n 1)
          
          if [ -z "$binary" ]; then
            echo "Warning: No binary found in $dir"
            continue
          fi
          
          binary_name=$(basename "$binary")
          
          # Copy raw binary to artifacts root
          cp "$binary" "./${binary_name}"
          echo "Prepared: ${binary_name}"
        done
        
        # List all release binaries
        echo ""
        echo "=== Release Binaries ==="
        ls -lh printmaster-* 2>/dev/null || true
    
    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/printmaster-*
        fail_on_unmatched_files: true
