name: CD Agent
run-name: CD Agent - ${{ github.ref_name }} @ ${{ github.sha }}

on:
  push:
    tags:
      - 'agent-v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch: {}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Wait for CI to pass on this commit
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
    - name: Wait for CI checks to pass
      uses: fountainhead/action-wait-for-check@v1.2.0
      id: wait-for-ci
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        checkName: CI Passed
        ref: ${{ github.sha }}
        timeoutSeconds: 900
        intervalSeconds: 15

    - name: Fail if CI did not pass
      if: steps.wait-for-ci.outputs.conclusion != 'success'
      run: |
        echo "CI check 'CI Passed' did not pass (conclusion: ${{ steps.wait-for-ci.outputs.conclusion }})"
        exit 1

  build-agent:
    name: Build Agent Binaries
    needs: [wait-for-ci]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: false
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-agent-${{ matrix.goos }}-${{ matrix.goarch }}-${{ hashFiles('agent/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-agent-
      continue-on-error: true
    
    - name: Get version
      id: version
      shell: bash
      run: |
        echo "agent_version=$(cat agent/VERSION)" >> $GITHUB_OUTPUT
        echo "git_commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
    
    - name: Build Agent
      working-directory: ./agent
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        go build -ldflags="-s -w -X 'main.Version=${{ steps.version.outputs.agent_version }}' -X 'main.BuildTime=${{ steps.version.outputs.build_time }}' -X 'main.GitCommit=${{ steps.version.outputs.git_commit }}' -X 'main.BuildType=release'" -o printmaster-agent-v${{ steps.version.outputs.agent_version }}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }} .

    - name: Build Debian Package (Linux)
      if: matrix.goos == 'linux'
      working-directory: ./agent
      run: |
        # Copy binary to expected location for build script
        cp "printmaster-agent-v${{ steps.version.outputs.agent_version }}-linux-${{ matrix.goarch }}" "printmaster-agent"
        chmod +x build-deb.sh
        ./build-deb.sh "${{ steps.version.outputs.agent_version }}" "${{ matrix.goarch }}"

    - name: Upload Debian Package
      if: matrix.goos == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: agent-deb-${{ matrix.goarch }}
        path: agent/dist/*.deb

    - name: Install WiX Toolset (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $wixUrl = 'https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip'
        $wixRoot = Join-Path $env:RUNNER_TEMP 'wix311'
        if (!(Test-Path $wixRoot)) {
          New-Item -ItemType Directory -Path $wixRoot | Out-Null
        }
        $zipPath = Join-Path $wixRoot 'wix.zip'
        Invoke-WebRequest -Uri $wixUrl -OutFile $zipPath -UseBasicParsing
        Expand-Archive -Path $zipPath -DestinationPath $wixRoot -Force
        Remove-Item $zipPath -Force
        $binPath = Join-Path $wixRoot 'wix311-binaries'
        if (!(Test-Path (Join-Path $binPath 'candle.exe'))) {
          $binPath = $wixRoot
        }
        "$binPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Build Agent MSI
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $agentVersion = '${{ steps.version.outputs.agent_version }}'
        if (-not $agentVersion) { throw 'agent version not detected' }
        $agentExe = Join-Path (Get-Location) "agent\printmaster-agent-v${agentVersion}-windows-amd64.exe"
        if (!(Test-Path $agentExe)) {
          throw "Agent binary not found at $agentExe"
        }
        $distDir = Join-Path (Get-Location) 'agent\dist'
        if (!(Test-Path $distDir)) {
          New-Item -ItemType Directory -Path $distDir | Out-Null
        }
        $wixobj = Join-Path $distDir 'printmaster-agent.wixobj'
        $wxs = 'build\windows\msi\printmaster-agent.wxs'
        $candleArgs = @(
          '-nologo',
          "-dProductVersion=$agentVersion",
          "-dAgentBinaryPath=$agentExe",
          '-out', $wixobj,
          $wxs
        )
        & candle.exe @candleArgs
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        $msiName = "printmaster-agent-v${agentVersion}-windows-amd64.msi"
        $msiPath = Join-Path $distDir $msiName
        $lightArgs = @(
          '-nologo',
          '-out', $msiPath,
          $wixobj
        )
        & light.exe @lightArgs
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
    
    - name: Upload Agent Binary
      uses: actions/upload-artifact@v4
      with:
        name: agent-${{ matrix.goos }}-${{ matrix.goarch }}
        path: agent/printmaster-agent-v${{ steps.version.outputs.agent_version }}-${{ matrix.goos }}-${{ matrix.goarch }}*

    - name: Upload Agent MSI
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: agent-windows-msi
        path: agent/dist/printmaster-agent-v${{ steps.version.outputs.agent_version }}-windows-amd64.msi

  build-docker:
    name: Build Docker Images (Multi-Arch)
    needs: [wait-for-ci]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: |
          image=moby/buildkit:latest
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get version
      id: version
      run: |
        echo "version=$(cat agent/VERSION)" >> $GITHUB_OUTPUT
        echo "git_commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-agent
        tags: |
          type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
          type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
          type=raw,value=latest,enable=true
          type=raw,value=${{ steps.version.outputs.version }}
        labels: |
          org.opencontainers.image.description=PrintMaster Agent container image (build ${{ steps.version.outputs.version }} / commit ${{ steps.version.outputs.git_commit }})
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./agent/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_TIME=${{ steps.version.outputs.build_time }}
          GIT_COMMIT=${{ steps.version.outputs.git_commit }}
        cache-from: type=gha,scope=agent-amd64
        cache-to: type=gha,mode=max,scope=agent-amd64
        platforms: linux/amd64
        provenance: false
        sbom: false

  release-agent:
    name: Create Agent Release
    needs: [build-agent, build-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Get version info
      id: version
      run: |
        echo "version=$(cat agent/VERSION)" >> $GITHUB_OUTPUT
        echo "tag=agent-v$(cat agent/VERSION)" >> $GITHUB_OUTPUT
    
    - name: Prepare release binaries
      run: |
        cd artifacts
        for dir in */; do
          name="${dir%/}"
          binary=$(find "$dir" -maxdepth 1 -type f -name "printmaster-*" | head -n 1)
          if [ -n "$binary" ]; then
            cp "$binary" "./$(basename "$binary")"
            echo "Prepared: $(basename "$binary")"
          fi
        done
        echo "=== Release Binaries ==="
        ls -lh printmaster-* 2>/dev/null || true
    
    - name: Generate changelog
      id: changelog
      run: |
        TAG_NAME="agent-v${{ steps.version.outputs.version }}"
        LAST_TAG=$(git tag -l "agent-v*" --sort=-version:refname | grep -v "^${TAG_NAME}$" | head -n 1)
        
        if [ -z "$LAST_TAG" ]; then
          CHANGELOG="Initial release"
        else
          CHANGELOG=$(git log ${LAST_TAG}..${TAG_NAME} --pretty=format:"- %s (%h)" --no-merges | grep -v "^- chore: Release" || echo "- Bug fixes and improvements")
        fi
        
        {
          echo 'CHANGELOG<<EOF'
          echo "$CHANGELOG"
          echo 'EOF'
        } >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: PrintMaster Agent v${{ steps.version.outputs.version }}
        body: |
          ## PrintMaster Agent v${{ steps.version.outputs.version }}
          
          ### üìù Changes
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ---
          
          ### üì¶ Installation
          
          #### Debian/Ubuntu (.deb)
          ```bash
          # Download and install
          wget https://github.com/mstrhakr/printmaster/releases/download/agent-v${{ steps.version.outputs.version }}/printmaster-agent_${{ steps.version.outputs.version }}_amd64.deb
          sudo dpkg -i printmaster-agent_${{ steps.version.outputs.version }}_amd64.deb
          
          # Start the service
          sudo systemctl start printmaster-agent
          ```
          
          #### Binary Installation
          1. Download the appropriate binary for your platform from the Assets section below
          2. Extract the archive
          3. Run the binary with `--help` to see available options
          
          #### Windows MSI Installer
          Download `printmaster-agent-v${{ steps.version.outputs.version }}-windows-amd64.msi` for easy installation on Windows.
          
          #### Docker Installation
          ```bash
          docker pull ghcr.io/mstrhakr/printmaster-agent:${{ steps.version.outputs.version }}
          docker run -d \
            -p 8000:8000 \
            -v agent-data:/var/lib/printmaster/agent \
            ghcr.io/mstrhakr/printmaster-agent:${{ steps.version.outputs.version }}
          ```
          
          See `docker-compose.yml` in the repository for a complete multi-service example.
          
          **Supported Platforms:**
          - Debian/Ubuntu (amd64, arm64) - .deb package with systemd service
          - Windows (amd64) - EXE and MSI installer
          - Linux (all) - Docker container
          - macOS (amd64, arm64) - Binary
          
          ### ‚è±Ô∏è Build Information
          - **Workflow run:** ${{ github.run_id }}
          - **Commit:** ${{ github.sha }}
          
          ### üîó Links
          - [Documentation](https://github.com/mstrhakr/printmaster/tree/main/docs)
          - [Issue Tracker](https://github.com/mstrhakr/printmaster/issues)
        files: artifacts/printmaster-*
        fail_on_unmatched_files: false
        draft: false
        prerelease: false

  update-apt-repo:
    name: Update APT Repository
    needs: [build-agent]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout gh-pages
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: apt-repo
      continue-on-error: true

    - name: Initialize gh-pages if needed
      run: |
        if [ ! -d "apt-repo/.git" ]; then
          echo "Creating gh-pages branch..."
          mkdir -p apt-repo
          cd apt-repo
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git checkout -b gh-pages
          echo "# PrintMaster APT Repository" > README.md
        fi

    - name: Download deb artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: agent-deb-*
        path: downloads
        merge-multiple: true

    - name: Get version
      id: version
      run: |
        echo "version=$(cat apt-repo/../agent/VERSION 2>/dev/null || echo 'unknown')" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Checkout main for version
      uses: actions/checkout@v4
      with:
        path: main-repo
        sparse-checkout: agent/VERSION

    - name: Get version from main
      id: main_version
      run: |
        echo "version=$(cat main-repo/agent/VERSION)" >> $GITHUB_OUTPUT

    - name: Install APT repo tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev apt-utils gnupg

    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
      run: |
        if [ -n "$GPG_PRIVATE_KEY" ]; then
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "GPG key imported"
        else
          echo "No GPG key configured, skipping import"
        fi

    - name: Setup APT repository structure
      run: |
        cd apt-repo
        
        # Create directory structure
        mkdir -p pool/main
        mkdir -p dists/stable/main/binary-amd64
        mkdir -p dists/stable/main/binary-arm64
        
        # Copy new .deb files to pool
        if ls ../downloads/*.deb 1>/dev/null 2>&1; then
          cp ../downloads/*.deb pool/main/
          echo "Copied packages to pool:"
          ls -la pool/main/
        else
          echo "No .deb packages found in downloads"
          ls -la ../downloads/ || true
        fi

    - name: Generate APT repository metadata
      run: |
        cd apt-repo
        
        # Check if we have any packages
        if ! ls pool/main/*.deb 1>/dev/null 2>&1; then
          echo "No packages in pool, skipping metadata generation"
          exit 0
        fi
        
        # Generate Packages files for each architecture
        for arch in amd64 arm64; do
          echo "Generating Packages for $arch..."
          mkdir -p dists/stable/main/binary-$arch
          
          # Generate Packages file
          (cd pool/main && dpkg-scanpackages --arch $arch . /dev/null) > dists/stable/main/binary-$arch/Packages 2>/dev/null || true
          
          # Compress
          gzip -9c dists/stable/main/binary-$arch/Packages > dists/stable/main/binary-$arch/Packages.gz
          
          echo "Packages for $arch:"
          cat dists/stable/main/binary-$arch/Packages || true
        done

    - name: Generate Release file
      run: |
        cd apt-repo
        
        # Check if we have packages
        if ! ls pool/main/*.deb 1>/dev/null 2>&1; then
          echo "No packages, skipping Release generation"
          exit 0
        fi
        
        cd dists/stable
        
        # Generate Release file
        cat > Release << EOF
        Origin: PrintMaster
        Label: PrintMaster
        Suite: stable
        Codename: stable
        Architectures: amd64 arm64
        Components: main
        Description: PrintMaster Agent APT Repository
        Date: $(date -Ru)
        EOF
        
        # Add checksums
        {
          echo "MD5Sum:"
          find main -type f \( -name "Packages" -o -name "Packages.gz" \) -exec sh -c 'echo " $(md5sum "$1" | cut -d" " -f1) $(stat -c%s "$1") $1"' _ {} \;
          echo "SHA256:"
          find main -type f \( -name "Packages" -o -name "Packages.gz" \) -exec sh -c 'echo " $(sha256sum "$1" | cut -d" " -f1) $(stat -c%s "$1") $1"' _ {} \;
        } >> Release
        
        echo "Release file:"
        cat Release

    - name: Sign Release file
      env:
        GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
      run: |
        if [ -z "$GPG_PRIVATE_KEY" ]; then
          echo "No GPG key configured, skipping signing"
          exit 0
        fi
        
        cd apt-repo/dists/stable
        
        # Sign Release file
        gpg --batch --yes --pinentry-mode loopback \
          --passphrase "$GPG_PASSPHRASE" \
          --armor --detach-sign --output Release.gpg Release
        
        gpg --batch --yes --pinentry-mode loopback \
          --passphrase "$GPG_PASSPHRASE" \
          --armor --clearsign --output InRelease Release
        
        echo "Release signed"

    - name: Create index page
      run: |
        cd apt-repo
        
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>PrintMaster APT Repository</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
            h1 { color: #333; }
            pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
            code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
          </style>
        </head>
        <body>
          <h1>üñ®Ô∏è PrintMaster APT Repository</h1>
          
          <p>Official APT repository for <a href="https://github.com/mstrhakr/printmaster">PrintMaster Agent</a>.</p>
          
          <h2>Quick Install</h2>
          <pre><code># Add repository
        echo "deb [trusted=yes] https://mstrhakr.github.io/printmaster stable main" | sudo tee /etc/apt/sources.list.d/printmaster.list

        # Update and install
        sudo apt-get update
        sudo apt-get install printmaster-agent</code></pre>

          <h2>With GPG Verification (Recommended)</h2>
          <pre><code># Download and add GPG key
        curl -fsSL https://mstrhakr.github.io/printmaster/gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/printmaster.gpg

        # Add repository with signed-by
        echo "deb [signed-by=/usr/share/keyrings/printmaster.gpg] https://mstrhakr.github.io/printmaster stable main" | sudo tee /etc/apt/sources.list.d/printmaster.list

        # Update and install
        sudo apt-get update
        sudo apt-get install printmaster-agent</code></pre>

          <h2>After Installation</h2>
          <pre><code># Start the service
        sudo systemctl start printmaster-agent
        sudo systemctl enable printmaster-agent</code></pre>
          
          <p>Web UI: <code>http://localhost:8000</code></p>
          
          <h2>Links</h2>
          <ul>
            <li><a href="https://github.com/mstrhakr/printmaster">GitHub Repository</a></li>
            <li><a href="https://github.com/mstrhakr/printmaster/releases">Releases</a></li>
          </ul>
        </body>
        </html>
        EOF

    - name: Commit and push changes
      run: |
        cd apt-repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update APT repository - v${{ steps.main_version.outputs.version }}"
          git push origin gh-pages
        fi

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: apt-repo

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
